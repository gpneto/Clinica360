'use client';

import { Fragment, useCallback, useEffect, useMemo, useState } from 'react';
import { Combobox, Transition } from '@headlessui/react';
import { motion, AnimatePresence } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import {
  X, 
  User, 
  FileText, 
  Calendar, 
  Clock, 
  ChevronLeft, 
  ChevronRight,
  Plus,
  Check,
  ChevronsUpDown,
  Save
} from 'lucide-react';
import { useProfessionals, useServices, usePatients, useAppointments, useCompanySettings } from '@/hooks/useFirestore';
import { useAuth } from '@/lib/auth-context';
import { cn, getGradientColors, getGradientStyle } from '@/lib/utils';
import type { Patient } from '@/types';
import { useCustomerLabels } from '@/hooks/useCustomerLabels';

interface MobileAppointmentFormProps {
  isOpen: boolean;
  onClose: () => void;
  selectedDate?: Date;
  selectedProfessional?: string;
  editingAppointment?: any;
}

type FormData = {
  clientId: string;
  serviceId: string;
  professionalId: string;
  date: string;
  time: string;
  endTime: string;
  duration: number;
  notes: string;
  price: number;
  valorPago?: number;
  formaPagamento?: 'dinheiro' | 'cartao_debito' | 'cartao_credito' | 'pix' | 'outros';
  clientePresente?: boolean;
  enviarNotificacao: boolean;
  isBlock: boolean;
  blockDescription: string;
  blockScope: 'single' | 'all';
  recurrenceEnabled: boolean;
  recurrenceFrequency: 'daily' | 'weekly' | 'biweekly' | 'monthly';
  recurrenceEndsOn: string;
  allDay: boolean;
};

export function MobileAppointmentForm({ 
  isOpen, 
  onClose, 
  selectedDate, 
  selectedProfessional,
  editingAppointment 
}: MobileAppointmentFormProps) {
  const { companyId, user, professionalId, role, themePreference, customColor } = useAuth();
  const { settings: companySettings } = useCompanySettings(companyId);
  const confirmacaoAutomatica = companySettings?.confirmacaoAutomatica !== false;
  const { professionals } = useProfessionals(companyId);
  const { services } = useServices(companyId);
  const { patients, createPatient } = usePatients(companyId);
  const {
    createAppointment,
    updateAppointment,
    createRecurringAppointments,
    updateRecurringAppointments
  } = useAppointments(companyId);
  const isVibrant = themePreference === 'vibrant';
  const isCustom = themePreference === 'custom';
  const hasGradient = isVibrant || isCustom;
  const gradientColors = isCustom && customColor ? getGradientColors('custom', customColor) : null;
  const gradientStyleHorizontal = isCustom && customColor ? getGradientStyle('custom', customColor, '90deg') : undefined;
  const gradientStyleDiagonal = isCustom && customColor ? getGradientStyle('custom', customColor, '135deg') : undefined;
  
  const [currentStep, setCurrentStep] = useState(1);
  const [patientQuery, setPatientQuery] = useState('');

  const buildInitialForm = useMemo<FormData>(() => {
    let dateValue = '';
    let timeValue = '';

    const baseProfessionalId =
      selectedProfessional || (role === 'pro' ? professionalId || '' : '');

    if (editingAppointment) {
      dateValue = editingAppointment.inicio.toISOString().split('T')[0];
      const startHours = editingAppointment.inicio.getHours().toString().padStart(2, '0');
      const startMinutes = editingAppointment.inicio.getMinutes().toString().padStart(2, '0');
      timeValue = `${startHours}:${startMinutes}`;
    } else if (selectedDate) {
      dateValue = selectedDate.toISOString().split('T')[0];
      const startHours = selectedDate.getHours().toString().padStart(2, '0');
      const startMinutes = selectedDate.getMinutes().toString().padStart(2, '0');
      timeValue = `${startHours}:${startMinutes}`;
    }

    const isExistingBlock =
      !!editingAppointment &&
      (editingAppointment.isBlock || editingAppointment.status === 'bloqueio');

    const durationMinutes = editingAppointment
      ? Math.max(
          1,
          Math.round(
            (editingAppointment.fim.getTime() - editingAppointment.inicio.getTime()) / (1000 * 60)
          )
        )
      : 60;

    const hasRecurrence =
      !isExistingBlock && !!editingAppointment?.recurrenceGroupId;
    const recurrenceFrequency =
      editingAppointment?.recurrenceFrequency || 'weekly';
    const recurrenceEndsOn =
      hasRecurrence && editingAppointment?.recurrenceEndsAt
        ? editingAppointment.recurrenceEndsAt.toISOString().split('T')[0]
        : '';

    let endValue = '';
    if (editingAppointment) {
      endValue = `${editingAppointment.fim.getHours().toString().padStart(2, '0')}:${editingAppointment.fim
        .getMinutes()
        .toString()
        .padStart(2, '0')}`;
    } else if (timeValue) {
      const [h, m] = timeValue.split(':').map(Number);
      if (!Number.isNaN(h) && !Number.isNaN(m)) {
        const base = new Date();
        base.setHours(h, m, 0, 0);
        base.setMinutes(base.getMinutes() + durationMinutes);
        endValue = `${base.getHours().toString().padStart(2, '0')}:${base.getMinutes().toString().padStart(2, '0')}`;
      }
    }

    const enviarNotificacaoDefault = isExistingBlock
      ? false
      : editingAppointment?.enviarNotificacao !== undefined
        ? Boolean(editingAppointment.enviarNotificacao)
        : confirmacaoAutomatica;

    return {
      clientId: isExistingBlock ? '' : (editingAppointment?.clientId || ''),
      serviceId: isExistingBlock ? '' : (editingAppointment?.serviceId || ''),
      professionalId: isExistingBlock
        ? (editingAppointment?.professionalId || '')
        : baseProfessionalId,
      date: dateValue,
      time: timeValue,
      endTime: endValue,
      notes: editingAppointment?.observacoes || '',
      price: isExistingBlock ? 0 : (editingAppointment?.precoCentavos ?? 0),
      valorPago: editingAppointment?.valorPagoCentavos
        ? editingAppointment.valorPagoCentavos / 100
        : undefined,
      formaPagamento: editingAppointment?.formaPagamento,
      clientePresente: editingAppointment?.clientePresente,
      enviarNotificacao: enviarNotificacaoDefault,
      isBlock: isExistingBlock,
      blockDescription: isExistingBlock
        ? (editingAppointment?.blockDescription || editingAppointment?.observacoes || '')
        : '',
      blockScope: isExistingBlock
        ? editingAppointment?.blockScope || (editingAppointment?.professionalId === '__all__' ? 'all' : 'single')
        : 'single',
      duration: durationMinutes,
      recurrenceEnabled: hasRecurrence,
      recurrenceFrequency,
      allDay: false,
      recurrenceEndsOn,
    };
  }, [editingAppointment, selectedDate, selectedProfessional, role, professionalId, confirmacaoAutomatica]);

  const [formData, setFormData] = useState<FormData>(buildInitialForm);
  useEffect(() => {
    setFormData(buildInitialForm);
  }, [buildInitialForm, isOpen]);
  useEffect(() => {
    if (
      formData.isBlock &&
      formData.blockScope === 'all' &&
      formData.professionalId !== '__all__'
    ) {
      setFormData(prev => ({ ...prev, professionalId: '__all__' }));
    }
    if (
      formData.isBlock &&
      formData.blockScope === 'single' &&
      formData.professionalId === '__all__'
    ) {
      setFormData(prev => ({
        ...prev,
        professionalId: selectedProfessional || professionalId || ''
      }));
    }
  }, [formData.isBlock, formData.blockScope, formData.professionalId, selectedProfessional, professionalId]);
  useEffect(() => {
    if (formData.isBlock && formData.recurrenceEnabled) {
      setFormData(prev => ({
        ...prev,
        recurrenceEnabled: false,
        recurrenceEndsOn: '',
        allDay: prev.allDay,
      }));
    }
  }, [formData.isBlock, formData.recurrenceEnabled]);
  useEffect(() => {
    if (
      !formData.isBlock &&
      formData.recurrenceEnabled &&
      formData.date &&
      formData.recurrenceEndsOn &&
      formData.recurrenceEndsOn < formData.date
    ) {
      setFormData(prev => ({
        ...prev,
        recurrenceEndsOn: prev.date,
      }));
    }
  }, [formData.isBlock, formData.recurrenceEnabled, formData.recurrenceEndsOn, formData.date]);
  const clientId = formData.clientId;
  const selectedPatient = useMemo(
    () => patients.find((patient) => patient.id === clientId) || null,
    [patients, clientId]
  );

  const filteredPatients = useMemo(() => {
    const normalizeString = (value: string) =>
      value
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase();

    const term = patientQuery.trim();
    const normalizedTerm = normalizeString(term);
    if (!normalizedTerm) return patients;
    const result = patients.filter((patient) => {
      const name = patient.nome ? normalizeString(patient.nome) : '';
      const phone = patient.telefoneE164 ? normalizeString(patient.telefoneE164) : '';
      const email = patient.email ? normalizeString(patient.email) : '';
      return (
        name.includes(normalizedTerm) ||
        phone.includes(normalizedTerm) ||
        email.includes(normalizedTerm)
      );
    });
    return result;
  }, [patientQuery, patients]);

  const handlePatientSelect = (patient: Patient | null) => {
    if (patient) {
      setFormData((prev) => ({ ...prev, clientId: patient.id }));
      setPatientQuery('');
    } else {
      setFormData((prev) => ({ ...prev, clientId: '' }));
      setPatientQuery('');
    }
  };

  const formatPhoneNumber = (phone?: string) => {
    if (!phone) return 'Telefone não informado';
    const cleaned = phone.replace(/\D/g, '');
    if (cleaned.length === 11) {
      return cleaned.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    }
    if (cleaned.length === 10) {
      return cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
    }
    return phone;
  };
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showNewPatientModal, setShowNewPatientModal] = useState(false);
  const [newPatientData, setNewPatientData] = useState({
    nome: '',
    telefoneE164: '',
    email: '',
    preferenciaNotificacao: 'whatsapp' as 'whatsapp' | 'sms' | 'email',
    anamnese: ''
  });
  const customerLabels = useCustomerLabels();
  const singularLabel = customerLabels.singular;
  const singularTitle = customerLabels.singularTitle;
  const pluralTitle = customerLabels.pluralTitle;

  // Atualizar professionalId quando role ou professionalId mudarem
  useEffect(() => {
    if (role === 'pro' && professionalId && !selectedProfessional) {
      setFormData(prev => ({ ...prev, professionalId }));
    }
  }, [role, professionalId, selectedProfessional]);

  // Atualizar formData quando editingAppointment mudar
  useEffect(() => {
    if (editingAppointment) {
      const dateValue = editingAppointment.inicio.toISOString().split('T')[0];
      const hours = editingAppointment.inicio.getHours().toString().padStart(2, '0');
      const minutes = editingAppointment.inicio.getMinutes().toString().padStart(2, '0');
      const timeValue = `${hours}:${minutes}`;
      const isBlock = editingAppointment.isBlock || editingAppointment.status === 'bloqueio';
      const blockScope = isBlock
        ? editingAppointment.blockScope || (editingAppointment.professionalId === '__all__' ? 'all' : 'single')
        : 'single';
      const durationMinutes = Math.max(
        1,
        Math.round((editingAppointment.fim.getTime() - editingAppointment.inicio.getTime()) / (1000 * 60))
      );
      const endValue = `${editingAppointment.fim.getHours().toString().padStart(2, '0')}:${editingAppointment.fim
        .getMinutes()
        .toString()
        .padStart(2, '0')}`;
      const hasRecurrence = !isBlock && Boolean(editingAppointment.recurrenceGroupId);
      const recurrenceFrequency = editingAppointment.recurrenceFrequency || 'weekly';
      const recurrenceEndsOn =
        hasRecurrence && editingAppointment.recurrenceEndsAt
          ? editingAppointment.recurrenceEndsAt.toISOString().split('T')[0]
          : '';

      const enviarNotificacaoValue = isBlock
        ? false
        : editingAppointment.enviarNotificacao !== undefined
          ? Boolean(editingAppointment.enviarNotificacao)
          : confirmacaoAutomatica;

      setFormData((prev) => ({
        ...prev,
        clientId: isBlock ? '' : editingAppointment.clientId,
        serviceId: isBlock ? '' : editingAppointment.serviceId,
        professionalId: editingAppointment.professionalId,
        date: dateValue,
        time: timeValue,
        endTime: endValue,
        duration: durationMinutes,
        notes: editingAppointment.observacoes || '',
        price: isBlock ? 0 : editingAppointment.precoCentavos ?? 0,
        valorPago: editingAppointment.valorPagoCentavos ? editingAppointment.valorPagoCentavos / 100 : undefined,
        formaPagamento: editingAppointment.formaPagamento,
        clientePresente: editingAppointment.clientePresente,
        enviarNotificacao: enviarNotificacaoValue,
        isBlock,
        blockDescription: isBlock
          ? editingAppointment.blockDescription || editingAppointment.observacoes || ''
          : '',
        blockScope,
        recurrenceEnabled: hasRecurrence,
        allDay: prev.allDay || false,
        recurrenceFrequency,
        recurrenceEndsOn,
      }));
    }
  }, [editingAppointment, confirmacaoAutomatica]);

  // Atualizar data e hora quando selectedDate mudar (apenas para novos agendamentos)
  useEffect(() => {
    if (!editingAppointment && selectedDate && isOpen) {
      const dateValue = selectedDate.toISOString().split('T')[0];
      const hours = selectedDate.getHours().toString().padStart(2, '0');
      const minutes = selectedDate.getMinutes().toString().padStart(2, '0');
      const timeValue = `${hours}:${minutes}`;

      let endValue = '';
      const [h, m] = timeValue.split(':').map(Number);
      if (!Number.isNaN(h) && !Number.isNaN(m)) {
        const base = new Date();
        base.setHours(h, m, 0, 0);
        base.setMinutes(base.getMinutes() + (formData.duration || 60));
        endValue = `${base.getHours().toString().padStart(2, '0')}:${base.getMinutes().toString().padStart(2, '0')}`;
      }

      setFormData(prev => ({
        ...prev,
        date: dateValue,
        time: timeValue,
        endTime: prev.isBlock ? (prev.endTime || endValue) : endValue,
        professionalId: prev.professionalId || selectedProfessional || (role === 'pro' ? professionalId || '' : '')
      }));
    }
  }, [selectedDate, editingAppointment, isOpen, formData.duration, formData.isBlock, selectedProfessional, role, professionalId]);

  const steps = useMemo(() => {
    const base = [
      { id: 1, title: formData.isBlock ? 'Tipo' : singularTitle, icon: formData.isBlock ? Clock : User },
      { id: 2, title: formData.isBlock ? 'Escopo' : 'Serviço', icon: formData.isBlock ? User : FileText },
      { id: 3, title: 'Profissional', icon: User },
      { id: 4, title: 'Data/Hora', icon: Calendar },
      { id: 5, title: 'Detalhes', icon: Clock },
    ];

    if (!formData.isBlock && editingAppointment?.status === 'concluido') {
      base.push({ id: 6, title: 'Pagamento', icon: Check });
    }

    return base;
  }, [formData.isBlock, editingAppointment?.status, singularTitle]);

  useEffect(() => {
    const maxStep = steps.length;
    if (currentStep > maxStep) {
      setCurrentStep(maxStep);
    }
  }, [steps, currentStep, setCurrentStep]);

  const canProceed = useCallback(() => {
    if (formData.isBlock) {
      switch (currentStep) {
        case 1:
        case 2:
          return true;
        case 3:
          return formData.blockScope === 'all' ? true : Boolean(formData.professionalId);
        case 4:
          return Boolean(formData.date && formData.time && formData.endTime);
        case 5:
          return (formData.blockDescription ?? '').trim().length > 0;
        default:
          return true;
      }
    }

    switch (currentStep) {
      case 1:
        return Boolean(formData.clientId);
      case 2:
        return Boolean(formData.serviceId);
      case 3:
        return Boolean(formData.professionalId);
      case 4:
        return Boolean(
          formData.date &&
            formData.time &&
            (!formData.recurrenceEnabled || formData.recurrenceEndsOn)
        );
      case 5:
        return true;
      case 6:
        return editingAppointment?.status === 'concluido';
      default:
        return false;
    }
  }, [
    currentStep,
    formData.blockDescription,
    formData.blockScope,
    formData.date,
    formData.endTime,
    formData.isBlock,
    formData.professionalId,
    formData.serviceId,
    formData.clientId,
    formData.time,
    formData.recurrenceEnabled,
    formData.recurrenceEndsOn,
    editingAppointment?.status,
  ]);

  const nextStep = () => {
    const maxStep = steps.length;
    if (currentStep < maxStep && canProceed()) {
      setCurrentStep(currentStep + 1);
    }
  };

  const prevStep = () => {
    if (currentStep > 1) {
      setCurrentStep(currentStep - 1);
    }
  };

  const handleSubmit = async () => {
    if (!companyId) {
      alert('Erro: companyId não encontrado.');
      return;
    }

    if (!canProceed()) {
      alert('Preencha as informações necessárias antes de continuar.');
      return;
    }

    setIsSubmitting(true);
    try {
      if (!formData.date || !formData.time) {
        throw new Error('Data ou hora inválida');
      }

      const startDate = new Date(`${formData.date}T${formData.time}`);
      if (Number.isNaN(startDate.getTime())) {
        throw new Error('Data ou hora inválida');
      }

      const blockDescription = (formData.blockDescription ?? '').trim();
      let endDate = new Date(startDate);

      const selectedService = formData.isBlock
        ? null
        : services.find((s) => s.id === formData.serviceId);
      const selectedPatient = formData.isBlock
        ? null
        : patients.find((c) => c.id === formData.clientId);

      if (formData.isBlock) {
        if (!formData.endTime) {
          throw new Error('Selecione o horário de término do bloqueio');
        }
        endDate = new Date(`${formData.date}T${formData.endTime}`);
        if (Number.isNaN(endDate.getTime()) || endDate <= startDate) {
          endDate = new Date(startDate.getTime() + 60 * 60000);
        }
      } else {
        if (!selectedService || !selectedPatient) {
      throw new Error(`Selecione ${singularLabel} e serviço válidos.`);
        }

        const durationMinutes =
          formData.duration || selectedService.duracaoMin || 60;
        endDate = new Date(startDate.getTime() + durationMinutes * 60000);
      }

      const recurrenceEnabled =
        !formData.isBlock && formData.recurrenceEnabled;
      let recurrenceEndDate: Date | null = null;

      if (recurrenceEnabled) {
        if (!formData.recurrenceEndsOn) {
          throw new Error('Informe a data final da recorrência.');
        }
        const recurrenceCandidate = new Date(
          `${formData.recurrenceEndsOn}T23:59:59`
        );
        if (Number.isNaN(recurrenceCandidate.getTime())) {
          throw new Error('Data final da recorrência inválida.');
        }
        if (recurrenceCandidate < startDate) {
          throw new Error(
            'A data final da recorrência deve ser posterior à data inicial.'
          );
        }
        const maxEndDate = new Date(startDate);
        maxEndDate.setFullYear(maxEndDate.getFullYear() + 1);
        if (recurrenceCandidate > maxEndDate) {
          throw new Error(
            'A data final da recorrência deve ser no máximo 1 ano após o início.'
          );
        }
        recurrenceEndDate = recurrenceCandidate;
      }

      const professionalTargetId =
        formData.isBlock && formData.blockScope === 'all'
          ? '__all__'
          : formData.professionalId;

      if (!professionalTargetId) {
        throw new Error('Selecione o profissional responsável.');
      }

      const status = formData.isBlock ? 'bloqueio' : 'agendado';
      const shouldNotify =
        !formData.isBlock && formData.enviarNotificacao !== false;

      const basePayload: any = {
        companyId,
        professionalId: professionalTargetId,
        inicio: startDate,
        fim: endDate,
        status,
        isBlock: formData.isBlock,
        blockDescription: formData.isBlock ? blockDescription : '',
        blockScope: formData.isBlock ? formData.blockScope : 'single',
        observacoes: formData.isBlock ? blockDescription : formData.notes || '',
        createdByUid: user?.uid || 'current-user',
      };

      if (formData.isBlock) {
        basePayload.clientId = '';
        basePayload.serviceId = '';
        basePayload.precoCentavos = 0;
        basePayload.comissaoPercent = 0;
      } else if (selectedService) {
        basePayload.clientId = formData.clientId;
        basePayload.serviceId = formData.serviceId;
        basePayload.precoCentavos =
          formData.price || selectedService.precoCentavos;
        basePayload.comissaoPercent = selectedService.comissaoPercent || 0;
      }

      if (recurrenceEnabled && recurrenceEndDate) {
        basePayload.recurrenceFrequency = formData.recurrenceFrequency;
        basePayload.recurrenceEndsAt = recurrenceEndDate;
        basePayload.recurrenceOriginalStart =
          editingAppointment?.recurrenceOriginalStart || startDate;
      }

      if (editingAppointment) {
        const isRecurringAppointment = !!editingAppointment.recurrenceGroupId;

        if (recurrenceEnabled && recurrenceEndDate && isRecurringAppointment) {
          const proceed = window.confirm(
            'Este agendamento faz parte de uma recorrência. Ao atualizar, todos os agendamentos futuros serão ajustados. Deseja continuar?'
          );
          if (!proceed) {
            setIsSubmitting(false);
            return;
          }

          const recurringPayload = {
            ...basePayload,
            recurrenceGroupId: editingAppointment.recurrenceGroupId,
            recurrenceOriginalStart:
              editingAppointment.recurrenceOriginalStart ||
              basePayload.recurrenceOriginalStart ||
              startDate,
          };

          await updateRecurringAppointments(
            editingAppointment.id,
            recurringPayload,
            {
              frequency: formData.recurrenceFrequency,
              endDate: recurrenceEndDate,
            },
            shouldNotify
          );
        } else {
          const updateData: any = { ...basePayload };
          delete updateData.companyId;

          if (!recurrenceEnabled) {
            updateData.recurrenceFrequency = undefined;
            updateData.recurrenceEndsAt = undefined;
            updateData.recurrenceOriginalStart = undefined;
          }

          if (formData.isBlock) {
            updateData.clientId = '';
            updateData.serviceId = '';
            updateData.precoCentavos = 0;
            updateData.comissaoPercent = 0;
          } else if (selectedService) {
            updateData.clientId = formData.clientId;
            updateData.serviceId = formData.serviceId;
            updateData.precoCentavos =
              formData.price || selectedService.precoCentavos;
            updateData.comissaoPercent =
              selectedService.comissaoPercent || 0;
            updateData.observacoes = formData.notes || '';

            if (
              editingAppointment.status === 'concluido' &&
              formData.valorPago !== undefined &&
              formData.valorPago !== null
            ) {
              updateData.valorPagoCentavos = Math.round(
                formData.valorPago * 100
              );
            }
            if (
              formData.formaPagamento !== undefined &&
              formData.formaPagamento !== null
            ) {
              updateData.formaPagamento = formData.formaPagamento;
            }
            if (
              formData.clientePresente !== undefined &&
              formData.clientePresente !== null
            ) {
              updateData.clientePresente = formData.clientePresente;
            }
          }

          await updateAppointment(
            editingAppointment.id,
            updateData,
            shouldNotify
          );
        }
      } else {
        if (recurrenceEnabled && recurrenceEndDate) {
          const recurringPayload = {
            ...basePayload,
            recurrenceFrequency: formData.recurrenceFrequency,
            recurrenceEndsAt: recurrenceEndDate,
            recurrenceOriginalStart: startDate,
          };

          await createRecurringAppointments(
            recurringPayload,
            {
              frequency: formData.recurrenceFrequency,
              endDate: recurrenceEndDate,
            },
            shouldNotify
          );
        } else {
          await createAppointment(basePayload, shouldNotify);
        }
      }

      setFormData(buildInitialForm);
      setCurrentStep(1);
      onClose();
    } catch (error) {
      console.error('Erro ao salvar registro:', error);
      alert('Erro ao salvar registro. Tente novamente.');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleCreateNewPatient = async () => {
    if (!newPatientData.nome || !newPatientData.telefoneE164 || !companyId) return;
    
    try {
      const newPatient = await createPatient({
        companyId,
        nome: newPatientData.nome,
        telefoneE164: newPatientData.telefoneE164,
        email: newPatientData.email || undefined,
        preferenciaNotificacao: newPatientData.preferenciaNotificacao,
        anamnese: newPatientData.anamnese || undefined,
        ownerUid: user?.uid || 'current-user'
      });
      
      setFormData(prev => ({ ...prev, clientId: newPatient.id }));
      setPatientQuery('');
      
      setNewPatientData({
        nome: '',
        telefoneE164: '',
        email: '',
        preferenciaNotificacao: 'whatsapp',
        anamnese: ''
      });
      setShowNewPatientModal(false);
    } catch (error) {
      console.error('Erro ao criar paciente:', error);
      alert(`Erro ao criar ${singularLabel}. Tente novamente.`);
    }
  };

  useEffect(() => {
    if (!isOpen) {
      setPatientQuery('');
    }
  }, [isOpen]);

  if (!isOpen) return null;

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      className={cn(
        'fixed inset-0 z-50 flex items-end justify-center sm:items-center backdrop-blur-sm',
        isVibrant ? 'bg-slate-900/60 backdrop-blur-xl' : 'bg-black/50'
      )}
    >
      <motion.div
        initial={{ y: '100%', opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        exit={{ y: '100%', opacity: 0 }}
        transition={{ type: 'spring', damping: 25, stiffness: 200 }}
        className={cn(
          'flex w-full flex-col sm:h-auto sm:max-h-[90vh] sm:w-[500px] mobile-drawer',
          isVibrant
            ? 'rounded-t-3xl sm:rounded-2xl bg-white/85 border border-white/20 backdrop-blur-2xl shadow-indigo-500/20'
            : 'bg-white sm:rounded-2xl shadow-2xl'
        )}
        style={{ 
          height: '100svh',
          maxHeight: '100svh'
        }}
      >
        {/* Header */}
        <div
          className={cn(
            'flex items-center justify-between border-b p-4 text-white',
            isVibrant
              ? 'bg-gradient-to-r from-indigo-500 via-purple-500 to-rose-500 border-white/20'
              : isCustom && gradientStyleDiagonal
              ? 'border-white/20'
              : 'bg-slate-900 border-slate-900/10'
          )}
          style={
            isCustom && gradientStyleDiagonal 
              ? {
                  ...gradientStyleDiagonal,
                  paddingTop: `calc(1.5rem + env(safe-area-inset-top, 0px) + max(env(safe-area-inset-top, 0px), 44px))`,
                  paddingLeft: `calc(1rem + env(safe-area-inset-left, 0px))`,
                  paddingRight: `calc(1rem + env(safe-area-inset-right, 0px))`
                }
              : {
                  paddingTop: `calc(1.5rem + env(safe-area-inset-top, 0px) + max(env(safe-area-inset-top, 0px), 44px))`,
                  paddingLeft: `calc(1rem + env(safe-area-inset-left, 0px))`,
                  paddingRight: `calc(1rem + env(safe-area-inset-right, 0px))`
                }
          }
        >
          <div className="flex items-center gap-2">
            <Calendar className="w-5 h-5" />
            <h2 className="text-lg font-bold">Novo Agendamento</h2>
          </div>
          <Button
            variant="ghost"
            size="icon"
            onClick={onClose}
            className={cn(
              'text-white',
              hasGradient ? 'hover:bg-white/20' : 'hover:bg-white/10'
            )}
          >
            <X className="w-5 h-5" />
          </Button>
        </div>

        {/* Progress Steps */}
        <div
          className={cn(
            'border-b p-4',
            isVibrant ? 'bg-white/40 border-white/20 backdrop-blur' : 'bg-gray-50'
          )}
        >
          <div className="flex items-center justify-between">
            {steps.map((step, index) => {
              const Icon = step.icon;
              const isActive = currentStep >= step.id;
              const isCompleted = currentStep > step.id;
              
              return (
                <div key={step.id} className="flex flex-col items-center flex-1 relative">
                  <div
                    className={cn(
                      'flex h-8 w-8 items-center justify-center rounded-full text-xs font-medium transition-all duration-300',
                      isCompleted
                        ? isVibrant
                          ? 'bg-emerald-400 text-white shadow-lg'
                          : 'bg-green-500 text-white'
                        : isActive
                          ? isVibrant
                            ? 'bg-indigo-500 text-white shadow-lg'
                            : 'bg-blue-500 text-white'
                          : isVibrant
                            ? 'bg-white/80 text-slate-700'
                            : 'bg-gray-200 text-gray-500'
                    )}
                  >
                    {isCompleted ? <Check className="w-4 h-4" /> : <Icon className="w-4 h-4" />}
                  </div>
                  <span
                    className={cn(
                      'mt-1 text-center text-xs font-medium transition-colors',
                      isActive
                        ? isVibrant ? 'text-slate-800' : 'text-blue-600'
                        : isVibrant ? 'text-slate-600' : 'text-gray-500'
                    )}
                  >
                    {step.title}
                  </span>
                  {index < steps.length - 1 && (
                    <div
                      className={cn(
                        'absolute top-4 left-1/2 h-0.5 -translate-y-1/2 transition-colors',
                        currentStep > step.id
                          ? isVibrant ? 'bg-emerald-400' : 'bg-green-500'
                          : isVibrant ? 'bg-slate-400/70' : 'bg-gray-200'
                      )}
                      style={{ width: 'calc(100% - 1rem)', left: 'calc(50% + 0.5rem)' }}
                    />
                  )}
                </div>
              );
            })}
          </div>
        </div>

        {/* Content */}
        <div 
          className="flex-1 overflow-y-auto p-4" 
          style={{ WebkitOverflowScrolling: 'touch' }}
        >
          <AnimatePresence mode="wait">
            <motion.div
              key={currentStep}
              initial={{ opacity: 0, x: 20 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: -20 }}
              transition={{ duration: 0.3 }}
            >
              {/* Step 1 */}
              {currentStep === 1 && (
                <Card className={cn(isVibrant ? 'border-white/25 bg-white/70 backdrop-blur' : '')}>
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <User className="w-5 h-5" />
                      Escolha o {singularTitle}
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <div className="flex flex-wrap gap-2">
                      <Button
                        type="button"
                        variant={formData.isBlock ? 'outline' : 'default'}
                        onClick={() => {
                          setFormData(prev => ({
                            ...prev,
                            isBlock: false,
                            blockDescription: '',
                            blockScope: 'single',
                            enviarNotificacao: confirmacaoAutomatica,
                            endTime: '',
                            clientId: prev.clientId,
                            serviceId: prev.serviceId,
                            price: prev.price,
                            duration: prev.duration || 60
                          }));
                          if (currentStep > 5) {
                            setCurrentStep(5);
                          }
                        }}
                        className={cn(
                          'text-xs font-semibold',
                          !formData.isBlock
                            ? cn(
                                'text-white',
                                hasGradient
                                  ? isCustom && gradientStyleHorizontal
                                    ? ''
                                    : 'bg-gradient-to-r from-indigo-500 to-rose-500'
                                  : 'bg-slate-900'
                              )
                            : cn(
                                'text-slate-700',
                                isCustom && 'border-slate-300 hover:bg-slate-100'
                              )
                        )}
                        style={!formData.isBlock && isCustom && gradientStyleHorizontal ? gradientStyleHorizontal : undefined}
                      >
                        Atendimento
                      </Button>
                      <Button
                        type="button"
                        variant={formData.isBlock ? 'default' : 'outline'}
                        onClick={() => {
                          setFormData(prev => ({
                            ...prev,
                            isBlock: true,
                            clientId: '',
                            serviceId: '',
                            price: 0,
                            notes: '',
                            enviarNotificacao: false,
                            blockScope: 'single',
                            blockDescription: '',
                            endTime: '',
                            duration: prev.duration || 60,
                            professionalId: role === 'pro' && professionalId ? professionalId : ''
                          }));
                          if (currentStep > 3) {
                            setCurrentStep(3);
                          }
                        }}
                        className={cn(
                          'text-xs font-semibold',
                          formData.isBlock
                            ? cn(
                                'text-white',
                                hasGradient
                                  ? isCustom && gradientStyleHorizontal
                                    ? ''
                                    : 'bg-gradient-to-r from-indigo-500 to-rose-500'
                                  : 'bg-slate-900'
                              )
                            : cn(
                                'text-slate-700',
                                isCustom && 'border-slate-300 hover:bg-slate-100'
                              )
                        )}
                        style={formData.isBlock && isCustom && gradientStyleHorizontal ? gradientStyleHorizontal : undefined}
                      >
                        Bloqueio
                      </Button>
                    </div>

                    {formData.isBlock ? (
                      <div
                        className={cn(
                          'rounded-xl border px-4 py-4 text-sm leading-relaxed',
                          isVibrant
                            ? 'border-white/30 bg-white/60 text-slate-700'
                            : 'border-slate-200 bg-slate-50 text-slate-600'
                        )}
                      >
                        Bloqueios não estão associados a {pluralTitle}. Use este registro apenas para
                        sinalizar indisponibilidades na agenda.
                      </div>
                    ) : (
                      <>
                        <div>
                          <label
                            className={cn(
                              'block text-sm font-medium mb-2',
                              isVibrant ? 'text-slate-700' : 'text-slate-600'
                            )}
                          >
                            {singularTitle}
                          </label>
                          <Combobox
                            value={selectedPatient}
                            onChange={handlePatientSelect}
                            nullable
                          >
                            <div className="relative">
                              <div
                                className={cn(
                                  'relative w-full cursor-default overflow-hidden rounded-lg border transition focus-within:ring-2',
                                  isVibrant
                                    ? 'border-white/30 bg-white/75 text-slate-800 focus-within:border-indigo-300 focus-within:ring-indigo-300'
                                    : 'border-gray-300 bg-white text-slate-700 focus-within:border-blue-500 focus-within:ring-blue-500'
                                )}
                              >
                                <Combobox.Input
                                  className="w-full border-none bg-transparent py-3 pl-4 pr-10 text-base focus:outline-none"
                                  displayValue={(patient: any) => patient?.nome ?? ''}
                                  onChange={(event) => setPatientQuery(event.target.value)}
                                  placeholder={`Buscar ${singularLabel} por nome, telefone ou email`}
                                />
                                <Combobox.Button className="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400">
                                  <ChevronsUpDown className="h-4 w-4" />
                                </Combobox.Button>
                              </div>
                              <Transition
                                as={Fragment}
                                leave="transition ease-in duration-100"
                                leaveFrom="opacity-100"
                                leaveTo="opacity-0"
                              >
                                <Combobox.Options
                                  className={cn(
                                    'absolute z-[1000000] mt-2 max-h-60 w-full overflow-auto rounded-xl border shadow-xl',
                                    isVibrant
                                      ? 'border-white/25 bg-white/90 backdrop-blur-xl'
                                      : 'border-slate-200 bg-white'
                                  )}
                                >
                                  {filteredPatients.length === 0 ? (
                                    <div className="px-4 py-3 text-sm text-slate-500">
                                      Nenhum {singularLabel} encontrado.
                                    </div>
                                  ) : (
                                    filteredPatients.map((patient) => (
                                      <Combobox.Option
                                        key={patient.id}
                                        value={patient}
                                        className={({ active }) =>
                                          cn(
                                            'flex items-center justify-between gap-3 px-4 py-3 text-sm transition',
                                            active
                                              ? isVibrant
                                                ? 'bg-indigo-500/10 text-indigo-600'
                                                : 'bg-slate-100 text-slate-900'
                                              : 'text-slate-700'
                                          )
                                        }
                                      >
                                        {({ selected }) => (
                                          <>
                                            <div className="flex flex-col">
                                              <span className="font-semibold">{patient.nome}</span>
                                              <span className="text-xs text-slate-500">
                                                {formatPhoneNumber(patient.telefoneE164)}
                                              </span>
                                              {patient.email && (
                                                <span className="text-xs text-slate-500">{patient.email}</span>
                                              )}
                                            </div>
                                            <span
                                              className={cn(
                                                'flex h-5 w-5 items-center justify-center rounded-full border text-xs font-bold transition-colors',
                                                selected
                                                  ? 'border-indigo-500 bg-indigo-500 text-white'
                                                  : 'border-slate-300 text-transparent'
                                              )}
                                            >
                                              <Check className="h-3 w-3" />
                                            </span>
                                          </>
                                        )}
                                      </Combobox.Option>
                                    ))
                                  )}
                                </Combobox.Options>
                              </Transition>
                            </div>
                          </Combobox>
                        </div>

                        <Button
                          type="button"
                          onClick={() => setShowNewPatientModal(true)}
                          variant="outline"
                          disabled={formData.isBlock}
                          className={cn(
                            'mt-3 flex h-11 items-center justify-center gap-2 text-sm',
                            isVibrant
                              ? 'border-white/30 text-slate-800 hover:bg-white/30 hover:text-indigo-600'
                              : ''
                          )}
                        >
                          <Plus className="h-4 w-4" />
                          Cadastrar {singularTitle}
                        </Button>
                      </>
                    )}
                  </CardContent>
                </Card>
              )}

              {/* Step 2: Serviço */}
              {currentStep === 2 && (
                <Card className={cn(isVibrant ? 'border-white/25 bg-white/70 backdrop-blur' : '')}>
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <FileText className="w-5 h-5" />
                      Escolha o Serviço
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    {formData.isBlock ? (
                      <div
                        className={cn(
                          'rounded-xl border px-4 py-4 text-sm leading-relaxed',
                          isVibrant
                            ? 'border-white/30 bg-white/60 text-slate-700'
                            : 'border-slate-200 bg-slate-50 text-slate-600'
                        )}
                      >
                        Bloqueios não exigem seleção de serviço. Eles apenas reservam o horário indicado.
                      </div>
                    ) : (
                      <>
                        <div>
                          <label
                            className={cn(
                              'block text-sm font-medium mb-2',
                              isVibrant ? 'text-slate-700' : 'text-slate-600'
                            )}
                          >
                            Serviço
                          </label>
                          <select
                            value={formData.serviceId}
                            onChange={(e) => {
                              const service = services.find(s => s.id === e.target.value);
                              setFormData(prev => ({ 
                                ...prev, 
                                serviceId: e.target.value,
                                duration: service?.duracaoMin ?? prev.duration,
                                price: service?.precoCentavos ?? 0
                              }));
                            }}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base"
                          >
                            <option value="">Selecione um serviço</option>
                            {services.map(service => (
                              <option key={service.id} value={service.id}>
                                {service.nome} - R$ {(service.precoCentavos / 100).toFixed(2)}
                              </option>
                            ))}
                          </select>
                        </div>
                        {formData.serviceId && (
                          <div className="grid grid-cols-2 gap-3">
                            <div className="p-3 bg-green-50 rounded-lg border border-green-200">
                              <p className="text-xs font-medium text-green-700 uppercase tracking-wide">Duração</p>
                              <p className="text-sm font-semibold text-green-900">{formData.duration} min</p>
                            </div>
                            <div className="p-3 bg-green-50 rounded-lg border border-green-200">
                              <p className="text-xs font-medium text-green-700 uppercase tracking-wide">Preço</p>
                              <p className="text-sm font-semibold text-green-900">
                                R$ {(formData.price / 100).toFixed(2)}
                              </p>
                            </div>
                          </div>
                        )}
                      </>
                    )}
                  </CardContent>
                </Card>
              )}

              {/* Step 3: Profissional */}
              {currentStep === 3 && (
                <Card className={cn(isVibrant ? 'border-white/25 bg-white/70 backdrop-blur' : '')}>
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <User className="w-5 h-5" />
                      Escolha o Profissional
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    {formData.isBlock && (
                      <div
                        className={cn(
                          'rounded-xl border px-4 py-3',
                          isVibrant
                            ? 'border-white/30 bg-white/60 text-slate-700'
                            : 'border-slate-200 bg-slate-50 text-slate-600'
                        )}
                      >
                        <p className="text-sm font-medium mb-2">Escopo do bloqueio</p>
                        <div className="flex flex-wrap gap-2">
                          <Button
                            type="button"
                            variant={formData.blockScope === 'single' ? 'default' : 'outline'}
                            onClick={() =>
                              setFormData(prev => ({
                                ...prev,
                                blockScope: 'single',
                                professionalId: role === 'pro' && professionalId ? professionalId : prev.professionalId || ''
                              }))
                            }
                            className={cn(
                              'text-xs font-semibold px-3',
                              formData.blockScope === 'single'
                                ? hasGradient
                              ? isCustom && gradientStyleHorizontal
                                ? 'text-white'
                                : 'bg-gradient-to-r from-indigo-500 to-rose-500 text-white'
                              : 'bg-slate-900 text-white'
                                : ''
                            )}
                          >
                            Profissional específico
                          </Button>
                          <Button
                            type="button"
                            variant={formData.blockScope === 'all' ? 'default' : 'outline'}
                            onClick={() =>
                              setFormData(prev => ({
                                ...prev,
                                blockScope: 'all',
                                professionalId: '__all__'
                              }))
                            }
                            className={cn(
                              'text-xs font-semibold px-3',
                              formData.blockScope === 'all'
                                ? hasGradient
                              ? isCustom && gradientStyleHorizontal
                                ? 'text-white'
                                : 'bg-gradient-to-r from-indigo-500 to-rose-500 text-white'
                              : 'bg-slate-900 text-white'
                                : ''
                            )}
                          >
                            Todos os profissionais
                          </Button>
                        </div>
                        <p className="text-xs mt-2 text-slate-500">
                          Bloqueios gerais aparecerão em todas as agendas.
                        </p>
                      </div>
                    )}

                    <div>
                      <label
                        className={cn(
                          'block text-sm font-medium mb-2',
                          isVibrant ? 'text-slate-700' : 'text-slate-600'
                        )}
                      >
                        Profissional
                        {role === 'pro' && (
                          <span className="text-xs text-gray-500 ml-2">(Você está logado como profissional)</span>
                        )}
                      </label>
                      <select
                        value={
                          formData.isBlock && formData.blockScope === 'all'
                            ? '__all__'
                            : formData.professionalId
                        }
                        onChange={(e) => setFormData(prev => ({ ...prev, professionalId: e.target.value }))}
                        disabled={
                          (formData.isBlock && formData.blockScope === 'all') ||
                          (role === 'pro' && !formData.isBlock)
                        }
                        className={`w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base ${
                          (formData.isBlock && formData.blockScope === 'all') || (role === 'pro' && !formData.isBlock)
                            ? 'bg-gray-100 cursor-not-allowed'
                            : ''
                        }`}
                      >
                        <option value="">Selecione um profissional</option>
                        {formData.isBlock && <option value="__all__">Todos os profissionais</option>}
                        {professionals.map(professional => (
                          <option key={professional.id} value={professional.id}>
                            {professional.apelido}
                          </option>
                        ))}
                      </select>
                      {role === 'pro' && (
                        <p className="text-xs text-gray-600 mt-1">
                          Você não pode alterar o profissional pois está logado como profissional.
                        </p>
                      )}
                    </div>
                  </CardContent>
                </Card>
              )}

              {/* Step 4: Data e Hora */}
              {currentStep === 4 && (
                <Card className={cn(isVibrant ? 'border-white/25 bg-white/70 backdrop-blur' : '')}>
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <Calendar className="w-5 h-5" />
                      Data e Hora
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <div>
                      <label
                        className={cn(
                          'block text-sm font-medium mb-2',
                          isVibrant ? 'text-slate-700' : 'text-slate-600'
                        )}
                      >
                        Data
                      </label>
                      <Input
                        type="date"
                        value={formData.date}
                        onChange={(e) => setFormData(prev => ({ ...prev, date: e.target.value }))}
                        className="p-3 text-base"
                      />
                    </div>
                    <div>
                      <label
                        className={cn(
                          'block text-sm font-medium mb-2',
                          isVibrant ? 'text-slate-700' : 'text-slate-600'
                        )}
                      >
                        Hora
                      </label>
                      <Input
                        type="time"
                        value={formData.time}
                        onChange={(e) => setFormData(prev => ({ ...prev, time: e.target.value }))}
                        className="p-3 text-base"
                      />
                    </div>
                    {formData.isBlock && (
                      <div>
                        <label
                          className={cn(
                            'block text-sm font-medium mb-2',
                            isVibrant ? 'text-slate-700' : 'text-slate-600'
                          )}
                        >
                          Hora de término
                        </label>
                        <Input
                          type="time"
                          value={formData.endTime}
                          onChange={(e) => setFormData(prev => ({ ...prev, endTime: e.target.value }))}
                          className="p-3 text-base"
                        />
                      </div>
                    )}
                    {!formData.isBlock && (
                      <div
                        className={cn(
                          'rounded-xl border p-4 space-y-4',
                          isVibrant
                            ? 'border-white/30 bg-white/60 text-slate-700'
                            : 'border-slate-200 bg-slate-50 text-slate-600'
                        )}
                      >
                        <div className="flex items-center justify-between gap-3">
                          <div>
                            <p className="text-sm font-semibold">Agendamento recorrente</p>
                            <p className="text-xs text-slate-500">
                              Repete automaticamente este atendimento em intervalos regulares.
                            </p>
                          </div>
                          <input
                            type="checkbox"
                            checked={formData.recurrenceEnabled}
                            disabled={Boolean(editingAppointment) && !formData.recurrenceEnabled}
                            onChange={(e) =>
                              setFormData((prev) => ({
                                ...prev,
                                recurrenceEnabled: e.target.checked,
                                recurrenceEndsOn: e.target.checked
                                  ? prev.recurrenceEndsOn || prev.date
                                  : '',
                              }))
                            }
                            className="w-5 h-5 rounded border-gray-300"
                          />
                        </div>

                        {Boolean(editingAppointment) && !formData.recurrenceEnabled && (
                          <p className="text-xs text-slate-500">
                            Para configurar recorrência em um agendamento já existente, crie uma nova série.
                          </p>
                        )}

                        {formData.recurrenceEnabled && (
                          <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
                            <div>
                              <label className="block text-xs font-medium mb-2 text-slate-500">
                                Frequência
                              </label>
                              <select
                                value={formData.recurrenceFrequency}
                                onChange={(e) =>
                                  setFormData((prev) => ({
                                    ...prev,
                                    recurrenceFrequency: e.target.value as FormData['recurrenceFrequency'],
                                  }))
                                }
                                className={cn(
                                  'w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-2',
                                  isVibrant
                                    ? 'border-white/30 bg-white/75 text-slate-800 focus:border-indigo-300 focus:ring-indigo-300'
                                    : 'border-slate-200 bg-white text-slate-700 focus:border-blue-500 focus:ring-blue-500'
                                )}
                              >
                                <option value="daily">Diariamente</option>
                                <option value="weekly">Semanal</option>
                                <option value="biweekly">Quinzenal</option>
                                <option value="monthly">Mensal</option>
                              </select>
                            </div>
                            <div>
                              <label className="block text-xs font-medium mb-2 text-slate-500">
                                Repetir até
                              </label>
                              <Input
                                type="date"
                                min={formData.date || undefined}
                                value={formData.recurrenceEndsOn}
                                onChange={(e) =>
                                  setFormData((prev) => ({
                                    ...prev,
                                    recurrenceEndsOn: e.target.value,
                                  }))
                                }
                                className={cn(
                                  'w-full rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2',
                                  isVibrant
                                    ? 'border-white/30 bg-white/75 text-slate-800 focus:border-indigo-300 focus:ring-indigo-300'
                                    : 'border-slate-200 bg-white text-slate-700 focus:border-blue-500 focus:ring-blue-500'
                                )}
                              />
                              <p className="mt-1 text-[11px] text-slate-500">
                                O limite máximo é de 1 ano a partir da data inicial.
                              </p>
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                  </CardContent>
                </Card>
              )}

              {/* Step 5: Detalhes */}
              {currentStep === 5 && (
                <Card className={cn(isVibrant ? 'border-white/25 bg-white/70 backdrop-blur' : '')}>
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <Clock className="w-5 h-5" />
                      Detalhes Finais
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    {formData.isBlock ? (
                      <>
                        <div>
                          <label className="block text-sm font-medium mb-2">Descrição do bloqueio</label>
                          <textarea
                            value={formData.blockDescription}
                            onChange={(e) => setFormData(prev => ({ ...prev, blockDescription: e.target.value }))}
                            placeholder="Descreva o motivo da indisponibilidade..."
                            className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base resize-none"
                            rows={4}
                          />
                        </div>
                        <div className="p-3 bg-violet-50 rounded-lg border border-violet-200 text-violet-800 text-sm leading-relaxed">
                          Este bloqueio será exibido na agenda do(s) profissional(is) selecionado(s) e não enviará notificações.
                        </div>
                      </>
                    ) : (
                      <>
                        <div>
                          <label className="block text-sm font-medium mb-2">Observações</label>
                          <textarea
                            value={formData.notes}
                            onChange={(e) => setFormData(prev => ({ ...prev, notes: e.target.value }))}
                            placeholder="Observações adicionais..."
                            className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base resize-none"
                            rows={4}
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-2">Preço (opcional)</label>
                          <Input
                            type="number"
                            step="0.01"
                            value={(formData.price / 100).toFixed(2)}
                            onChange={(e) => {
                              const value = parseFloat(e.target.value);
                              setFormData(prev => ({
                                ...prev,
                                price: Number.isNaN(value) ? 0 : Math.max(0, Math.round(value * 100))
                              }));
                            }}
                            placeholder="0,00"
                            className="p-3 text-base"
                          />
                        </div>
                        <div className="flex items-center gap-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                          <input
                            type="checkbox"
                            id="enviarNotificacao"
                            checked={formData.enviarNotificacao !== false}
                            onChange={(e) => setFormData(prev => ({ ...prev, enviarNotificacao: e.target.checked }))}
                            className="w-5 h-5 rounded border-gray-300"
                          />
                          <label htmlFor="enviarNotificacao" className="text-sm font-medium text-gray-700 cursor-pointer">
                            Enviar notificação para o cliente
                          </label>
                        </div>
                      </>
                    )}

                    <div className="p-3 bg-gray-50 rounded-lg border border-gray-200">
                      <p className="text-xs text-gray-500 uppercase font-medium mb-2">Resumo</p>
                      <ul className="text-sm text-gray-700 space-y-1">
                        {formData.isBlock ? (
                          <>
                            <li>
                              <strong>Escopo:</strong>{' '}
                              {formData.blockScope === 'all' ? 'Todos os profissionais' : 'Profissional específico'}
                            </li>
                            {formData.blockScope === 'single' && (
                              <li>
                                <strong>Profissional:</strong>{' '}
                                {professionals.find(p => p.id === formData.professionalId)?.apelido || 'Não selecionado'}
                              </li>
                            )}
                            <li><strong>Data:</strong> {formData.date ? new Date(formData.date).toLocaleDateString('pt-BR') : 'Não definida'}</li>
                            <li>
                              <strong>Horário:</strong>{' '}
                              {formData.time ? formData.time : '—'}
                              {formData.endTime ? ` às ${formData.endTime}` : ''}
                            </li>
                            <li><strong>Descrição:</strong> {formData.blockDescription || 'Sem descrição'}</li>
                          </>
                        ) : (
                          <>
                            <li><strong>Cliente:</strong> {selectedPatient?.nome || 'Não selecionado'}</li>
                            <li><strong>Serviço:</strong> {services.find(s => s.id === formData.serviceId)?.nome || 'Não selecionado'}</li>
                            <li><strong>Profissional:</strong> {professionals.find(p => p.id === formData.professionalId)?.apelido || 'Não selecionado'}</li>
                            <li><strong>Data:</strong> {formData.date ? new Date(formData.date).toLocaleDateString('pt-BR') : 'Não definida'}</li>
                            <li><strong>Hora:</strong> {formData.time || 'Não definida'}</li>
                            <li><strong>Duração:</strong> {formData.duration} minutos</li>
                            {formData.recurrenceEnabled && (
                              <li>
                                <strong>Recorrência:</strong>{' '}
                                {{
                                  daily: 'Diariamente',
                                  weekly: 'Semanal',
                                  biweekly: 'Quinzenal',
                                  monthly: 'Mensal',
                                }[formData.recurrenceFrequency]}{' '}
                                até{' '}
                                {formData.recurrenceEndsOn
                                  ? new Date(formData.recurrenceEndsOn).toLocaleDateString('pt-BR')
                                  : 'data não definida'}
                              </li>
                            )}
                            <li><strong>Preço:</strong> R$ {(formData.price / 100).toFixed(2)}</li>
                          </>
                        )}
                      </ul>
                    </div>
                  </CardContent>
                </Card>
              )}

              {/* Step 6: Pagamento (apenas para agendamentos concluídos) */}
              {currentStep === 6 && editingAppointment?.status === 'concluido' && (
                <Card className={cn(isVibrant ? 'border-white/25 bg-white/70 backdrop-blur' : '')}>
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <Check className="w-5 h-5" />
                      Informações de Pagamento
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium mb-2">Valor Pago</label>
                      <Input
                        type="number"
                        step="0.01"
                        value={formData.valorPago || ''}
                        onChange={(e) => setFormData(prev => ({ ...prev, valorPago: parseFloat(e.target.value) || 0 }))}
                        placeholder="0.00"
                        className="p-3 text-base"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium mb-2">Forma de Pagamento</label>
                      <select
                        value={formData.formaPagamento || ''}
                        onChange={(e) => setFormData(prev => ({ ...prev, formaPagamento: e.target.value as any }))}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base"
                      >
                        <option value="">Selecione...</option>
                        <option value="dinheiro">Dinheiro</option>
                        <option value="cartao_debito">Cartão de Débito</option>
                        <option value="cartao_credito">Cartão de Crédito</option>
                        <option value="pix">PIX</option>
                        <option value="outros">Outros</option>
                      </select>
                    </div>

                    <div className="flex items-center gap-3">
                      <input
                        type="checkbox"
                        id="clientePresente"
                        checked={formData.clientePresente || false}
                        onChange={(e) => setFormData(prev => ({ ...prev, clientePresente: e.target.checked }))}
                        className="w-5 h-5 rounded border-gray-300"
                      />
                      <label htmlFor="clientePresente" className="text-sm font-medium">
                        {singularTitle} compareceu ao atendimento
                      </label>
                    </div>
                  </CardContent>
                </Card>
              )}
            </motion.div>
          </AnimatePresence>
        </div>

        {/* Footer - Sticky at bottom */}
        <div
          className={cn(
            'sticky bottom-0 p-4 border-t z-[100]',
            hasGradient ? 'bg-white/95 border-white/20 backdrop-blur' : 'bg-white'
          )}
          style={{
            paddingBottom: `calc(1rem + env(safe-area-inset-bottom))`,
            paddingLeft: `calc(1rem + env(safe-area-inset-left, 0px))`,
            paddingRight: `calc(1rem + env(safe-area-inset-right, 0px))`,
            marginTop: 'auto',
            position: 'sticky',
            zIndex: 100
          }}
        >
          <div className="flex items-center justify-between gap-2 sm:gap-3">
            <div className="flex items-center gap-1.5 sm:gap-2">
              <Button
                variant="outline"
                onClick={onClose}
                className={cn(
                  'flex h-12 items-center justify-center gap-1.5 sm:gap-2 px-3 sm:px-4 min-w-[48px]',
                  'border-2 border-slate-500 text-slate-900 bg-white hover:bg-slate-100',
                  'shadow-md active:shadow-inner relative z-[101]'
                )}
                style={{ zIndex: 101 }}
                type="button"
              >
                <X className="w-5 h-5 flex-shrink-0 text-slate-900" />
                <span className="hidden sm:inline font-medium text-slate-900">Fechar</span>
              </Button>
              <Button
                variant="outline"
                onClick={prevStep}
                disabled={currentStep === 1}
                className={cn(
                  'flex h-12 items-center gap-1.5 sm:gap-2 px-3 sm:px-4',
                  hasGradient ? 'border-white/25 text-slate-700 hover:bg-white/40' : ''
                )}
              >
                <ChevronLeft className="w-4 h-4 flex-shrink-0" />
                <span className="hidden sm:inline">Anterior</span>
                <span className="sm:hidden">Ant</span>
              </Button>
            </div>

            {currentStep < (editingAppointment?.status === 'concluido' ? 6 : 5) ? (
              <Button
                onClick={nextStep}
                disabled={!canProceed()}
                className={cn(
                  'flex h-12 items-center gap-2 px-6 text-white',
                  hasGradient
                    ? isCustom && gradientStyleDiagonal
                      ? ''
                      : 'bg-gradient-to-r from-indigo-500 via-purple-500 to-rose-500 hover:from-indigo-600 hover:via-purple-600 hover:to-rose-600'
                    : 'bg-slate-900 hover:bg-slate-800 shadow-none'
                )}
                style={isCustom && gradientStyleDiagonal ? gradientStyleDiagonal : undefined}
              >
                Próximo
                <ChevronRight className="w-4 h-4" />
              </Button>
            ) : (
              <Button
                onClick={handleSubmit}
                disabled={!canProceed() || isSubmitting}
                className={cn(
                  'flex h-12 items-center gap-2 px-6 text-white',
                  hasGradient
                    ? isCustom && gradientStyleDiagonal
                      ? ''
                      : 'bg-gradient-to-r from-emerald-400 via-sky-500 to-indigo-500 hover:from-emerald-500 hover:via-sky-600 hover:to-indigo-600'
                    : 'bg-slate-900 hover:bg-slate-800 shadow-none'
                )}
                style={isCustom && gradientStyleDiagonal ? gradientStyleDiagonal : undefined}
              >
                {isSubmitting ? (
                  <>
                    <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                    {editingAppointment ? 'Atualizando...' : 'Criando...'}
                  </>
                ) : (
                  <>
                    <Save className="w-4 h-4" />
                    {editingAppointment ? 'Atualizar Agendamento' : 'Criar Agendamento'}
                  </>
                )}
              </Button>
            )}
          </div>
        </div>
      </motion.div>

      {/* Modal Novo Paciente/Cliente */}
      {showNewPatientModal && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className={cn(
            'fixed inset-0 z-[60] flex items-center justify-center p-4 backdrop-blur-sm',
            isVibrant ? 'bg-slate-900/60 backdrop-blur-xl' : 'bg-black/50'
          )}
        >
          <motion.div
            initial={{ scale: 0.9, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            exit={{ scale: 0.9, opacity: 0 }}
            className={cn(
              'w-full max-w-md rounded-2xl p-6 border shadow-2xl',
              isVibrant ? 'bg-white/85 border-white/25 backdrop-blur-2xl' : 'bg-white border-slate-200'
            )}
          >
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold text-slate-900">Novo {singularTitle}</h3>
              <Button
                variant="ghost"
                size="icon"
                onClick={() => setShowNewPatientModal(false)}
                className={cn(isVibrant ? 'text-slate-600 hover:bg-white/40' : '')}
              >
                <X className="w-5 h-5" />
              </Button>
            </div>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-2">Nome *</label>
                <Input
                  value={newPatientData.nome}
                  onChange={(e) => setNewPatientData(prev => ({ ...prev, nome: e.target.value }))}
                  placeholder={`Nome completo do ${singularLabel}`}
                  className="p-3 text-base"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-2">Telefone *</label>
                <Input
                  type="tel"
                  value={newPatientData.telefoneE164}
                  onChange={(e) => setNewPatientData(prev => ({ ...prev, telefoneE164: e.target.value }))}
                  placeholder="+55 11 99999-9999"
                  className="p-3 text-base"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-2">Email (opcional)</label>
                <Input
                  type="email"
                  value={newPatientData.email}
                  onChange={(e) => setNewPatientData(prev => ({ ...prev, email: e.target.value }))}
                  placeholder={`${singularLabel}@email.com`}
                  className="p-3 text-base"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-2">Anamnese (opcional)</label>
                <textarea
                  value={newPatientData.anamnese}
                  onChange={(e) => setNewPatientData(prev => ({ ...prev, anamnese: e.target.value }))}
                  placeholder="Observações clínicas, alergias, tratamentos em andamento..."
                  className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base min-h-[100px] resize-y"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-2">Preferência de Notificação</label>
                <select
                  value={newPatientData.preferenciaNotificacao}
                  onChange={(e) => setNewPatientData(prev => ({ ...prev, preferenciaNotificacao: e.target.value as 'whatsapp' | 'sms' | 'email' }))}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base"
                >
                  <option value="whatsapp">WhatsApp</option>
                  <option value="sms">SMS</option>
                  <option value="email">Email</option>
                </select>
              </div>

              <div className="flex gap-3 pt-4">
                <Button
                  variant="outline"
                  onClick={() => setShowNewPatientModal(false)}
                  className={cn('flex-1', hasGradient ? 'border-white/30 text-slate-700 hover:bg-white/40' : '')}
                >
                  Cancelar
                </Button>
                <Button
                  onClick={handleCreateNewPatient}
                  disabled={!newPatientData.nome || !newPatientData.telefoneE164}
                    className={cn(
                      'flex-1 text-white',
                      hasGradient
                        ? isCustom && gradientStyleDiagonal
                          ? ''
                          : 'bg-gradient-to-r from-indigo-500 via-purple-500 to-rose-500 hover:from-indigo-600 hover:via-purple-600 hover:to-rose-600'
                        : 'bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700'
                    )}
                    style={isCustom && gradientStyleDiagonal ? gradientStyleDiagonal : undefined}
                  >
                    Criar {singularTitle}
                  </Button>
              </div>
            </div>
          </motion.div>
        </motion.div>
      )}
    </motion.div>
  );
}
