# Removido 'version' pois é obsoleto no Docker Compose v2+

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    platform: linux/arm64
    container_name: evolution-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=evolution
      - POSTGRES_USER=evolution
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-evolution123}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      # Disco persistente único - subpasta postgres
      - /mnt/disks/evolution-data/postgres:/var/lib/postgresql/data
      # Configurações do PostgreSQL para aceitar conexões externas
      - ./config/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./config/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
    networks:
      - evolution-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U evolution"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command: postgres -c listen_addresses='*' -c max_connections=200
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis Cache
  redis:
    image: redis:7-alpine
    platform: linux/arm64
    container_name: evolution-redis
    restart: unless-stopped
    volumes:
      # Disco persistente único - subpasta redis
      - /mnt/disks/evolution-data/redis:/data
    networks:
      - evolution-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    command: redis-server --appendonly yes --appendfsync always --maxmemory 512mb --maxmemory-policy allkeys-lru --save 60 1000 --save 300 10 --save 900 1
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Evolution API
  evolution-api:
    image: jilcimar/evolution-api:latest
    platform: linux/arm64
    container_name: evolution-api
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      # Autenticação
      - AUTHENTICATION_API_KEY=${AUTHENTICATION_API_KEY:-sua-chave-secreta-aqui}
      - AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES=true
      
      # Servidor
      - SERVER_TYPE=http
      - SERVER_PORT=8080
      - SERVER_URL=${SERVER_URL:-http://localhost:8080}
      
      # Banco de dados PostgreSQL
      - DATABASE_ENABLED=true
      - DATABASE_PROVIDER=postgresql
      # DATABASE_URL também é necessário (algumas versões da Evolution API usam)
      - DATABASE_URL=postgresql://evolution:${POSTGRES_PASSWORD:-evolution123}@postgres:5432/evolution?schema=public
      - DATABASE_CONNECTION_URI=postgresql://evolution:${POSTGRES_PASSWORD:-evolution123}@postgres:5432/evolution?schema=public
      - DATABASE_CONNECTION_CLIENT_NAME=evolution
      # Salvar dados no PostgreSQL (variáveis oficiais da documentação)
      # https://doc.evolution-api.com/v2/en/env
      - DATABASE_SAVE_DATA_INSTANCE=true
      - DATABASE_SAVE_DATA_NEW_MESSAGE=true
      - DATABASE_SAVE_MESSAGE_UPDATE=true
      - DATABASE_SAVE_DATA_CONTACTS=true
      - DATABASE_SAVE_DATA_CHATS=true
      - DATABASE_SAVE_DATA_LABELS=true
      - DATABASE_SAVE_DATA_HISTORIC=true
      
      # Redis
      - REDIS_ENABLED=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - REDIS_DB=0
      - REDIS_URI=redis://redis:6379
      
      # Cache Redis
      # Documentação: https://doc.evolution-api.com/v2/en/env
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://redis:6379/6
      - CACHE_REDIS_PREFIX_KEY=evolution
      - CACHE_REDIS_SAVE_INSTANCES=true
      
      # Configuração de retenção de instâncias
      # DEL_INSTANCE: minutos para deletar instância desconectada (false = nunca deletar)
      # Documentação: https://doc.evolution-api.com/v2/en/env
      - DEL_INSTANCE=false
      
      # Webhook
      - WEBHOOK_GLOBAL_ENABLED=${WEBHOOK_GLOBAL_ENABLED:-false}
      - WEBHOOK_GLOBAL_URL=${WEBHOOK_GLOBAL_URL:-}
      
      # QR Code
      - QRCODE_LIMIT=30
      - QRCODE_COLOR=#198754
      
      # Logs (aumentar nível para DEBUG para ver mensagens sendo salvas)
      - LOG_LEVEL=${LOG_LEVEL:-ERROR,WARN,INFO,LOG}
      - LOG_COLOR=true
      
      # Idioma
      - LANGUAGE=pt
      
      # Configurações de sessão
      - CONFIG_SESSION_PHONE_CLIENT=Chrome
      - CONFIG_SESSION_PHONE_NAME=Chrome
      - CONFIG_SESSION_PHONE_VERSION=2.3000.1030565872
      
      # CORS
      - CORS_ORIGIN=*
      - CORS_METHODS=GET,POST,PUT,DELETE,OPTIONS
      - CORS_CREDENTIALS=true
    volumes:
      # Disco persistente único - subpasta instances (sessões do WhatsApp)
      # IMPORTANTE: Este é o caminho padrão onde Evolution API salva as instâncias
      - /mnt/disks/evolution-data/instances:/evolution/instances
      # Logs do Evolution API (persistidos no disco)
      - /mnt/disks/evolution-data/logs:/evolution/logs
      # Arquivos temporários e cache (persistidos no disco)
      - /mnt/disks/evolution-data/tmp:/evolution/tmp
      # Database local (se usar SQLite como fallback)
      - /mnt/disks/evolution-data/database:/evolution/database
      # Mensagens salvas em arquivo (CRÍTICO para getBase64FromMediaMessage)
      # O endpoint requer mensagens em MongoDB ou arquivo, então salvamos em arquivo também
      - /mnt/disks/evolution-data/messages:/evolution/store
      # Configurações (read-only)
      - ./config/evolution.env:/evolution/.env:ro
    networks:
      - evolution-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Nginx Reverse Proxy com HTTPS
  nginx:
    image: nginx:alpine
    platform: linux/arm64
    container_name: evolution-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx-ssl.conf:/etc/nginx/conf.d/default.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - ./config/ssl:/etc/nginx/ssl:ro
    environment:
      - NGINX_HOST=_
    depends_on:
      - evolution-api
    networks:
      - evolution-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  evolution-network:
    driver: bridge

