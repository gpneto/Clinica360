'use client';

import { Suspense, useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import Link from 'next/link';
import { motion, AnimatePresence } from 'framer-motion';
import { ArrowLeft, CalendarClock, ClipboardList, FileText, FolderOpen, History, Stethoscope, Upload, Wallet, Trash2, MessageCircle, Send, Reply, Clock3, Smartphone, Printer, Copy, Check, X, Edit, ChevronDown, ChevronUp, Bot, UserCircle, Image, Video, Music, Download, Plus, Eye, Save, AlertTriangle, CheckCircle2, Pill, FileCheck, DollarSign } from 'lucide-react';
import { AccessGuard } from '@/components/AccessGuard';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { useAuth } from '@/lib/auth-context';
import { canAccessClientsMenu, canAccessPatientDebits } from '@/lib/permissions';
import { usePatient, useAppointments, useProfessionals, useServices, usePatientEvolutions, useCompany, useDentalProcedures, usePatientDebits, useOrcamentos } from '@/hooks/useFirestore';
import { showError, showSuccess } from '@/components/ui/toast';
import { storage } from '@/lib/firebase';
import { ref, listAll, getDownloadURL, uploadBytesResumable, getMetadata, deleteObject } from 'firebase/storage';
import { format, formatDistanceToNow, startOfDay } from 'date-fns';
import { ptBR } from 'date-fns/locale';
import type { PatientEvolution } from '@/types';
import { Gallery, Item } from 'react-photoswipe-gallery';
import 'photoswipe/style.css';
import { Badge } from '@/components/ui/badge';
import { collection, limit, onSnapshot, orderBy, query, where, addDoc, doc, getDoc, updateDoc, deleteDoc } from 'firebase/firestore';
import { db, functions } from '@/lib/firebase';
import { httpsCallable } from 'firebase/functions';
import { useCustomerLabels } from '@/hooks/useCustomerLabels';
import { DentalChart } from './DentalChart';
import { FinanceiroTab } from './FinanceiroTab';
import { DocumentosTab } from './DocumentosTab';
import { DadosPacienteTab } from './DadosPacienteTab';
import { FichaOdontologicaTab } from './FichaOdontologicaTab';
import { ArquivosTab } from './ArquivosTab';
import { EvolucoesTab } from './EvolucoesTab';
import { AnamneseTab } from './AnamneseTab';
import { InteracoesTab } from './InteracoesTab';
import { ConsultasTab } from './ConsultasTab';
import { generateOrcamentoPDF, generateAnamnesePDF } from './DentalChart';
import { cn, generateGradientColors } from '@/lib/utils';
import { OrcamentoModal } from './OrcamentoModal';
import { useWhatsAppMessages, sendWhatsAppMessage, WhatsAppMessage } from '@/hooks/useWhatsappMessages';
import { Timestamp } from 'firebase/firestore';
import { normalizePhone, generatePhoneVariants } from './utils';
import { TAB_ITEMS } from './constants';

function PatientDetailContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const patientId = searchParams.get('patientId') || '';

  const { companyId, loading: authLoading, user, userData, themePreference, customColor } = useAuth();
  
  // Criar objeto user completo para verificação de permissões
  const userWithPermissions = userData && user ? {
    uid: user.uid,
    role: userData.role,
    nome: userData.nome || user.displayName || '',
    email: userData.email || user.email || '',
    ativo: userData.ativo,
    companyId: userData.companyId || companyId || '',
    professionalId: userData.professionalId,
    permissions: userData.permissions,
  } : null;
  const { patient, loading: patientLoading, error, updatePatient } = usePatient(companyId, patientId || null);
  const { appointments, loading: appointmentsLoading } = useAppointments(companyId, { clientId: patientId || undefined });
  const { professionals, loading: professionalsLoading } = useProfessionals(companyId);
  const { services, loading: servicesLoading } = useServices(companyId);
  const {
    evolutions,
    loading: evolutionsLoading,
    addEvolution,
    updateEvolution,
    deleteEvolution,
  } = usePatientEvolutions(companyId, patientId || null);
  const { company } = useCompany(companyId);
  const isDentist = company?.tipoEstabelecimento === 'dentista';
  const {
    procedimentos: dentalProcedures,
    loading: dentalProceduresLoading,
    addProcedimento: addDentalProcedure,
    updateProcedimento: updateDentalProcedure,
    deleteProcedimento: deleteDentalProcedure,
  } = useDentalProcedures(companyId, patientId || null);
  const { createDebito } = usePatientDebits(companyId, patientId || null);
  const { orcamentos, loading: orcamentosLoading, deleteOrcamento, updateOrcamento, createOrcamento } = useOrcamentos(companyId, patientId || null);

  // Pré-carregar todas as imagens dos dentes IMEDIATAMENTE assim que a página abrir
  // useLayoutEffect executa ANTES da pintura do DOM, garantindo carregamento o mais cedo possível
  useLayoutEffect(() => {
    if (typeof document === 'undefined' || typeof window === 'undefined') return;

    // Lista de todos os números de dentes (permanentes e decíduos)
    const allTeethNumbers = [
      // Permanentes
      11, 12, 13, 14, 15, 16, 17, 18,
      21, 22, 23, 24, 25, 26, 27, 28,
      31, 32, 33, 34, 35, 36, 37, 38,
      41, 42, 43, 44, 45, 46, 47, 48,
      // Decíduos
      51, 52, 53, 54, 55,
      61, 62, 63, 64, 65,
      71, 72, 73, 74, 75,
      81, 82, 83, 84, 85,
    ];

    // Função para pré-carregar uma imagem
    const preloadImage = (imagePath: string) => {
      // Verificar se já existe link de preload
      const existingLink = document.querySelector(`link[href="${imagePath}"]`);
      if (!existingLink) {
        const link = document.createElement('link');
        link.rel = 'preload';
        link.as = 'image';
        link.href = imagePath;
        link.setAttribute('fetchpriority', 'high');
        document.head.appendChild(link);
      }

      // Criar Image object para forçar carregamento
      const img = document.createElement('img');
      img.src = imagePath;
      // Manter referência para evitar garbage collection
      (window as any).__dentalImages = (window as any).__dentalImages || [];
      (window as any).__dentalImages.push(img);
    };

    // Carregar TODAS as imagens imediatamente (sem delays, sem condições)
    allTeethNumbers.forEach((numero) => {
      const imagePath = `/images/dental-teeth/${numero}.png`;
      preloadImage(imagePath);
    });

    // Limpar referências quando desmontar
    return () => {
      if ((window as any).__dentalImages) {
        (window as any).__dentalImages = [];
      }
    };
  }, [patientId]); // Re-executar quando o patientId mudar (nova página de paciente)

  // Backup: também executar com useEffect para garantir
  useEffect(() => {
    if (typeof document === 'undefined' || typeof window === 'undefined') return;

    const allTeethNumbers = [
      11, 12, 13, 14, 15, 16, 17, 18,
      21, 22, 23, 24, 25, 26, 27, 28,
      31, 32, 33, 34, 35, 36, 37, 38,
      41, 42, 43, 44, 45, 46, 47, 48,
      51, 52, 53, 54, 55,
      61, 62, 63, 64, 65,
      71, 72, 73, 74, 75,
      81, 82, 83, 84, 85,
    ];

    // Garantir que todas as imagens sejam carregadas
    allTeethNumbers.forEach((numero) => {
      const imagePath = `/images/dental-teeth/${numero}.png`;
      const img = document.createElement('img');
      img.src = imagePath;
      // Forçar decode para garantir carregamento completo
      img.decode().catch(() => {
        // Ignorar erros de decode
      });
    });
  }, [patientId]);
  const customerLabels = useCustomerLabels();
  const singularLabel = customerLabels.singular;
  const singularTitle = customerLabels.singularTitle;
  const pluralTitle = customerLabels.pluralTitle;

  const [activeTab, setActiveTab] = useState<(typeof TAB_ITEMS)[number]['id']>('dados_paciente');
  const [selectedOrcamentoId, setSelectedOrcamentoId] = useState<string | null>(null);
  const [sendOrcamentoModal, setSendOrcamentoModal] = useState<{ orcamento: any; link: string } | null>(null);
  const [copiedLink, setCopiedLink] = useState(false);
  const [sendAnamneseModal, setSendAnamneseModal] = useState<{ anamnese: any; link: string } | null>(null);
  const [copiedAnamneseLink, setCopiedAnamneseLink] = useState(false);
  const [showAlertasModal, setShowAlertasModal] = useState(false);
  const [alertasAnamnese, setAlertasAnamnese] = useState<Array<{ anamnese: any; alertas: Array<{ secao: string; pergunta: string; resposta: string }> }>>([]);
  const [expandedOrcamentos, setExpandedOrcamentos] = useState<Set<string>>(new Set());
  const hasInitializedExpanded = useRef(false);
  
  // Expandir todos os orçamentos por padrão quando a lista é carregada pela primeira vez
  useEffect(() => {
    if (orcamentos.length > 0 && !hasInitializedExpanded.current) {
      setExpandedOrcamentos(new Set(orcamentos.map(o => o.id)));
      hasInitializedExpanded.current = true;
    }
  }, [orcamentos]);
  const [fichaData, setFichaData] = useState({
    nome: '',
    telefoneE164: '',
    email: '',
    cpf: '',
    dataNascimento: '' as string,
  });
  const [savingFicha, setSavingFicha] = useState(false);
  const [showAnamneseModal, setShowAnamneseModal] = useState(false);
  const [anamneseModelos, setAnamneseModelos] = useState<any[]>([]);
  const [anamneses, setAnamneses] = useState<any[]>([]);
  const [loadingAnamneses, setLoadingAnamneses] = useState(false);
  const [selectedModeloId, setSelectedModeloId] = useState('');
  const [selectedDentistaId, setSelectedDentistaId] = useState('');
  const [numeroCRO, setNumeroCRO] = useState('');
  const [estadoCRO, setEstadoCRO] = useState('');
  const [enviarParaPaciente, setEnviarParaPaciente] = useState(false);
  const [viewingAnamnese, setViewingAnamnese] = useState<any | null>(null);
  const [editingAnamnese, setEditingAnamnese] = useState<any | null>(null);
  const [modeloCompleto, setModeloCompleto] = useState<any | null>(null);
  const [filesLoading, setFilesLoading] = useState(false);
  const [uploadingFile, setUploadingFile] = useState(false);
  const [uploadProgress, setUploadProgress] = useState<number | null>(null);
  const [patientFiles, setPatientFiles] = useState<Array<{
    name: string;
    url: string;
    fullPath: string;
    size: number;
    contentType?: string | null;
    timeCreated?: string;
  }>>([]);
  const [newEvolutionNotes, setNewEvolutionNotes] = useState('');
  const [newEvolutionDate, setNewEvolutionDate] = useState<string>(() => new Date().toISOString().split('T')[0]);
  
  // Estados para Documentos (Receitas e Atestados)
  const [showDocumentModal, setShowDocumentModal] = useState(false);
  const [documentType, setDocumentType] = useState<'receita' | 'atestado' | null>(null);
  const [selectedProfessionalId, setSelectedProfessionalId] = useState<string>('');
  const [receitaMedicamentos, setReceitaMedicamentos] = useState<Array<{
    nome: string;
    quantidade: number;
    medida: 'ampola' | 'caixa' | 'comprimido' | 'frasco' | 'pacote' | 'tubo' | 'capsula';
    posologia: string;
    exigeControleEspecial: boolean;
    informacoesControleEspecial: string;
  }>>([]);
  const [atestadoTexto, setAtestadoTexto] = useState('');
  const [atestadoDias, setAtestadoDias] = useState<number | undefined>(undefined);
  const [atestadoDataInicio, setAtestadoDataInicio] = useState<string>('');
  const [atestadoDataFim, setAtestadoDataFim] = useState<string>('');
  const [receitas, setReceitas] = useState<any[]>([]);
  const [atestados, setAtestados] = useState<any[]>([]);
  const [loadingDocuments, setLoadingDocuments] = useState(false);
  const [selectedEvolutionFiles, setSelectedEvolutionFiles] = useState<Array<{ file: File; preview: string }>>([]);
  const [isSavingEvolution, setIsSavingEvolution] = useState(false);
  const [evolutionUploadProgress, setEvolutionUploadProgress] = useState<number | null>(null);
  const [deletingEvolutionId, setDeletingEvolutionId] = useState<string | null>(null);
  const evolutionFilesRef = useRef<Array<{ file: File; preview: string }>>([]);
  const interactionContainerRef = useRef<HTMLDivElement | null>(null);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const [newInteractionMessage, setNewInteractionMessage] = useState('');
  const [sendingInteraction, setSendingInteraction] = useState(false);
  
  // Obter o número de telefone do paciente para usar como chat_id
  const patientPhone = useMemo(() => {
    if (!patient?.telefoneE164) return null;
    // Normalizar o telefone para usar como chat_id
    return normalizePhone(patient.telefoneE164);
  }, [patient?.telefoneE164]);

  // Usar o hook de mensagens do WhatsApp
  const { messages: interactionMessages, loading: interactionLoading, loadingMore, hasMore, loadMore } = useWhatsAppMessages(
    companyId,
    patientPhone || null
  );

  // Scroll automático para a última mensagem
  const isInitialLoadRef = useRef(true);
  const previousMessagesLengthRef = useRef(0);
  
  useEffect(() => {
    if (interactionContainerRef.current) {
      const container = interactionContainerRef.current;
      
      // Se for o carregamento inicial e tiver mensagens, sempre ir para o final
      if (isInitialLoadRef.current && interactionMessages.length > 0 && !interactionLoading) {
        // Usar múltiplos timeouts para garantir que o DOM foi completamente renderizado
        setTimeout(() => {
          if (container) {
            container.scrollTop = container.scrollHeight;
          }
        }, 100);
        setTimeout(() => {
          if (container) {
            container.scrollTop = container.scrollHeight;
            isInitialLoadRef.current = false;
          }
        }, 300);
      } else if (!loadingMore && !isInitialLoadRef.current) {
        // Se for uma nova mensagem (length aumentou), scroll suave para o final
        const isNewMessage = interactionMessages.length > previousMessagesLengthRef.current;
        if (isNewMessage) {
          // Verificar se já está próximo do final (dentro de 200px)
          const scrollBottom = container.scrollHeight - container.scrollTop - container.clientHeight;
          const isNearBottom = scrollBottom < 200;
          if (isNearBottom) {
            setTimeout(() => {
              if (container) {
                container.scrollTop = container.scrollHeight;
              }
            }, 50);
          }
        }
      }
      
      previousMessagesLengthRef.current = interactionMessages.length;
    }
  }, [interactionMessages.length, interactionMessages, loadingMore, interactionLoading]);
  
  // Resetar flag de carregamento inicial quando mudar de paciente ou aba
  useEffect(() => {
    if (activeTab === 'interacoes') {
      isInitialLoadRef.current = true;
      previousMessagesLengthRef.current = 0;
      // Garantir scroll para baixo quando a aba for aberta (com delay maior para garantir renderização)
      const timeoutId = setTimeout(() => {
        if (interactionContainerRef.current) {
          interactionContainerRef.current.scrollTop = interactionContainerRef.current.scrollHeight;
        }
      }, 400);
      
      return () => clearTimeout(timeoutId);
    }
  }, [activeTab, patientPhone]);

  useEffect(() => {
    if (patient) {
      // Formatar data de nascimento para o input (YYYY-MM-DD)
      let dataNascimentoFormat = '';
      if (patient.dataNascimento) {
        try {
          let date: Date;
          if (patient.dataNascimento instanceof Date) {
            date = patient.dataNascimento;
          } else if (patient.dataNascimento && typeof patient.dataNascimento === 'object' && 'toDate' in patient.dataNascimento) {
            // Firestore Timestamp
            date = (patient.dataNascimento as any).toDate();
          } else {
            date = new Date(patient.dataNascimento);
          }
          
          // Verificar se a data é válida antes de chamar toISOString
          if (!isNaN(date.getTime())) {
            dataNascimentoFormat = date.toISOString().split('T')[0];
          }
        } catch (error) {
          console.warn('Erro ao formatar data de nascimento:', error);
          dataNascimentoFormat = '';
        }
      }
      
      setFichaData({
        nome: patient.nome || '',
        telefoneE164: patient.telefoneE164 || '',
        email: patient.email || '',
        cpf: patient.cpf || '',
        dataNascimento: dataNascimentoFormat,
      });
    }
  }, [patient?.id]); // eslint-disable-line react-hooks/exhaustive-deps

  // Carregar modelos de anamnese
  useEffect(() => {
    if (!companyId) return;
    
    const modelosQuery = query(
      collection(db, `companies/${companyId}/anamneseModelos`),
      orderBy('createdAt', 'desc')
    );
    
    const unsubscribeModelos = onSnapshot(
      modelosQuery,
      (snapshot) => {
        const modelos = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setAnamneseModelos(modelos);
      },
      (err) => {
        console.error('Erro ao carregar modelos de anamnese:', err);
      }
    );
    
    return () => unsubscribeModelos();
  }, [companyId]);

  // Carregar anamneses do paciente
  useEffect(() => {
    if (!companyId || !patientId) {
      setAnamneses([]);
      return;
    }
    
    setLoadingAnamneses(true);
    const anamnesesQuery = query(
      collection(db, `companies/${companyId}/patients/${patientId}/anamneses`),
      orderBy('createdAt', 'desc')
    );
    
    const unsubscribeAnamneses = onSnapshot(
      anamnesesQuery,
      (snapshot) => {
        const anamnesesData = snapshot.docs.map(doc => {
          const data = doc.data();
          return {
            id: doc.id,
            ...data,
            createdAt: data.createdAt?.toDate() || new Date(),
            updatedAt: data.updatedAt?.toDate() || new Date()
          };
        });
        setAnamneses(anamnesesData);
        setLoadingAnamneses(false);
      },
      (err) => {
        console.error('Erro ao carregar anamneses:', err);
        setLoadingAnamneses(false);
      }
    );
    
    return () => unsubscribeAnamneses();
  }, [companyId, patientId]);

  // Calcular alertas das anamneses
  useEffect(() => {
    const calcularAlertas = async () => {
      if (!companyId || !anamneses.length || !anamneseModelos.length) {
        setAlertasAnamnese([]);
        return;
      }

      const alertas: Array<{ anamnese: any; alertas: Array<{ secao: string; pergunta: string; resposta: string }> }> = [];

      for (const anamnese of anamneses) {
        // Só processar anamneses preenchidas (com respostas)
        if (!anamnese.respostas || Object.keys(anamnese.respostas).length === 0) {
          continue;
        }

        // Buscar o modelo da anamnese
        const modelo = anamneseModelos.find((m: any) => m.id === anamnese.modeloId);
        if (!modelo || !modelo.secoes) {
          continue;
        }

        const alertasAnamnese: Array<{ secao: string; pergunta: string; resposta: string }> = [];

        // Processar cada seção do modelo
        for (const secao of modelo.secoes) {
          if (!secao.perguntas) continue;

          // Processar cada pergunta
          for (const pergunta of secao.perguntas) {
            // Verificar se a pergunta gera alerta
            if (!pergunta.geraAlerta) continue;

            const respostaKey = `${secao.id}-${pergunta.id}`;
            const resposta = anamnese.respostas[respostaKey];

            if (!resposta) continue;

            // Verificar se a resposta gera alerta
            // Para perguntas sim/não, alerta quando resposta é "sim"
            // Para perguntas sim/não com texto, alerta quando resposta é "sim"
            // Para perguntas de texto, sempre alerta se tiver resposta
            let geraAlerta = false;
            let textoResposta = '';

            if (pergunta.tipoResposta === 'sim_nao') {
              if (resposta.resposta === 'sim') {
                geraAlerta = true;
                textoResposta = 'Sim';
              }
            } else if (pergunta.tipoResposta === 'sim_nao_texto') {
              if (resposta.resposta === 'sim') {
                geraAlerta = true;
                if (resposta.texto && resposta.texto.trim()) {
                  textoResposta = `Sim / ${resposta.texto}`;
                } else {
                  textoResposta = 'Sim';
                }
              }
            } else if (pergunta.tipoResposta === 'texto') {
              if (resposta.texto && resposta.texto.trim()) {
                geraAlerta = true;
                textoResposta = resposta.texto;
              }
            }

            if (geraAlerta) {
              alertasAnamnese.push({
                secao: secao.nome,
                pergunta: pergunta.pergunta,
                resposta: textoResposta
              });
            }
          }
        }

        if (alertasAnamnese.length > 0) {
          alertas.push({
            anamnese: anamnese,
            alertas: alertasAnamnese
          });
        }
      }

      setAlertasAnamnese(alertas);
    };

    calcularAlertas();
  }, [companyId, anamneses, anamneseModelos]);

  // Calcular total de alertas
  const totalAlertas = useMemo(() => {
    return alertasAnamnese.reduce((total, item) => total + item.alertas.length, 0);
  }, [alertasAnamnese]);

  useEffect(() => {
    evolutionFilesRef.current = selectedEvolutionFiles;
  }, [selectedEvolutionFiles]);

  useEffect(() => () => {
    evolutionFilesRef.current.forEach((item) => URL.revokeObjectURL(item.preview));
  }, []);

  // Função para obter o texto da mensagem
  const getMessageText = (message: WhatsAppMessage): string => {
    if (message.message?.text?.body) {
      return message.message.text.body;
    }
    if (message.message?.body) {
      return message.message.body;
    }
    if (message.message?.type === 'text') {
      return message.message.text || '';
    }
    // Para mensagens de mídia, retornar caption se houver
    if (message.message?.type === 'image' && message.message?.imageMessage?.caption) {
      return message.message.imageMessage.caption;
    }
    if (message.message?.type === 'video' && message.message?.videoMessage?.caption) {
      return message.message.videoMessage.caption;
    }
    return '[Mensagem não suportada]';
  };

  // Obter tipo de mídia e URL
  const getMediaInfo = (message: WhatsAppMessage): { type: string; url: string; mimetype?: string } | null => {
    const mediaUrl = message.message?.mediaUrl || (message as any).mediaUrl;
    const messageType = message.message?.type;
    
    if (!mediaUrl) return null;
    
    return {
      type: messageType || 'unknown',
      url: mediaUrl,
      mimetype: message.message?.mimetype || (message as any).mediaMimetype,
    };
  };

  // Renderizar mídia
  const renderMedia = (mediaInfo: { type: string; url: string; mimetype?: string }, message: WhatsAppMessage, isInbound: boolean) => {
    const { type, url, mimetype } = mediaInfo;
    
    if (type === 'image' || mimetype?.startsWith('image/')) {
      return (
        <div className="mb-2 rounded-lg overflow-hidden">
          <img
            src={url}
            alt="Imagem"
            className="max-w-[200px] md:max-w-[250px] h-auto rounded-lg cursor-pointer hover:opacity-90 transition-opacity"
            onClick={() => window.open(url, '_blank')}
            onError={(e) => {
              (e.target as HTMLImageElement).style.display = 'none';
            }}
          />
        </div>
      );
    }
    
    if (type === 'video' || mimetype?.startsWith('video/')) {
      return (
        <div className="mb-2 rounded-lg overflow-hidden">
          <video
            src={url}
            controls
            className="max-w-full h-auto rounded-lg"
            onError={(e) => {
              const target = e.target as HTMLVideoElement;
              target.style.display = 'none';
            }}
          >
            Seu navegador não suporta vídeo.
          </video>
        </div>
      );
    }
    
    if (type === 'audio' || mimetype?.startsWith('audio/')) {
      return (
        <div className="mb-2 rounded-lg overflow-hidden bg-slate-100 p-3">
          <div className="flex items-center gap-3">
            <Music className="w-6 h-6 text-slate-600" />
            <audio
              src={url}
              controls
              className="flex-1"
              onError={(e) => {
                const target = e.target as HTMLAudioElement;
                target.style.display = 'none';
              }}
            >
              Seu navegador não suporta áudio.
            </audio>
          </div>
        </div>
      );
    }
    
    if (type === 'document' || mimetype?.startsWith('application/')) {
      const fileName = (message as any).message?.documentMessage?.fileName || 'Documento';
      return (
        <div className="mb-2 rounded-lg overflow-hidden bg-slate-100 p-3">
          <a
            href={url}
            target="_blank"
            rel="noopener noreferrer"
            className="flex items-center gap-3 hover:opacity-80 transition-opacity"
          >
            <FileText className="w-6 h-6 text-slate-600 flex-shrink-0" />
            <div className="flex-1 min-w-0">
              <p className="text-sm font-medium text-slate-900 truncate">{fileName}</p>
              <p className="text-xs text-slate-500">{mimetype || 'Documento'}</p>
            </div>
            <Download className="w-5 h-5 text-slate-600 flex-shrink-0" />
          </a>
        </div>
      );
    }
    
    // Fallback para tipos desconhecidos
    return (
      <div className="mb-2 rounded-lg overflow-hidden bg-slate-100 p-3">
        <a
          href={url}
          target="_blank"
          rel="noopener noreferrer"
          className="flex items-center gap-3 hover:opacity-80 transition-opacity"
        >
          <FileText className="w-6 h-6 text-slate-600 flex-shrink-0" />
          <div className="flex-1 min-w-0">
            <p className="text-sm font-medium text-slate-900">Abrir mídia</p>
            <p className="text-xs text-slate-500">{mimetype || type}</p>
          </div>
          <Download className="w-5 h-5 text-slate-600 flex-shrink-0" />
        </a>
      </div>
    );
  };

  // Função para formatar data da mensagem
  const formatMessageDate = (date: Date | Timestamp | undefined): string => {
    if (!date) return '';
    
    let dateObj: Date;
    if (date instanceof Timestamp) {
      dateObj = date.toDate();
    } else if (date instanceof Date) {
      dateObj = date;
    } else {
      return '';
    }

    const now = new Date();
    const diffInSeconds = Math.floor((now.getTime() - dateObj.getTime()) / 1000);
    
    if (diffInSeconds < 60) {
      return 'agora';
    } else if (diffInSeconds < 3600) {
      const minutes = Math.floor(diffInSeconds / 60);
      return `${minutes} min atrás`;
    } else if (diffInSeconds < 86400) {
      const hours = Math.floor(diffInSeconds / 3600);
      return `${hours}h atrás`;
    } else if (diffInSeconds < 604800) {
      const days = Math.floor(diffInSeconds / 86400);
      return `${days} dia${days > 1 ? 's' : ''} atrás`;
    } else {
      return format(dateObj, 'dd/MM/yyyy HH:mm', { locale: ptBR });
    }
  };

  const professionalNameById = useMemo(() => {
    const map = new Map<string, string>();
    professionals?.forEach((professional) => {
      map.set(
        professional.id,
        professional.apelido?.trim() ? professional.apelido : 'Profissional sem nome'
      );
    });
    return map;
  }, [professionals]);

  const serviceNameById = useMemo(() => {
    const map = new Map<string, string>();
    if (services && Array.isArray(services) && services.length > 0) {
      services.forEach((service) => {
        if (service && service.id && service.nome) {
          map.set(service.id, service.nome);
        }
      });
      // Debug: log do mapeamento
      if (process.env.NODE_ENV === 'development') {
        console.log('[serviceNameById] Mapeamento criado:', {
          totalServices: services.length,
          mappedServices: map.size,
          serviceIds: Array.from(map.keys()),
          serviceNames: Array.from(map.values())
        });
      }
    } else {
      if (process.env.NODE_ENV === 'development') {
        console.log('[serviceNameById] Nenhum serviço disponível:', {
          services: services,
          isArray: Array.isArray(services),
          length: services?.length
        });
      }
    }
    return map;
  }, [services]);

  const getProfessionalLabel = (professionalId: string) => {
    if (!professionalId) return 'Não informado';
    return professionalNameById.get(professionalId) || professionalId;
  };

  const getServiceLabel = (serviceId: string) => {
    if (!serviceId || !serviceId.trim()) return 'Não informado';
    
    // Tentar encontrar o serviço no mapeamento
    const serviceName = serviceNameById.get(serviceId);
    if (serviceName) {
      return serviceName;
    }
    
    // Se não encontrou e os serviços ainda estão carregando, retornar "Carregando..."
    if (servicesLoading) {
      return 'Carregando...';
    }
    
    // Se não encontrou e os serviços já foram carregados, tentar buscar diretamente no array
    if (services && Array.isArray(services) && services.length > 0) {
      const service = services.find(s => s.id === serviceId);
      if (service && service.nome) {
        // Atualizar o mapeamento para próxima vez (mas não podemos modificar o Map diretamente aqui)
        // O useMemo vai recriar o mapa quando services mudar
        return service.nome;
      }
    }
    
    // Se não encontrou e os serviços já foram carregados, pode ser que o serviço foi deletado
    // Retornar o ID como fallback, mas isso não deveria acontecer normalmente
    if (process.env.NODE_ENV === 'development') {
      console.warn('[getServiceLabel] Serviço não encontrado:', {
        serviceId,
        totalServices: serviceNameById.size,
        servicesArrayLength: services?.length || 0,
        servicesLoaded: !servicesLoading,
        availableServiceIds: Array.from(serviceNameById.keys())
      });
    }
    
    return serviceId; // Retornar o ID como último recurso
  };

  const upcomingAppointments = useMemo(() => {
    if (!appointments) return [];
    const now = new Date();
    return [...appointments]
      .filter(appointment => appointment.inicio >= now)
      .sort((a, b) => a.inicio.getTime() - b.inicio.getTime());
  }, [appointments]);

  const pastAppointments = useMemo(() => {
    if (!appointments) return [];
    const now = new Date();
    return [...appointments]
      .filter(appointment => appointment.inicio < now)
      .sort((a, b) => b.inicio.getTime() - a.inicio.getTime());
  }, [appointments]);

  const sortedEvolutions = useMemo(() => {
    return [...(evolutions ?? [])].sort((a, b) => {
      const diff = b.date.getTime() - a.date.getTime();
      if (diff !== 0) {
        return diff;
      }
      return b.createdAt.getTime() - a.createdAt.getTime();
    });
  }, [evolutions]);

  const [imageDimensions, setImageDimensions] = useState<Record<string, { width: number; height: number }>>({});

  const galleryImages = useMemo(
    () =>
      sortedEvolutions.flatMap((evolution) =>
        evolution.images.map((image) => ({
          evolutionId: evolution.id,
          url: image.url,
          name: image.name,
          notes: evolution.notes,
          date: evolution.date,
          storagePath: image.storagePath,
        }))
      ),
    [sortedEvolutions]
  );

  useEffect(() => {
    const pending = galleryImages.filter((image) => !imageDimensions[image.storagePath]);
    pending.forEach((image) => {
      const img = document.createElement('img');
      img.src = image.url;
      img.decode?.().catch(() => undefined);
      img.onload = () => {
        const naturalWidth = img.naturalWidth || 1200;
        const naturalHeight = img.naturalHeight || 1200;
        setImageDimensions((prev) => {
          if (prev[image.storagePath]) return prev;
          return {
            ...prev,
            [image.storagePath]: { width: naturalWidth, height: naturalHeight },
          };
        });
      };
      img.onerror = () => {
        setImageDimensions((prev) => {
          if (prev[image.storagePath]) return prev;
          return {
            ...prev,
            [image.storagePath]: { width: 1200, height: 1200 },
          };
        });
      };
    });
  }, [galleryImages, imageDimensions]);

  const WEEKDAY_MAP: Record<string, string> = {
    segunda: 'Segunda-feira',
    terça: 'Terça-feira',
    quarta: 'Quarta-feira',
    quinta: 'Quinta-feira',
    sexta: 'Sexta-feira',
    sábado: 'Sábado',
    domingo: 'Domingo',
  };

  const formatDateTime = (date: Date) => {
    const formatter = new Intl.DateTimeFormat('pt-BR', {
      weekday: 'long',
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
    const parts = formatter.formatToParts(date);
    const weekdayPart = parts.find((part) => part.type === 'weekday');
    const weekday = weekdayPart
      ? WEEKDAY_MAP[weekdayPart.value.toLowerCase()] || weekdayPart.value
      : '';
    const rest = parts
      .filter((part) => part.type !== 'weekday')
      .map((part) => part.value)
      .join('')
      .replace(/^\s*,\s*/, '') // remove leading comma if present
      .trim();
    return weekday ? `${rest} (${weekday})` : rest;
  };

  const formatEvolutionDate = (date: Date) => {
    return new Intl.DateTimeFormat('pt-BR', {
      day: '2-digit',
      month: 'long',
      year: 'numeric',
    }).format(date);
  };

  const handleSaveFicha = async (event: React.FormEvent) => {
    event.preventDefault();
    if (!companyId || !patientId) return;
    try {
      setSavingFicha(true);
      // Converter dataNascimento de string para Date se fornecido
      // Usar startOfDay para garantir que a data seja meia-noite na timezone local, não UTC
      const patientData = {
        nome: fichaData.nome,
        telefoneE164: fichaData.telefoneE164,
        email: fichaData.email,
        cpf: fichaData.cpf || undefined,
        dataNascimento: fichaData.dataNascimento ? startOfDay(new Date(fichaData.dataNascimento + 'T00:00:00')) : undefined,
      };
      await updatePatient(patientData);
      showSuccess('Ficha clínica atualizada com sucesso.');
    } catch (err) {
      console.error(err);
      showError('Erro ao atualizar ficha clínica.');
    } finally {
      setSavingFicha(false);
    }
  };


  const ESTADOS_BRASIL = [
    'AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA',
    'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN',
    'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'
  ];

  const handleCriarAnamnese = async () => {
    if (!companyId || !patientId) return;
    
    if (!selectedModeloId) {
      showError('Selecione um modelo de anamnese');
      return;
    }
    
    if (!selectedDentistaId) {
      showError('Selecione o responsável');
      return;
    }
    
    if (!numeroCRO.trim()) {
      showError('Digite o número do CRO');
      return;
    }
    
    if (!estadoCRO) {
      showError('Selecione o estado do CRO');
      return;
    }
    
    try {
      const modeloSelecionado = anamneseModelos.find((m: any) => m.id === selectedModeloId);
      
      // Se for enviar para o paciente, gerar token e link
      let signatureToken = null;
      let signatureLink = null;
      
      if (enviarParaPaciente) {
        // Gerar token único usando crypto
        const array = new Uint8Array(32);
        crypto.getRandomValues(array);
        signatureToken = Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        
        // Gerar link de assinatura
        const baseUrl = typeof window !== 'undefined' ? window.location.origin : 'https://webagendamentos.web.app';
        signatureLink = `${baseUrl}/assinatura-anamnese/?token=${signatureToken}&companyId=${companyId}&patientId=${patientId}`;
      }
      
      const anamneseData: any = {
        modeloId: selectedModeloId,
        modeloNome: modeloSelecionado?.nome || '',
        dentistaId: selectedDentistaId,
        numeroCRO: numeroCRO.trim(),
        estadoCRO: estadoCRO,
        enviarParaPaciente: enviarParaPaciente,
        status: enviarParaPaciente ? 'pendente' : 'rascunho',
        createdAt: Timestamp.now(),
        updatedAt: Timestamp.now()
      };
      
      // Adicionar token e link apenas se for enviar para o paciente
      if (enviarParaPaciente && signatureToken && signatureLink) {
        anamneseData.signatureToken = signatureToken;
        anamneseData.signatureLink = signatureLink;
        // Inicializar respostas vazias para o paciente preencher
        anamneseData.respostas = {};
      }
      
      const docRef = await addDoc(collection(db, `companies/${companyId}/patients/${patientId}/anamneses`), anamneseData);
      
      // Se for enviar para o paciente, mostrar modal com link
      if (enviarParaPaciente && signatureLink) {
        setSendAnamneseModal({ anamnese: { id: docRef.id, ...anamneseData }, link: signatureLink });
        setCopiedAnamneseLink(false);
      } else {
        showSuccess('Anamnese criada com sucesso!');
      }
      
      setShowAnamneseModal(false);
      setSelectedModeloId('');
      setSelectedDentistaId('');
      setNumeroCRO('');
      setEstadoCRO('');
      setEnviarParaPaciente(false);
    } catch (error) {
      console.error('Erro ao criar anamnese:', error);
      showError('Erro ao criar anamnese. Tente novamente.');
    }
  };

  const handleVerAnamnese = async (anamnese: any) => {
    if (!companyId) return;
    
    try {
      // Carregar o modelo completo
      const modeloDoc = doc(db, `companies/${companyId}/anamneseModelos/${anamnese.modeloId}`);
      const modeloSnap = await getDoc(modeloDoc);
      
      if (modeloSnap.exists()) {
        const modeloData = modeloSnap.data();
        setModeloCompleto({
          id: modeloSnap.id,
          ...modeloData,
          secoes: (modeloData.secoes || []).map((sec: any) => ({
            ...sec,
            perguntas: (sec.perguntas || []).map((p: any) => ({
              ...p
            }))
          }))
        });
      }
      
      setViewingAnamnese(anamnese);
    } catch (error) {
      console.error('Erro ao carregar modelo:', error);
      showError('Erro ao carregar anamnese.');
    }
  };

  const handleEditarAnamnese = async (anamnese: any) => {
    if (!companyId) return;
    
    try {
      // Carregar o modelo completo
      const modeloDoc = doc(db, `companies/${companyId}/anamneseModelos/${anamnese.modeloId}`);
      const modeloSnap = await getDoc(modeloDoc);
      
      if (modeloSnap.exists()) {
        const modeloData = modeloSnap.data();
        const modeloCompletoData = {
          id: modeloSnap.id,
          ...modeloData,
          secoes: (modeloData.secoes || []).map((sec: any) => ({
            ...sec,
            perguntas: (sec.perguntas || []).map((p: any) => ({
              ...p
            }))
          }))
        };
        
        // Inicializar respostas se não existirem
        const respostas = anamnese.respostas || {};
        
        setModeloCompleto(modeloCompletoData);
        setEditingAnamnese({ ...anamnese, respostas });
      } else {
        showError('Modelo de anamnese não encontrado');
      }
    } catch (error) {
      console.error('Erro ao carregar modelo:', error);
      showError('Erro ao carregar anamnese para edição.');
    }
  };

  const handleSalvarRespostasAnamnese = async () => {
    if (!companyId || !patientId || !editingAnamnese) return;
    
    try {
      await updateDoc(doc(db, `companies/${companyId}/patients/${patientId}/anamneses/${editingAnamnese.id}`), {
        respostas: editingAnamnese.respostas || {},
        status: 'preenchida',
        updatedAt: Timestamp.now()
      });
      
      showSuccess('Respostas da anamnese salvas com sucesso!');
      setEditingAnamnese(null);
      setModeloCompleto(null);
    } catch (error) {
      console.error('Erro ao salvar respostas:', error);
      showError('Erro ao salvar respostas. Tente novamente.');
    }
  };

  const atualizarResposta = (secaoId: string, perguntaId: string, resposta: any) => {
    if (!editingAnamnese) return;
    
    const respostas = editingAnamnese.respostas || {};
    const key = `${secaoId}-${perguntaId}`;
    
    setEditingAnamnese({
      ...editingAnamnese,
      respostas: {
        ...respostas,
        [key]: resposta
      }
    });
  };

  const handleDownloadAnamnesePDF = async (anamnese: any) => {
    if (!companyId || !patientId || !anamnese || !company || !patient) {
      showError('Dados da anamnese não encontrados');
      return;
    }

    try {
      // Carregar o modelo completo
      const modeloDoc = doc(db, `companies/${companyId}/anamneseModelos/${anamnese.modeloId}`);
      const modeloSnap = await getDoc(modeloDoc);
      
      if (!modeloSnap.exists()) {
        showError('Modelo de anamnese não encontrado');
        return;
      }

      const modeloData = modeloSnap.data();
      const modeloCompletoData = {
        id: modeloSnap.id,
        nome: modeloData.nome || '',
        ...modeloData,
        secoes: (modeloData.secoes || []).map((sec: any) => ({
          ...sec,
          perguntas: (sec.perguntas || []).map((p: any) => ({
            ...p
          }))
        }))
      };

      // Obter imagem da assinatura em base64 se disponível
      let signatureBase64: string | null = null;
      if (anamnese.signatureImageUrl) {
        try {
          const urlObj = new URL(anamnese.signatureImageUrl);
          let pathMatch = urlObj.pathname.match(/\/o\/(.+?)(\?|$)/);
          if (pathMatch) {
            const storagePath = decodeURIComponent(pathMatch[1]);
            
            const getSignatureImageBase64 = httpsCallable(functions, 'getSignatureImageBase64');
            const result = await getSignatureImageBase64({ storagePath });
            const data = result.data as { base64: string };
            
            if (data && data.base64) {
              signatureBase64 = data.base64;
            }
          }
        } catch (cloudFunctionError) {
          console.warn('Erro ao obter imagem via Cloud Function:', cloudFunctionError);
          // Se falhar, tentar usar canvas
          try {
            const imgElement = document.querySelector(`img[src="${anamnese.signatureImageUrl}"]`) as HTMLImageElement;
            if (imgElement && imgElement.complete) {
              const canvas = document.createElement('canvas');
              canvas.width = imgElement.naturalWidth || imgElement.width;
              canvas.height = imgElement.naturalHeight || imgElement.height;
              const ctx = canvas.getContext('2d');
              if (ctx) {
                ctx.drawImage(imgElement, 0, 0);
                signatureBase64 = canvas.toDataURL('image/png');
              }
            }
          } catch (canvasError) {
            console.warn('Erro ao converter imagem via canvas:', canvasError);
          }
        }
      }

      // Converter signedAt para Date se necessário
      let signedAtDate: Date | null = null;
      if (anamnese.signedAt) {
        if (anamnese.signedAt instanceof Date) {
          signedAtDate = anamnese.signedAt;
        } else if (typeof anamnese.signedAt === 'string') {
          const date = new Date(anamnese.signedAt);
          signedAtDate = !isNaN(date.getTime()) ? date : null;
        } else if (anamnese.signedAt.toDate) {
          signedAtDate = anamnese.signedAt.toDate();
        } else if (anamnese.signedAt.seconds) {
          signedAtDate = new Date(anamnese.signedAt.seconds * 1000);
        }
      }

      // Gerar PDF
      await generateAnamnesePDF(
        company,
        patient,
        modeloCompletoData,
        anamnese.respostas || {},
        signatureBase64 || anamnese.signatureImageUrl,
        anamnese.signedBy,
        signedAtDate
      );
    } catch (error) {
      console.error('Erro ao gerar PDF:', error);
      showError('Erro ao gerar PDF. Por favor, tente novamente.');
    }
  };

  const formatFileSize = (bytes: number) => {
    if (!bytes) return '0 B';
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    const exponent = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), units.length - 1);
    return `${(bytes / Math.pow(1024, exponent)).toFixed(exponent === 0 ? 0 : 1)} ${units[exponent]}`;
  };

  const loadPatientFiles = useCallback(async () => {
    if (!companyId || !patientId) return;
    setFilesLoading(true);
    try {
      const baseRef = ref(storage, `companies/${companyId}/patients/${patientId}`);
      const result = await listAll(baseRef);
      const fileEntries = await Promise.all(
        result.items.map(async (itemRef) => {
          const [metadata, url] = await Promise.all([getMetadata(itemRef), getDownloadURL(itemRef)]);
          return {
            name: metadata.name || itemRef.name,
            fullPath: itemRef.fullPath,
            url,
            size: metadata.size ? Number(metadata.size) : 0,
            contentType: metadata.contentType,
            timeCreated: metadata.timeCreated,
          };
        })
      );
      fileEntries.sort((a, b) => {
        const aTime = a.timeCreated ? new Date(a.timeCreated).getTime() : 0;
        const bTime = b.timeCreated ? new Date(b.timeCreated).getTime() : 0;
        return bTime - aTime;
      });
      setPatientFiles(fileEntries);
    } catch (err: any) {
      console.error('[Paciente][Arquivos] Erro ao buscar arquivos:', err);
      if (err?.code === 'storage/retry-limit-exceeded') {
        showError('Não foi possível acessar o Storage no momento. Verifique sua conexão e tente novamente.');
      } else {
        showError(`Não foi possível carregar os arquivos do ${singularLabel}.`);
      }
    } finally {
      setFilesLoading(false);
    }
  }, [companyId, patientId, singularLabel]);

  useEffect(() => {
    if (activeTab === 'arquivos') {
      loadPatientFiles();
    }
  }, [activeTab, loadPatientFiles]);

  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    if (!companyId || !patientId) return;
    const file = event.target.files?.[0];
    if (!file) return;
    const sanitizedName = file.name.replace(/\s+/g, '_').replace(/[^\w.\-]/g, '');
    const storagePath = `companies/${companyId}/patients/${patientId}/${Date.now()}-${sanitizedName}`;
    const fileRef = ref(storage, storagePath);

    setUploadingFile(true);
    setUploadProgress(0);

    const metadata = {
      customMetadata: {
        originalName: file.name,
        uploadedAt: new Date().toISOString(),
        uploadedBy: patient?.nome || 'usuário',
      },
    };

    const uploadTask = uploadBytesResumable(fileRef, file, metadata);

    try {
      await new Promise<void>((resolve, reject) => {
        uploadTask.on(
          'state_changed',
          (snapshot) => {
            const progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
            setUploadProgress(progress);
          },
          (error) => {
            reject(error);
          },
          () => resolve()
        );
      });
      await loadPatientFiles();
      setUploadProgress(100);
      showSuccess('Arquivo enviado com sucesso!');
    } catch (err) {
      console.error('[Paciente][Arquivos] Falha no upload:', err);
      showError('Erro ao enviar arquivo.');
    } finally {
      setUploadingFile(false);
      setUploadProgress(null);
      if (event.target) {
        event.target.value = '';
      }
    }
  };

  const handleDeleteFile = async (fullPath: string) => {
    if (!companyId || !patientId) return;
    if (!confirm('Deseja remover este arquivo?')) return;

    try {
      await deleteObject(ref(storage, fullPath));
      showSuccess('Arquivo removido com sucesso.');
      await loadPatientFiles();
    } catch (err) {
      console.error('[Paciente][Arquivos] Erro ao excluir arquivo:', err);
      showError('Não foi possível remover o arquivo.');
    }
  };

  const handleEvolutionFilesChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    const files = event.target.files;
    if (!files || files.length === 0) return;

    const entries = Array.from(files).map((file) => ({
      file,
      preview: URL.createObjectURL(file),
    }));

    setSelectedEvolutionFiles((prev) => [...prev, ...entries]);
    event.target.value = '';
  };

  const handleRemoveEvolutionFile = (index: number) => {
    setSelectedEvolutionFiles((prev) => {
      const copy = [...prev];
      const [removed] = copy.splice(index, 1);
      if (removed) {
        URL.revokeObjectURL(removed.preview);
      }
      return copy;
    });
  };

  const clearSelectedEvolutionFiles = () => {
    evolutionFilesRef.current.forEach((item) => URL.revokeObjectURL(item.preview));
    evolutionFilesRef.current = [];
    setSelectedEvolutionFiles([]);
  };

  const handleSendInteractionMessage = async (event?: React.FormEvent<HTMLFormElement>) => {
    event?.preventDefault();
    if (!companyId) {
      showError('Empresa não identificada.');
      return;
    }
    if (!patient?.telefoneE164) {
      showError(`${singularTitle} sem telefone cadastrado.`);
      return;
    }
    if (!newInteractionMessage.trim()) {
      showError('Digite uma mensagem antes de enviar.');
      return;
    }

    if (!patientPhone || !companyId) {
      showError(`${singularTitle} sem telefone cadastrado.`);
      return;
    }

    try {
      setSendingInteraction(true);
      await sendWhatsAppMessage(companyId, patientPhone, newInteractionMessage.trim());
      setNewInteractionMessage('');
      showSuccess('Mensagem enviada com sucesso.');
    } catch (error: any) {
      console.error('[Paciente][Interações] Erro ao enviar mensagem:', error);
      const message =
        error?.message ||
        error?.data?.message ||
        'Não foi possível enviar a mensagem. Verifique a conexão e tente novamente.';
      showError(message);
    } finally {
      setSendingInteraction(false);
    }
  };

  const handleSendOrcamento = async (orcamento: any) => {
    if (!companyId || !patientId || !orcamento) {
      showError('Dados do orçamento não encontrados');
      return;
    }

    try {
      // Gerar token único se ainda não existir
      let token = orcamento.signatureToken;
      if (!token) {
        // Gerar token único usando crypto
        const array = new Uint8Array(32);
        crypto.getRandomValues(array);
        token = Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
      }

      // Sempre gerar link no formato novo (com query parameters)
      const baseUrl = typeof window !== 'undefined' ? window.location.origin : 'https://webagendamentos.web.app';
      const signatureLink = `${baseUrl}/assinatura-orcamento/?token=${token}&companyId=${companyId}&patientId=${patientId}`;
      
      // Atualizar orçamento com token e link (se necessário)
      if (!orcamento.signatureToken || orcamento.signatureLink !== signatureLink) {
        await updateOrcamento(orcamento.id, {
          signatureToken: token,
          signatureLink,
        } as any);
      }
      
      setSendOrcamentoModal({ orcamento, link: signatureLink });
      setCopiedLink(false);
    } catch (error: any) {
      console.error('Erro ao gerar link de assinatura:', error);
      showError('Erro ao gerar link de assinatura. Por favor, tente novamente.');
    }
  };

  const handlePrintOrcamento = async (orcamento: any) => {
    if (!orcamento || !company || !patient) {
      showError('Dados do orçamento não encontrados');
      return;
    }

    try {
      // Converter procedimentos do orçamento para o formato esperado pela função
      const procedimentos = orcamento.procedimentos.map((proc: any) => ({
        id: proc.id || '',
        procedimento: proc.procedimento,
        valorCentavos: proc.valorCentavos,
        valorCentavosEditado: proc.valorCentavosEditado,
        dentes: proc.dentes || [],
        selectionTypes: proc.selectionTypes || [],
      }));

      // Converter desconto
      const desconto = orcamento.descontoCentavos 
        ? (orcamento.descontoCentavos / 100).toFixed(2).replace('.', ',')
        : '0,00';

      // Se houver imagem da assinatura, obter via Cloud Function (evita CORS)
      let signatureBase64: string | null = null;
      if (orcamento.signatureImageUrl) {
        try {
          // Extrair o caminho do Storage da URL
          const urlObj = new URL(orcamento.signatureImageUrl);
          let pathMatch = urlObj.pathname.match(/\/o\/(.+?)(\?|$)/);
          if (pathMatch) {
            const storagePath = decodeURIComponent(pathMatch[1]);
            console.log('Obtendo imagem via Cloud Function, caminho:', storagePath);
            
            // Chamar Cloud Function para obter a imagem como base64
            const getSignatureImageBase64 = httpsCallable(functions, 'getSignatureImageBase64');
            const result = await getSignatureImageBase64({ storagePath });
            const data = result.data as { base64: string };
            
            if (data && data.base64) {
              signatureBase64 = data.base64;
              console.log('Imagem obtida via Cloud Function, tamanho:', signatureBase64.length);
            }
          }
        } catch (cloudFunctionError) {
          console.warn('Erro ao obter imagem via Cloud Function:', cloudFunctionError);
          // Se falhar, tentar usar canvas (pode não funcionar devido a CORS)
          try {
            const imgElement = document.querySelector(`img[src="${orcamento.signatureImageUrl}"]`) as HTMLImageElement;
            if (imgElement && imgElement.complete) {
              const canvas = document.createElement('canvas');
              canvas.width = imgElement.naturalWidth || imgElement.width;
              canvas.height = imgElement.naturalHeight || imgElement.height;
              const ctx = canvas.getContext('2d');
              if (ctx) {
                ctx.drawImage(imgElement, 0, 0);
                signatureBase64 = canvas.toDataURL('image/png');
                console.log('Imagem convertida via canvas (fallback)');
              }
            }
          } catch (canvasError) {
            console.warn('Erro ao converter imagem via canvas:', canvasError);
          }
        }
      }

      // Gerar PDF com a função existente
      await generateOrcamentoPDF(
        company,
        patient,
        procedimentos,
        desconto,
        orcamento.observacoes || '',
        signatureBase64 || orcamento.signatureImageUrl, // Passar base64 se disponível, senão URL
        orcamento.signedBy, // Adicionar nome de quem assinou
        orcamento.signedAt // Adicionar data da assinatura
      );
      
      showSuccess('PDF gerado com sucesso!');
    } catch (error) {
      console.error('Erro ao gerar PDF:', error);
      showError('Erro ao gerar PDF. Por favor, tente novamente.');
    }
  };

  const handleCopyLink = async () => {
    if (!sendOrcamentoModal) return;
    
    try {
      await navigator.clipboard.writeText(sendOrcamentoModal.link);
      setCopiedLink(true);
      showSuccess('Link copiado para a área de transferência!');
      setTimeout(() => setCopiedLink(false), 2000);
    } catch (error) {
      showError('Erro ao copiar link. Por favor, tente novamente.');
    }
  };

  const handleSendViaSystem = async () => {
    if (!sendOrcamentoModal || !patient) return;

    try {
      const message = `Olá ${patient.nome}! Você recebeu um orçamento para assinatura. Acesse o link: ${sendOrcamentoModal.link}`;
      
      const callable = httpsCallable(functions, 'sendManualWhatsappMessage');
      await callable({
        companyId,
        patientId,
        phone: patient.telefoneE164,
        message,
      });
      
      showSuccess('Link enviado com sucesso!');
      setSendOrcamentoModal(null);
    } catch (error: any) {
      console.error('Erro ao enviar link:', error);
      const message =
        error?.message ||
        error?.data?.message ||
        'Não foi possível enviar o link. Verifique a conexão e tente novamente.';
      showError(message);
    }
  };

  const handleSendAnamnese = async (anamnese: any) => {
    if (!companyId || !patientId || !anamnese) {
      showError('Dados da anamnese não encontrados');
      return;
    }

    try {
      // Gerar token único se ainda não existir
      let token = anamnese.signatureToken;
      if (!token) {
        // Gerar token único usando crypto
        const array = new Uint8Array(32);
        crypto.getRandomValues(array);
        token = Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
      }

      // Sempre gerar link no formato novo (com query parameters)
      const baseUrl = typeof window !== 'undefined' ? window.location.origin : 'https://webagendamentos.web.app';
      const signatureLink = `${baseUrl}/assinatura-anamnese/?token=${token}&companyId=${companyId}&patientId=${patientId}`;
      
      // Atualizar anamnese com token e link (se necessário)
      if (!anamnese.signatureToken || anamnese.signatureLink !== signatureLink) {
        await updateDoc(doc(db, `companies/${companyId}/patients/${patientId}/anamneses/${anamnese.id}`), {
          signatureToken: token,
          signatureLink,
          updatedAt: Timestamp.now()
        });
      }
      
      setSendAnamneseModal({ anamnese: { ...anamnese, signatureToken: token, signatureLink }, link: signatureLink });
      setCopiedAnamneseLink(false);
    } catch (error: any) {
      console.error('Erro ao gerar link de assinatura:', error);
      showError('Erro ao gerar link de assinatura. Por favor, tente novamente.');
    }
  };

  const handleCopyAnamneseLink = async () => {
    if (!sendAnamneseModal) return;
    
    try {
      await navigator.clipboard.writeText(sendAnamneseModal.link);
      setCopiedAnamneseLink(true);
      showSuccess('Link copiado para a área de transferência!');
      setTimeout(() => setCopiedAnamneseLink(false), 2000);
    } catch (error) {
      showError('Erro ao copiar link. Por favor, tente novamente.');
    }
  };

  const handleSendAnamneseViaSystem = async () => {
    if (!sendAnamneseModal || !patient) return;

    try {
      const message = `Olá ${patient.nome}! Você recebeu uma anamnese para preenchimento e assinatura. Acesse o link: ${sendAnamneseModal.link}`;
      
      const callable = httpsCallable(functions, 'sendManualWhatsappMessage');
      await callable({
        companyId,
        patientId,
        phone: patient.telefoneE164,
        message,
      });
      
      showSuccess('Link enviado com sucesso!');
      setSendAnamneseModal(null);
    } catch (error: any) {
      console.error('Erro ao enviar link:', error);
      const message =
        error?.message ||
        error?.data?.message ||
        'Não foi possível enviar o link. Verifique a conexão e tente novamente.';
      showError(message);
    }
  };

  const handleDeleteAnamnese = async (anamnese: any) => {
    if (!companyId || !patientId || !anamnese?.id) {
      showError('Dados da anamnese não encontrados');
      return;
    }

    const confirmar = window.confirm(
      `Tem certeza que deseja excluir a anamnese "${anamnese.modeloNome || 'Anamnese'}"?\n\nEsta ação não pode ser desfeita.`
    );

    if (!confirmar) return;

    try {
      await deleteDoc(doc(db, `companies/${companyId}/patients/${patientId}/anamneses/${anamnese.id}`));
      showSuccess('Anamnese excluída com sucesso!');
    } catch (error: any) {
      console.error('Erro ao excluir anamnese:', error);
      const message =
        error?.message ||
        'Não foi possível excluir a anamnese. Por favor, tente novamente.';
      showError(message);
    }
  };

  const handleCreateEvolution = async (event: React.FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    if (!companyId || !patientId) {
      showError(`Empresa ou ${singularLabel} não encontrado.`);
      return;
    }

    if (!newEvolutionNotes.trim()) {
      showError('Descreva a evolução antes de salvar.');
      return;
    }

    if (!newEvolutionDate) {
      showError('Selecione a data da evolução.');
      return;
    }

    const date = new Date(`${newEvolutionDate}T12:00:00`);
    if (Number.isNaN(date.getTime())) {
      showError('Data da evolução inválida.');
      return;
    }

    setIsSavingEvolution(true);
    setEvolutionUploadProgress(null);

    try {
      const evolutionId = await addEvolution({
        date,
        notes: newEvolutionNotes.trim(),
        images: [],
        createdByUid: user?.uid ?? null,
      });

      if (selectedEvolutionFiles.length > 0) {
        const uploadedImages: PatientEvolution['images'] = [];

        for (let index = 0; index < selectedEvolutionFiles.length; index += 1) {
          const { file } = selectedEvolutionFiles[index];
          const sanitizedName = file.name.replace(/\s+/g, '_').replace(/[^\w.\-]/g, '');
          const storagePath = `companies/${companyId}/patients/${patientId}/evolutions/${evolutionId}/${Date.now()}-${sanitizedName}`;
          const fileRef = ref(storage, storagePath);

          const metadata = {
            customMetadata: {
              originalName: file.name,
              uploadedAt: new Date().toISOString(),
              uploadedBy: user?.uid || 'usuário',
            },
            contentType: file.type || undefined,
          };

          await new Promise<void>((resolve, reject) => {
            const uploadTask = uploadBytesResumable(fileRef, file, metadata);
            uploadTask.on(
              'state_changed',
              (snapshot) => {
                const progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                const totalProgress = Math.round(((index + progress / 100) / selectedEvolutionFiles.length) * 100);
                setEvolutionUploadProgress(totalProgress);
              },
              (error) => reject(error),
              () => resolve()
            );
          });

          const url = await getDownloadURL(fileRef);
          uploadedImages.push({
            url,
            storagePath,
            name: file.name,
            size: file.size,
            contentType: file.type || undefined,
            uploadedAt: new Date(),
          });
        }

        await updateEvolution(evolutionId, { images: uploadedImages });
      }

      showSuccess('Evolução registrada com sucesso.');
      setNewEvolutionNotes('');
      setNewEvolutionDate(new Date().toISOString().split('T')[0]);
      clearSelectedEvolutionFiles();
    } catch (err) {
      console.error('[Paciente][Evoluções] Erro ao salvar evolução:', err);
      showError('Não foi possível salvar a evolução.');
    } finally {
      setIsSavingEvolution(false);
      setEvolutionUploadProgress(null);
    }
  };

  const handleDeleteEvolution = async (evolution: PatientEvolution) => {
    if (!companyId || !patientId) {
      showError(`Empresa ou ${singularLabel} não encontrado.`);
      return;
    }

    const confirmed = window.confirm('Deseja remover esta evolução?');
    if (!confirmed) return;

    setDeletingEvolutionId(evolution.id);

    try {
      if (Array.isArray(evolution.images)) {
        for (const image of evolution.images) {
          if (image.storagePath) {
            try {
              await deleteObject(ref(storage, image.storagePath));
            } catch (storageErr) {
              console.warn('[Paciente][Evoluções] Falha ao remover imagem do Storage:', storageErr);
            }
          }
        }
      }

      await deleteEvolution(evolution.id);
      showSuccess('Evolução removida com sucesso.');
    } catch (err) {
      console.error('[Paciente][Evoluções] Erro ao remover evolução:', err);
      showError('Não foi possível remover a evolução.');
    } finally {
      setDeletingEvolutionId(null);
    }
  };

  if (!patientId) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <p className="text-gray-600">{singularTitle} não encontrado.</p>
      </div>
    );
  }

  if (authLoading || patientLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-primary" />
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <Card className="max-w-md w-full">
          <CardContent className="py-8 text-center space-y-3">
            <p className="text-red-600 font-semibold">Erro ao carregar {singularLabel}.</p>
            <p className="text-sm text-gray-600">{error}</p>
            <Button onClick={() => router.push('/pacientes')} variant="outline">
              Voltar
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (!patient) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <Card className="max-w-md w-full">
          <CardContent className="py-8 text-center space-y-3">
            <p className="text-gray-700 font-semibold">{singularTitle} não encontrado.</p>
            <Button onClick={() => router.push('/pacientes')} variant="outline">
              Voltar
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Detectar tema e gerar estilos dinâmicos
  const isVibrant = themePreference === 'vibrant';
  const isCustom = themePreference === 'custom' && customColor;
  const hasGradient = isVibrant || isCustom;
  const gradientColors = isCustom && customColor ? generateGradientColors(customColor) : null;
  
  // Estilos dinâmicos para gradientes
  const gradientStyleHorizontal = isCustom && gradientColors
    ? {
        background: `linear-gradient(90deg, ${gradientColors.start} 0%, ${gradientColors.middle} 50%, ${gradientColors.end} 100%)`,
      }
    : null;

  return (
    <AccessGuard 
      allowed={['owner', 'admin', 'atendente', 'pro', 'outro']}
      checkPermission={(user) => canAccessClientsMenu(user)}
    >
      <div className={cn(
        'min-h-screen p-3 sm:p-6 lg:p-10',
        hasGradient ? 'app-page' : 'bg-gradient-to-br from-slate-50 via-blue-50 to-purple-50'
      )}>
        <div className="max-w-6xl mx-auto space-y-6">
          {/* Header Moderno */}
          <motion.div
            initial={{ opacity: 0, y: -20 }}
            animate={{ opacity: 1, y: 0, scale: 1 }}
            transition={{ duration: 0.3 }}
            className={cn(
              'rounded-xl p-4 sm:p-6 transition-all',
              hasGradient
                ? 'bg-white/80 border border-white/25 shadow-xl backdrop-blur-xl'
                : 'app-card border border-slate-200 shadow-sm'
            )}
          >
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
              <div className="flex items-center gap-3 flex-wrap">
                <Button 
                  variant="ghost" 
                  onClick={() => router.push('/pacientes')} 
                  className={cn(
                    'flex items-center gap-2',
                    hasGradient ? 'hover:bg-white/60' : 'hover:bg-slate-100'
                  )}
                >
                <ArrowLeft className="w-4 h-4" />
                Voltar
              </Button>
                <div className="flex items-center gap-3 flex-wrap">
                  <div
                    className={cn(
                      'flex h-10 w-10 items-center justify-center rounded-lg text-white shadow-lg',
                      isVibrant
                        ? 'bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500'
                        : isCustom && gradientColors
                        ? ''
                        : 'bg-slate-900'
                    )}
                    style={
                      isCustom && gradientColors
                        ? {
                            background: `linear-gradient(135deg, ${gradientColors.start} 0%, ${gradientColors.middle} 50%, ${gradientColors.end} 100%)`,
                          }
                        : undefined
                    }
                  >
                    <Stethoscope className="w-5 h-5" />
                  </div>
                  <div>
                    <h1
                      className={cn(
                        'text-xl sm:text-2xl md:text-3xl font-bold',
                        hasGradient
                          ? isCustom && gradientColors
                            ? 'bg-clip-text text-transparent drop-shadow'
                            : 'bg-gradient-to-r from-indigo-500 via-purple-500 to-rose-500 bg-clip-text text-transparent drop-shadow'
                          : 'text-gray-900'
                      )}
                      style={
                        isCustom && gradientColors
                          ? {
                              background: `linear-gradient(90deg, ${gradientColors.start} 0%, ${gradientColors.middle} 50%, ${gradientColors.end} 100%)`,
                              WebkitBackgroundClip: 'text',
                              WebkitTextFillColor: 'transparent',
                              backgroundClip: 'text',
                            }
                          : undefined
                      }
                    >
                {patient.nome || `${singularTitle} sem nome`}
              </h1>
                    <div className="flex items-center gap-2 text-xs sm:text-sm mt-1">
                      <span className={cn(hasGradient ? 'text-slate-600/80' : 'text-gray-500')}>
                        {patient.email || 'Sem e-mail cadastrado'}
                      </span>
                      <span className={cn(hasGradient ? 'text-slate-400' : 'text-gray-400')}>•</span>
                      <span className={cn(hasGradient ? 'text-slate-600/80' : 'text-gray-500')}>
                        {patient.telefoneE164 || 'Sem telefone'}
                      </span>
            </div>
            </div>
                  {totalAlertas > 0 && (
                    <motion.div
                      initial={{ scale: 0, opacity: 0 }}
                      animate={{ scale: 1, opacity: 1 }}
                      transition={{ 
                        delay: 0.2,
                        type: "spring",
                        stiffness: 200,
                        damping: 15
                      }}
                      whileHover={{ scale: 1.05 }}
                      whileTap={{ scale: 0.95 }}
                    >
                      <button
                        onClick={() => setShowAlertasModal(true)}
                        className={cn(
                          'relative flex items-center gap-2 px-4 py-2.5 rounded-xl font-semibold text-sm',
                          'bg-gradient-to-r from-orange-500 via-red-500 to-orange-600',
                          'text-white shadow-lg hover:shadow-xl',
                          'border-2 border-orange-400/50',
                          'transition-all duration-300',
                          'hover:from-orange-600 hover:via-red-600 hover:to-orange-700',
                          'active:scale-95',
                          'group overflow-hidden'
                        )}
                      >
                        {/* Efeito de brilho animado */}
                        <motion.div
                          className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent"
                          initial={{ x: '-100%' }}
                          animate={{ x: '200%' }}
                          transition={{
                            repeat: Infinity,
                            duration: 3,
                            ease: "linear"
                          }}
                        />
                        
                        {/* Badge pulsante */}
                        <motion.div
                          className="absolute -top-1 -right-1 h-5 w-5 rounded-full bg-red-600 border-2 border-white shadow-lg"
                          animate={{
                            scale: [1, 1.2, 1],
                            opacity: [1, 0.8, 1]
                          }}
                          transition={{
                            repeat: Infinity,
                            duration: 2,
                            ease: "easeInOut"
                          }}
                        />
                        
                        <AlertTriangle className="w-5 h-5 relative z-10 group-hover:rotate-12 transition-transform duration-300" />
                        <span className="relative z-10 font-bold text-base">{totalAlertas}</span>
                        <span className="relative z-10 hidden sm:inline">Alerta{totalAlertas !== 1 ? 's' : ''}</span>
                        
                        {/* Efeito de brilho no hover */}
                        <div className="absolute inset-0 bg-white/0 group-hover:bg-white/10 transition-colors duration-300 rounded-xl" />
                      </button>
                    </motion.div>
                  )}
          </div>
              </div>
            </div>
          </motion.div>

          {/* Tabs Modernas */}
          <motion.div
            initial={{ opacity: 0, y: 20, scale: 0.95 }}
            animate={{ opacity: 1, y: 0, scale: 1 }}
            transition={{ duration: 0.3, delay: 0.1 }}
            className={cn(
              'rounded-xl p-4 sm:p-6 transition-all',
              hasGradient
                ? 'bg-white/80 border border-white/25 shadow-xl backdrop-blur-xl'
                : 'app-card border border-slate-200 shadow-sm'
            )}
          >
            <div className="flex flex-wrap gap-2 sm:gap-3">
                {TAB_ITEMS.filter(tab => {
                  // Se a tab requer permissão de débitos, verificar se o usuário tem acesso
                  if ('requiresDebitsPermission' in tab && tab.requiresDebitsPermission && (tab.id === 'orcamentos' || tab.id === 'financeiro')) {
                    return canAccessPatientDebits(userWithPermissions as any);
                  }
                  // Se a tab requer dentista, verificar se o tipo de estabelecimento é dentista
                  if ('requiresDentist' in tab && tab.requiresDentist && tab.id === 'ficha_odontologica') {
                    return isDentist;
                  }
                  return true; // Outras tabs sempre visíveis se o usuário tem acesso à página
              }).map((tab, index) => {
                  const Icon = tab.icon;
                  const isActive = activeTab === tab.id;
                  return (
                  <motion.button
                      key={tab.id}
                    initial={{ opacity: 0, x: -10 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: 0.1 + index * 0.05 }}
                      onClick={() => setActiveTab(tab.id)}
                    className={cn(
                      'flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-semibold transition-all duration-200',
                      isActive
                        ? hasGradient
                          ? isCustom && gradientStyleHorizontal
                            ? 'text-white shadow-lg'
                            : 'bg-gradient-to-r from-indigo-500 to-rose-500 text-white shadow-lg'
                          : 'bg-slate-900 text-white shadow-lg'
                        : hasGradient
                        ? 'bg-white/60 text-slate-700 hover:bg-white/80 border border-white/40'
                        : 'bg-white text-gray-600 hover:bg-slate-50 border border-slate-200'
                    )}
                    style={isActive && isCustom && gradientStyleHorizontal ? gradientStyleHorizontal : undefined}
                    >
                      <Icon className="w-4 h-4" />
                    <span className="hidden sm:inline">{tab.label}</span>
                    <span className="sm:hidden">{tab.label.split(' ')[0]}</span>
                  </motion.button>
                  );
                })}
              </div>
          </motion.div>

          {activeTab === 'dados_paciente' && (
            <DadosPacienteTab
              companyId={companyId}
              patientId={patientId}
              patient={patient}
              hasGradient={hasGradient}
              isCustom={isCustom}
              gradientColors={gradientColors}
              isVibrant={isVibrant}
              gradientStyleHorizontal={gradientStyleHorizontal}
              singularLabel={singularLabel}
              singularTitle={singularTitle}
              pluralTitle={pluralTitle}
            />
          )}

          {/* Pré-carregamento oculto de todas as imagens dos dentes */}
          {isDentist && (
            <div className="hidden" aria-hidden="true">
              {[
                11, 12, 13, 14, 15, 16, 17, 18,
                21, 22, 23, 24, 25, 26, 27, 28,
                31, 32, 33, 34, 35, 36, 37, 38,
                41, 42, 43, 44, 45, 46, 47, 48,
                51, 52, 53, 54, 55,
                61, 62, 63, 64, 65,
                71, 72, 73, 74, 75,
                81, 82, 83, 84, 85,
              ].map((numero) => (
                <img
                  key={numero}
                  src={`/images/dental-teeth/${numero}.png`}
                  alt=""
                  loading="eager"
                  fetchPriority="high"
                  decoding="async"
                  style={{ display: 'none', width: '1px', height: '1px' }}
                />
              ))}
            </div>
          )}

          {activeTab === 'ficha_odontologica' && isDentist && (
            <FichaOdontologicaTab
              companyId={companyId}
              patientId={patientId}
              patient={patient}
              professionals={professionals || []}
              dentalProcedures={dentalProcedures || []}
              orcamentos={orcamentos || []}
              dentalProceduresLoading={dentalProceduresLoading}
              user={user}
              hasGradient={hasGradient}
              isCustom={isCustom}
              gradientColors={gradientColors}
              isVibrant={isVibrant}
              gradientStyleHorizontal={gradientStyleHorizontal}
              singularLabel={singularLabel}
              singularTitle={singularTitle}
              pluralTitle={pluralTitle}
              onNavigateToOrcamentos={(orcamentoId) => {
                setActiveTab('orcamentos');
                if (orcamentoId) {
                  const scrollToOrcamento = () => {
                    const element = document.getElementById(`orcamento-${orcamentoId}`);
                    if (element) {
                      element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                      element.classList.add('ring-4', 'ring-blue-300');
                      setTimeout(() => {
                        element.classList.remove('ring-4', 'ring-blue-300');
                      }, 2000);
                      return true;
                    }
                    return false;
                  };
                  if (!scrollToOrcamento()) {
                    setTimeout(() => {
                      if (!scrollToOrcamento()) {
                        setTimeout(() => scrollToOrcamento(), 300);
                      }
                    }, 150);
                  }
                }
              }}
              onAddProcedimento={async (procedimento) => {
                await addDentalProcedure(
                  {
                    ...procedimento,
                    createdByUid: user?.uid,
                  },
                  async (procedureId) => {
                    if (procedimento.gerarPagamentoFinanceiro) {
                      const debitoId = await createDebito({
                        companyId: companyId || '',
                        patientId: patientId || '',
                        procedimento: procedimento.procedimento,
                        valorTotalCentavos: procedimento.valorCentavos,
                        saldoReceberCentavos: procedimento.valorCentavos,
                        saldoRecebidoCentavos: 0,
                        lancamentos: [],
                        status: 'pendente',
                        profissionalId: procedimento.profissionalId,
                        observacoes: procedimento.observacoes,
                        dentalProcedureId: procedureId,
                        createdByUid: user?.uid,
                      });
                      await updateDentalProcedure(procedureId, {
                        debitoId,
                      });
                    }
                  }
                );
              }}
              onEditProcedimento={updateDentalProcedure}
              onDeleteProcedimento={deleteDentalProcedure}
              createDebito={createDebito}
              updateDentalProcedure={updateDentalProcedure}
            />
          )}

          {activeTab === 'anamnese' && (
            <AnamneseTab
              companyId={companyId}
              patientId={patientId}
              patient={patient}
              hasGradient={hasGradient}
              isCustom={isCustom}
              gradientColors={gradientColors}
              isVibrant={isVibrant}
              gradientStyleHorizontal={gradientStyleHorizontal}
              singularLabel={singularLabel}
              singularTitle={singularTitle}
              pluralTitle={pluralTitle}
              anamneses={anamneses}
              loadingAnamneses={loadingAnamneses}
              professionals={professionals || []}
              onShowAnamneseModal={() => setShowAnamneseModal(true)}
              onViewAnamnese={handleVerAnamnese}
              onEditAnamnese={handleEditarAnamnese}
              onDownloadAnamnesePDF={handleDownloadAnamnesePDF}
              onSendAnamnese={handleSendAnamnese}
              onDeleteAnamnese={handleDeleteAnamnese}
            >
              {/* Modais da anamnese mantidos na página principal por enquanto */}
            </AnamneseTab>
          )}

          {/* Modal de Visualizar Anamnese */}
          {viewingAnamnese && modeloCompleto && (
            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <div className="p-6 border-b bg-gradient-to-r from-blue-50 to-indigo-50">
                  <div className="flex items-center justify-between">
                    <div>
                      <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                        <Eye className="w-6 h-6 text-blue-600" />
                        Visualizar Anamnese
                      </h2>
                      <p className="text-sm text-gray-600 mt-1">{viewingAnamnese.modeloNome}</p>
                    </div>
                    <Button
                      variant="ghost"
                      size="icon"
                      onClick={() => {
                        setViewingAnamnese(null);
                        setModeloCompleto(null);
                      }}
                    >
                      <X className="w-5 h-5" />
                    </Button>
                  </div>
                </div>

                <div className="flex-1 overflow-y-auto p-6 space-y-6">
                  {/* Informações da Anamnese */}
                  <Card className="border-2">
                    <CardHeader className="bg-gray-50">
                      <CardTitle className="text-lg">Informações da Anamnese</CardTitle>
                    </CardHeader>
                    <CardContent className="pt-4 space-y-3">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <span className="text-sm font-semibold text-gray-700">Responsável:</span>
                          <p className="text-sm text-gray-900">
                            {professionals.find(p => p.id === viewingAnamnese.dentistaId)?.apelido || 'Não encontrado'}
                          </p>
                        </div>
                        <div>
                          <span className="text-sm font-semibold text-gray-700">CRO:</span>
                          <p className="text-sm text-gray-900">
                            {viewingAnamnese.numeroCRO} - {viewingAnamnese.estadoCRO}
                          </p>
                        </div>
                        <div>
                          <span className="text-sm font-semibold text-gray-700">Status:</span>
                          <Badge
                            variant="outline"
                            className={
                              viewingAnamnese.status === 'pendente'
                                ? 'bg-yellow-50 text-yellow-700 border-yellow-300'
                                : viewingAnamnese.status === 'assinada'
                                ? 'bg-green-50 text-green-700 border-green-300'
                                : 'bg-gray-50 text-gray-700 border-gray-300'
                            }
                          >
                            {viewingAnamnese.status === 'pendente'
                              ? 'Pendente'
                              : viewingAnamnese.status === 'assinada'
                              ? 'Assinada'
                              : 'Rascunho'}
                          </Badge>
                        </div>
                        <div>
                          <span className="text-sm font-semibold text-gray-700">Criada em:</span>
                          <p className="text-sm text-gray-900">
                            {format(viewingAnamnese.createdAt, "dd/MM/yyyy 'às' HH:mm", { locale: ptBR })}
                          </p>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Seções do Modelo */}
                  {modeloCompleto.secoes && modeloCompleto.secoes.length > 0 && (
                    <div className="space-y-4">
                      {modeloCompleto.secoes
                        .sort((a: any, b: any) => a.ordem - b.ordem)
                        .map((secao: any) => (
                          <Card key={secao.id} className="border-2">
                            <CardHeader className="bg-gradient-to-r from-blue-50 to-indigo-50">
                              <CardTitle className="text-lg flex items-center gap-2">
                                <FileText className="w-5 h-5 text-blue-600" />
                                {secao.nome}
                              </CardTitle>
                            </CardHeader>
                            <CardContent className="pt-4 space-y-3">
                              {secao.perguntas && secao.perguntas.length > 0 ? (
                                secao.perguntas
                                  .sort((a: any, b: any) => a.ordem - b.ordem)
                                  .map((pergunta: any, index: number) => {
                                    const respostaKey = `${secao.id}-${pergunta.id}`;
                                    const resposta = viewingAnamnese.respostas?.[respostaKey] || null;
                                    
                                    return (
                                      <div
                                        key={pergunta.id}
                                        className="p-4 border rounded-lg bg-white space-y-3"
                                      >
                                        <div className="flex items-start gap-3">
                                          <span className="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center text-xs font-bold">
                                            {index + 1}
                                          </span>
                                          <div className="flex-1 space-y-3">
                                            <div>
                                              <p className="font-semibold text-gray-900 mb-2">
                                                {pergunta.pergunta}
                                                {pergunta.geraAlerta && (
                                                  <Badge variant="outline" className="ml-2 text-xs bg-orange-50 text-orange-700 border-orange-300">
                                                    <span className="mr-1">⚠️</span>
                                                    Gera Alerta
                                                  </Badge>
                                                )}
                                              </p>
                                            </div>
                                            
                                            {/* Exibir Resposta */}
                                            {resposta ? (
                                              <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                                {pergunta.tipoResposta === 'sim_nao' && (
                                                  <div className="flex items-center gap-2">
                                                    <span className="text-sm font-medium text-gray-700">Resposta:</span>
                                                    <Badge 
                                                      variant="outline" 
                                                      className={
                                                        resposta.resposta === 'sim'
                                                          ? 'bg-green-50 text-green-700 border-green-300'
                                                          : 'bg-red-50 text-red-700 border-red-300'
                                                      }
                                                    >
                                                      {resposta.resposta === 'sim' ? 'Sim' : 'Não'}
                                                    </Badge>
                                                  </div>
                                                )}
                                                
                                                {pergunta.tipoResposta === 'texto' && (
                                                  <div>
                                                    <span className="text-sm font-medium text-gray-700 block mb-1">Resposta:</span>
                                                    <p className="text-sm text-gray-900 whitespace-pre-wrap">
                                                      {resposta.texto || 'Não respondido'}
                                                    </p>
                                                  </div>
                                                )}
                                                
                                                {pergunta.tipoResposta === 'sim_nao_texto' && (
                                                  <div className="space-y-2">
                                                    <div className="flex items-center gap-2">
                                                      <span className="text-sm font-medium text-gray-700">Resposta:</span>
                                                      <Badge 
                                                        variant="outline" 
                                                        className={
                                                          resposta.resposta === 'sim'
                                                            ? 'bg-green-50 text-green-700 border-green-300'
                                                            : resposta.resposta === 'nao'
                                                            ? 'bg-red-50 text-red-700 border-red-300'
                                                            : 'bg-gray-50 text-gray-700 border-gray-300'
                                                        }
                                                      >
                                                        {resposta.resposta === 'sim' ? 'Sim' : resposta.resposta === 'nao' ? 'Não' : 'Não respondido'}
                                                      </Badge>
                                                    </div>
                                                    {resposta.texto && (
                                                      <div>
                                                        <span className="text-sm font-medium text-gray-700 block mb-1">Observações:</span>
                                                        <p className="text-sm text-gray-900 whitespace-pre-wrap">
                                                          {resposta.texto}
                                                        </p>
                                                      </div>
                                                    )}
                                                  </div>
                                                )}
                                              </div>
                                            ) : (
                                              <div className="mt-3 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                                                <p className="text-sm text-gray-500 italic">Não respondido</p>
                                              </div>
                                            )}
                                          </div>
                                        </div>
                                      </div>
                                    );
                                  })
                              ) : (
                                <p className="text-sm text-gray-500 italic">Nenhuma pergunta nesta seção</p>
                              )}
                            </CardContent>
                          </Card>
                        ))}
                    </div>
                  )}
                </div>

                <div className="p-6 border-t bg-gray-50 flex justify-end">
                  <Button variant="outline" onClick={() => {
                    setViewingAnamnese(null);
                    setModeloCompleto(null);
                  }}>
                    Fechar
                  </Button>
                </div>
              </div>
            </div>
          )}

          {/* Modal de Preencher Anamnese */}
          {editingAnamnese && modeloCompleto && (
            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <div className="p-6 border-b bg-gradient-to-r from-blue-50 to-indigo-50">
                  <div className="flex items-center justify-between">
                    <div>
                      <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                        <Edit className="w-6 h-6 text-blue-600" />
                        Preencher Anamnese
                      </h2>
                      <p className="text-sm text-gray-600 mt-1">{editingAnamnese.modeloNome}</p>
                    </div>
                    <Button
                      variant="ghost"
                      size="icon"
                      onClick={() => {
                        setEditingAnamnese(null);
                        setModeloCompleto(null);
                      }}
                    >
                      <X className="w-5 h-5" />
                    </Button>
                  </div>
                </div>

                <div className="flex-1 overflow-y-auto p-6 space-y-6">
                  {/* Informações da Anamnese */}
                  <Card className="border-2">
                    <CardHeader className="bg-gray-50">
                      <CardTitle className="text-lg">Informações</CardTitle>
                    </CardHeader>
                    <CardContent className="pt-4">
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div>
                          <span className="font-semibold text-gray-700">Responsável:</span>
                          <p className="text-gray-900">
                            {professionals.find(p => p.id === editingAnamnese.dentistaId)?.apelido || 'Não encontrado'}
                          </p>
                        </div>
                        <div>
                          <span className="font-semibold text-gray-700">CRO:</span>
                          <p className="text-gray-900">
                            {editingAnamnese.numeroCRO} - {editingAnamnese.estadoCRO}
                          </p>
                        </div>
                        <div>
                          <span className="font-semibold text-gray-700">Status:</span>
                          <Badge
                            variant="outline"
                            className={
                              editingAnamnese.status === 'pendente'
                                ? 'bg-yellow-50 text-yellow-700 border-yellow-300'
                                : editingAnamnese.status === 'assinada'
                                ? 'bg-green-50 text-green-700 border-green-300'
                                : editingAnamnese.status === 'preenchida'
                                ? 'bg-blue-50 text-blue-700 border-blue-300'
                                : 'bg-gray-50 text-gray-700 border-gray-300'
                            }
                          >
                            {editingAnamnese.status === 'pendente'
                              ? 'Pendente'
                              : editingAnamnese.status === 'assinada'
                              ? 'Assinada'
                              : editingAnamnese.status === 'preenchida'
                              ? 'Preenchida'
                              : 'Rascunho'}
                          </Badge>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Seções com Perguntas para Preencher */}
                  {modeloCompleto.secoes && modeloCompleto.secoes.length > 0 && (
                    <div className="space-y-4">
                      {modeloCompleto.secoes
                        .sort((a: any, b: any) => a.ordem - b.ordem)
                        .map((secao: any) => (
                          <Card key={secao.id} className="border-2">
                            <CardHeader className="bg-gradient-to-r from-blue-50 to-indigo-50">
                              <CardTitle className="text-lg flex items-center gap-2">
                                <FileText className="w-5 h-5 text-blue-600" />
                                {secao.nome}
                              </CardTitle>
                            </CardHeader>
                            <CardContent className="pt-4 space-y-4">
                              {secao.perguntas && secao.perguntas.length > 0 ? (
                                secao.perguntas
                                  .sort((a: any, b: any) => a.ordem - b.ordem)
                                  .map((pergunta: any, index: number) => {
                                    const respostaKey = `${secao.id}-${pergunta.id}`;
                                    const respostaAtual = editingAnamnese.respostas?.[respostaKey] || {};
                                    
                                    return (
                                      <div
                                        key={pergunta.id}
                                        className="p-4 border rounded-lg bg-white space-y-3"
                                      >
                                        <div className="flex items-start gap-3">
                                          <span className="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center text-xs font-bold">
                                            {index + 1}
                                          </span>
                                          <div className="flex-1 space-y-3">
                                            <div>
                                              <p className="font-semibold text-gray-900 mb-2">
                                                {pergunta.pergunta}
                                                {pergunta.geraAlerta && (
                                                  <Badge variant="outline" className="ml-2 text-xs bg-orange-50 text-orange-700 border-orange-300">
                                                    <span className="mr-1">⚠️</span>
                                                    Gera Alerta
                                                  </Badge>
                                                )}
                                              </p>
                                            </div>
                                            
                                            {/* Campo de Resposta baseado no tipo */}
                                            {pergunta.tipoResposta === 'sim_nao' && (
                                              <div className="flex items-center gap-4">
                                                <label className="flex items-center gap-2 cursor-pointer">
                                                  <input
                                                    type="radio"
                                                    name={`resposta-${respostaKey}`}
                                                    checked={respostaAtual.resposta === 'sim'}
                                                    onChange={() => atualizarResposta(secao.id, pergunta.id, { resposta: 'sim' })}
                                                    className="w-4 h-4 text-blue-600"
                                                  />
                                                  <span className="text-sm font-medium">Sim</span>
                                                </label>
                                                <label className="flex items-center gap-2 cursor-pointer">
                                                  <input
                                                    type="radio"
                                                    name={`resposta-${respostaKey}`}
                                                    checked={respostaAtual.resposta === 'nao'}
                                                    onChange={() => atualizarResposta(secao.id, pergunta.id, { resposta: 'nao' })}
                                                    className="w-4 h-4 text-blue-600"
                                                  />
                                                  <span className="text-sm font-medium">Não</span>
                                                </label>
                                              </div>
                                            )}
                                            
                                            {pergunta.tipoResposta === 'texto' && (
                                              <Textarea
                                                value={respostaAtual.texto || ''}
                                                onChange={(e) => atualizarResposta(secao.id, pergunta.id, { texto: e.target.value })}
                                                placeholder="Digite sua resposta..."
                                                className="w-full min-h-[100px]"
                                              />
                                            )}
                                            
                                            {pergunta.tipoResposta === 'sim_nao_texto' && (
                                              <div className="space-y-3">
                                                <div className="flex items-center gap-4">
                                                  <label className="flex items-center gap-2 cursor-pointer">
                                                    <input
                                                      type="radio"
                                                      name={`resposta-${respostaKey}`}
                                                      checked={respostaAtual.resposta === 'sim'}
                                                      onChange={() => atualizarResposta(secao.id, pergunta.id, { ...respostaAtual, resposta: 'sim' })}
                                                      className="w-4 h-4 text-blue-600"
                                                    />
                                                    <span className="text-sm font-medium">Sim</span>
                                                  </label>
                                                  <label className="flex items-center gap-2 cursor-pointer">
                                                    <input
                                                      type="radio"
                                                      name={`resposta-${respostaKey}`}
                                                      checked={respostaAtual.resposta === 'nao'}
                                                      onChange={() => atualizarResposta(secao.id, pergunta.id, { ...respostaAtual, resposta: 'nao' })}
                                                      className="w-4 h-4 text-blue-600"
                                                    />
                                                    <span className="text-sm font-medium">Não</span>
                                                  </label>
                                                </div>
                                                <Textarea
                                                  value={respostaAtual.texto || ''}
                                                  onChange={(e) => atualizarResposta(secao.id, pergunta.id, { ...respostaAtual, texto: e.target.value })}
                                                  placeholder="Adicione observações (opcional)..."
                                                  className="w-full min-h-[100px]"
                                                />
                                              </div>
                                            )}
                                          </div>
                                        </div>
                                      </div>
                                    );
                                  })
                              ) : (
                                <p className="text-sm text-gray-500 italic">Nenhuma pergunta nesta seção</p>
                              )}
                            </CardContent>
                          </Card>
                        ))}
                    </div>
                  )}
                </div>

                <div className="p-6 border-t bg-gray-50 flex justify-end gap-3">
                  <Button
                    variant="outline"
                    onClick={() => {
                      setEditingAnamnese(null);
                      setModeloCompleto(null);
                    }}
                  >
                    Cancelar
                  </Button>
                  <Button onClick={handleSalvarRespostasAnamnese}>
                    <Save className="w-4 h-4 mr-2" />
                    Salvar Respostas
                  </Button>
                </div>
              </div>
            </div>
          )}

          {/* Modal de Envio de Link de Assinatura de Anamnese */}
          {sendAnamneseModal && (
            <div className="fixed inset-0 z-[1003] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
              <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 space-y-4">
                <div className="flex items-center justify-between">
                  <h2 className="text-xl font-bold text-gray-900">Enviar Link de Assinatura</h2>
                  <button
                    type="button"
                    onClick={() => setSendAnamneseModal(null)}
                    className="p-2 rounded-lg hover:bg-gray-100 transition-colors"
                  >
                    <X className="w-5 h-5 text-gray-600" />
                  </button>
                </div>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Link de Assinatura
                    </label>
                    <div className="flex gap-2">
                      <Input
                        type="text"
                        value={sendAnamneseModal.link}
                        readOnly
                        className="flex-1 font-mono text-sm"
                      />
                      <Button
                        type="button"
                        onClick={handleCopyAnamneseLink}
                        variant="outline"
                        className="flex-shrink-0"
                      >
                        {copiedAnamneseLink ? (
                          <>
                            <Check className="w-4 h-4 mr-2" />
                            Copiado!
                          </>
                        ) : (
                          <>
                            <Copy className="w-4 h-4 mr-2" />
                            Copiar
                          </>
                        )}
                      </Button>
                    </div>
                  </div>

                  <div className="flex gap-3">
                    <Button
                      type="button"
                      onClick={handleSendAnamneseViaSystem}
                      className="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white"
                      disabled={!patient?.telefoneE164}
                    >
                      <Send className="w-4 h-4 mr-2" />
                      Enviar pelo Sistema
                    </Button>
                    <Button
                      type="button"
                      onClick={() => setSendAnamneseModal(null)}
                      variant="outline"
                      className="flex-1"
                    >
                      Fechar
                    </Button>
                  </div>

                  {!patient?.telefoneE164 && (
                    <p className="text-xs text-gray-500 text-center">
                      {singularTitle} sem telefone cadastrado. Use a opção de copiar o link.
                    </p>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* Modal de Alertas da Anamnese */}
          {showAlertasModal && (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-in fade-in duration-200">
              <div className="bg-white rounded-3xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col animate-in zoom-in-95 duration-300">
                {/* Header com gradiente moderno */}
                <div className="p-6 sm:p-8 border-b bg-gradient-to-br from-orange-500 via-red-500 to-pink-500 relative overflow-hidden">
                  <div className="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent"></div>
                  <div className="relative flex items-center justify-between">
                    <div className="flex items-center gap-4">
                      <div className="w-14 h-14 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center shadow-lg">
                        <AlertTriangle className="w-7 h-7 text-white" />
                      </div>
                      <div>
                        <h2 className="text-2xl sm:text-3xl font-bold text-white flex items-center gap-3">
                          Alertas da Anamnese
                        </h2>
                        <div className="flex items-center gap-3 mt-2">
                          <div className="px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full">
                            <p className="text-sm font-semibold text-white">
                              {totalAlertas} alerta{totalAlertas !== 1 ? 's' : ''} encontrado{totalAlertas !== 1 ? 's' : ''}
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                    <Button
                      variant="ghost"
                      size="icon"
                      onClick={() => setShowAlertasModal(false)}
                      className="text-white hover:bg-white/20 rounded-xl transition-all"
                    >
                      <X className="w-5 h-5" />
                    </Button>
                  </div>
                </div>

                {/* Conteúdo com scroll */}
                <div className="flex-1 overflow-y-auto p-6 sm:p-8 space-y-6 bg-gradient-to-b from-gray-50 to-white">
                  {alertasAnamnese.length === 0 ? (
                    <div className="text-center py-16">
                      <div className="w-20 h-20 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-4 animate-pulse">
                        <CheckCircle2 className="w-10 h-10 text-green-600" />
                      </div>
                      <h3 className="text-xl font-bold text-gray-900 mb-2">Nenhum alerta encontrado</h3>
                      <p className="text-gray-600">Todas as anamneses estão sem alertas.</p>
                    </div>
                  ) : (
                    alertasAnamnese.map((item, index) => (
                      <Card 
                        key={index} 
                        className="border-2 border-orange-200/50 hover:border-orange-400 transition-all duration-300 shadow-lg hover:shadow-xl bg-white overflow-hidden"
                      >
                        <CardHeader className="bg-gradient-to-r from-orange-50 via-red-50 to-pink-50 border-b border-orange-200/50">
                          <div className="flex items-start justify-between gap-4">
                            <div className="flex items-start gap-4 flex-1">
                              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center shadow-lg flex-shrink-0">
                                <FileText className="w-6 h-6 text-white" />
                              </div>
                              <div className="flex-1">
                                <CardTitle className="text-xl font-bold text-gray-900 mb-2">
                                  {item.anamnese.modeloNome || 'Anamnese'}
                                </CardTitle>
                                <div className="flex items-center gap-3 flex-wrap">
                                  <Badge 
                                    variant="outline" 
                                    className="bg-white/80 text-orange-700 border-orange-300 font-semibold shadow-sm"
                                  >
                                    <AlertTriangle className="w-3 h-3 mr-1" />
                                    {item.alertas.length} alerta{item.alertas.length !== 1 ? 's' : ''}
                                  </Badge>
                                  <span className="text-xs text-gray-500 flex items-center gap-1">
                                    <Clock3 className="w-3 h-3" />
                                    Criada em {format(item.anamnese.createdAt, "dd/MM/yyyy 'às' HH:mm", { locale: ptBR })}
                                  </span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </CardHeader>
                        <CardContent className="pt-6 space-y-4">
                          {item.alertas.map((alerta, alertaIndex) => (
                            <div
                              key={alertaIndex}
                              className="group relative p-5 bg-gradient-to-r from-orange-50/50 to-red-50/50 border-l-4 border-orange-500 rounded-r-xl hover:shadow-md transition-all duration-300 hover:from-orange-50 hover:to-red-50"
                            >
                              <div className="absolute top-2 right-2 w-8 h-8 rounded-full bg-orange-500/10 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <AlertTriangle className="w-4 h-4 text-orange-600" />
                              </div>
                              <div className="flex items-start gap-4">
                                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-400 to-red-500 flex items-center justify-center shadow-md flex-shrink-0">
                                  <AlertTriangle className="w-5 h-5 text-white" />
                                </div>
                                <div className="flex-1 space-y-3">
                                  <div>
                                    <div className="inline-block px-2.5 py-1 bg-orange-500/10 rounded-md mb-2">
                                      <p className="text-xs font-bold text-orange-700 uppercase tracking-wide">
                                        {alerta.secao}
                                      </p>
                                    </div>
                                    <p className="font-bold text-gray-900 text-base leading-relaxed">
                                      {alerta.pergunta}
                                    </p>
                                  </div>
                                  <div className="bg-white rounded-xl p-4 border-2 border-orange-200/50 shadow-sm hover:shadow-md transition-shadow">
                                    <div className="flex items-start gap-2">
                                      <div className="w-2 h-2 rounded-full bg-orange-500 mt-2 flex-shrink-0"></div>
                                      <div className="flex-1">
                                        <p className="text-xs font-semibold text-orange-700 uppercase mb-1">Resposta</p>
                                        <p className="text-sm text-gray-800 leading-relaxed whitespace-pre-wrap">
                                          {alerta.resposta}
                                        </p>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          ))}
              </CardContent>
            </Card>
                    ))
                  )}
                </div>

                {/* Footer moderno */}
                <div className="p-6 sm:p-8 border-t bg-gradient-to-r from-gray-50 to-white flex justify-end gap-3">
                  <Button
                    variant="outline"
                    onClick={() => setShowAlertasModal(false)}
                    className="px-6 rounded-xl border-2 hover:bg-gray-50 transition-all"
                  >
                    Fechar
                  </Button>
                </div>
              </div>
            </div>
          )}

          {/* Modal de Criar Anamnese */}
          {showAnamneseModal && (
            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <div className="p-6 border-b bg-gradient-to-r from-blue-50 to-indigo-50">
                  <div className="flex items-center justify-between">
                    <div>
                      <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                        <Plus className="w-6 h-6 text-blue-600" />
                        Adicionar Anamnese
                      </h2>
                      <p className="text-sm text-gray-600 mt-1">Preencha os dados da anamnese</p>
                    </div>
                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={() => {
                      setShowAnamneseModal(false);
                      setSelectedModeloId('');
                      setSelectedDentistaId('');
                      setNumeroCRO('');
                      setEstadoCRO('');
                      setEnviarParaPaciente(false);
                    }}
                  >
                    <X className="w-5 h-5" />
                  </Button>
                  </div>
                </div>

                <div className="flex-1 overflow-y-auto p-6 space-y-6">
                  <div>
                    <label className="block text-sm font-semibold text-gray-900 mb-2">
                      Selecione o modelo da anamnese <span className="text-red-500">*</span>
                    </label>
                    <select
                      value={selectedModeloId}
                      onChange={(e) => setSelectedModeloId(e.target.value)}
                      className="w-full rounded-xl border-2 border-gray-300 p-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                    >
                      <option value="">Selecione</option>
                      {anamneseModelos.length === 0 ? (
                        <option value="" disabled>Nenhum modelo disponível</option>
                      ) : (
                        anamneseModelos.map((modelo: any) => (
                          <option key={modelo.id} value={modelo.id}>
                            {modelo.nome} {!modelo.ativo && '(Inativo)'}
                          </option>
                        ))
                      )}
                    </select>
                    {anamneseModelos.length === 0 && (
                      <p className="text-xs text-gray-500 mt-2">
                        Nenhum modelo de anamnese encontrado. Crie modelos em{' '}
                        <Link href="/configuracoes/modelos-anamnese" className="text-blue-600 hover:underline">
                          Configurações → Modelos de anamnese
                        </Link>
                      </p>
                    )}
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-900 mb-2">
                      Responsável <span className="text-red-500">*</span>
                    </label>
                    <select
                      value={selectedDentistaId}
                      onChange={(e) => setSelectedDentistaId(e.target.value)}
                      className="w-full rounded-xl border-2 border-gray-300 p-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                    >
                      <option value="">Selecione</option>
                      {professionals
                        .filter((p) => p.ativo)
                        .map((prof) => (
                          <option key={prof.id} value={prof.id}>
                            {prof.apelido}
                          </option>
                        ))}
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-900 mb-2">
                      Número do CRO <span className="text-red-500">*</span>
                    </label>
                    <Input
                      value={numeroCRO}
                      onChange={(e) => setNumeroCRO(e.target.value)}
                      placeholder="Digite o número do CRO"
                      className="w-full rounded-xl border-2 border-gray-300 p-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-900 mb-2">
                      Estado do CRO <span className="text-red-500">*</span>
                    </label>
                    <select
                      value={estadoCRO}
                      onChange={(e) => setEstadoCRO(e.target.value)}
                      className="w-full rounded-xl border-2 border-gray-300 p-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                    >
                      <option value="">Selecione o Estado</option>
                      {ESTADOS_BRASIL.map((estado) => (
                        <option key={estado} value={estado}>
                          {estado}
                        </option>
                      ))}
                    </select>
                  </div>

                  <div className="flex items-start gap-3 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border-2 border-green-200">
                    <input
                      type="checkbox"
                      id="enviarPaciente"
                      checked={enviarParaPaciente}
                      onChange={(e) => setEnviarParaPaciente(e.target.checked)}
                      className="mt-1 w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500 focus:ring-2 cursor-pointer"
                    />
                    <label htmlFor="enviarPaciente" className="text-sm text-gray-900 cursor-pointer flex-1">
                      <span className="font-bold">Enviar para o paciente preencher e assinar</span>
                    </label>
                  </div>
                </div>

                <div className="p-6 border-t bg-gray-50 flex justify-end gap-3">
                  <Button
                    variant="outline"
                    onClick={() => {
                      setShowAnamneseModal(false);
                      setEditingAnamnese(null);
                      setSelectedModeloId('');
                      setSelectedDentistaId('');
                      setNumeroCRO('');
                      setEstadoCRO('');
                      setEnviarParaPaciente(false);
                    }}
                  >
                    Cancelar
                  </Button>
                  <Button onClick={handleCriarAnamnese}>
                    <Plus className="w-4 h-4 mr-2" />
                    Criar Anamnese
                  </Button>
                </div>
              </div>
            </div>
          )}

          {activeTab === 'evolucoes' && (
            <EvolucoesTab
              companyId={companyId}
              patientId={patientId}
              patient={patient}
              hasGradient={hasGradient}
              isCustom={isCustom}
              gradientColors={gradientColors}
              isVibrant={isVibrant}
              gradientStyleHorizontal={gradientStyleHorizontal}
              singularLabel={singularLabel}
              singularTitle={singularTitle}
              pluralTitle={pluralTitle}
              evolutions={evolutions}
              evolutionsLoading={evolutionsLoading}
              newEvolutionNotes={newEvolutionNotes}
              newEvolutionDate={newEvolutionDate}
              selectedEvolutionFiles={selectedEvolutionFiles}
              isSavingEvolution={isSavingEvolution}
              evolutionUploadProgress={evolutionUploadProgress}
              deletingEvolutionId={deletingEvolutionId}
              imageDimensions={imageDimensions}
              onNotesChange={setNewEvolutionNotes}
              onDateChange={setNewEvolutionDate}
              onEvolutionFilesChange={handleEvolutionFilesChange}
              onRemoveEvolutionFile={handleRemoveEvolutionFile}
              onCreateEvolution={handleCreateEvolution}
              onDeleteEvolution={handleDeleteEvolution}
              formatEvolutionDate={formatEvolutionDate}
              formatFileSize={formatFileSize}
            />
          )}

          {activeTab === 'orcamentos' && (
            <>
              {canAccessPatientDebits(userWithPermissions as any) ? (
                <div className="space-y-6">
                  {/* Header Moderno */}
                  <motion.div
                    initial={{ opacity: 0, y: -10 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ duration: 0.3 }}
                    className={cn(
                      'rounded-2xl p-6 shadow-xl border-2 backdrop-blur-xl',
                      hasGradient
                        ? isCustom && gradientColors
                          ? 'bg-white/90 border-white/40'
                          : isVibrant
                          ? 'bg-gradient-to-br from-indigo-50/80 via-purple-50/80 to-pink-50/80 border-white/40'
                          : 'bg-white/90 border-white/40'
                        : 'bg-white border-gray-200'
                    )}
                    style={
                      hasGradient && isCustom && gradientColors
                        ? {
                            borderColor: `${gradientColors.start}40`,
                            background: `linear-gradient(135deg, ${gradientColors.start}10 0%, ${gradientColors.middle}10 50%, ${gradientColors.end}10 100%)`,
                          }
                        : undefined
                    }
                  >
                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                      <div className="flex items-center gap-4">
                        <div
                          className={cn(
                            'flex h-14 w-14 items-center justify-center rounded-2xl text-white shadow-lg',
                            isVibrant
                              ? 'bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500'
                              : isCustom && gradientColors
                              ? ''
                              : 'bg-gradient-to-br from-blue-500 to-indigo-600'
                          )}
                          style={
                            isCustom && gradientColors
                              ? {
                                  background: `linear-gradient(135deg, ${gradientColors.start} 0%, ${gradientColors.middle} 50%, ${gradientColors.end} 100%)`,
                                }
                              : undefined
                          }
                        >
                          <Wallet className="w-7 h-7" />
                        </div>
                        <div>
                          <h2 className={cn(
                            'text-2xl font-bold',
                            hasGradient 
                              ? isCustom && gradientColors
                                ? 'bg-clip-text text-transparent'
                                : isVibrant
                                ? 'bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 bg-clip-text text-transparent'
                                : 'text-slate-900'
                              : 'text-gray-900'
                          )}
                          style={
                            hasGradient && isCustom && gradientColors
                              ? {
                                  background: `linear-gradient(90deg, ${gradientColors.start} 0%, ${gradientColors.end} 100%)`,
                                  WebkitBackgroundClip: 'text',
                                  WebkitTextFillColor: 'transparent',
                                  backgroundClip: 'text',
                                }
                              : undefined
                          }
                          >
                            Orçamentos
                          </h2>
                          <p className={cn(
                            'text-sm mt-1 font-medium',
                            hasGradient 
                              ? isCustom && gradientColors
                                ? 'text-slate-600'
                                : 'text-slate-600'
                              : 'text-gray-600'
                          )}>
                            {orcamentos.length} {orcamentos.length === 1 ? 'orçamento cadastrado' : 'orçamentos cadastrados'}
                          </p>
                        </div>
                      </div>
                      <Button
                        onClick={() => setSelectedOrcamentoId('new')}
                        className={cn(
                          'gap-2 shadow-lg hover:shadow-xl transition-all text-white font-semibold h-12 px-6 rounded-xl',
                          hasGradient
                            ? isCustom && gradientColors
                              ? ''
                              : isVibrant
                              ? 'bg-gradient-to-r from-indigo-500 to-rose-500 hover:from-indigo-600 hover:to-rose-600'
                              : 'bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700'
                            : 'bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700'
                        )}
                        style={
                          hasGradient && isCustom && gradientColors
                            ? {
                                background: `linear-gradient(90deg, ${gradientColors.start} 0%, ${gradientColors.middle} 50%, ${gradientColors.end} 100%)`,
                              }
                            : undefined
                        }
                      >
                        <Plus className="w-5 h-5" />
                        Novo Orçamento
                      </Button>
                    </div>
                  </motion.div>

                  {/* Conteúdo */}
                  <div className="space-y-4">
                    {orcamentosLoading ? (
                      <div className={cn(
                        'flex items-center justify-center py-20 rounded-2xl',
                        hasGradient
                          ? 'bg-white/60 backdrop-blur-xl border-2 border-white/40'
                          : 'bg-white border-2 border-gray-200'
                      )}>
                        <div className="text-center">
                          <div className={cn(
                            'animate-spin rounded-full h-12 w-12 border-b-2 mx-auto mb-4',
                            hasGradient
                              ? isCustom && gradientColors
                                ? ''
                                : isVibrant
                                ? 'border-indigo-500'
                                : 'border-indigo-500'
                              : 'border-blue-500'
                          )}
                          style={
                            hasGradient && isCustom && gradientColors
                              ? {
                                  borderColor: gradientColors.start,
                                }
                              : undefined
                          }
                          />
                          <p className={cn(
                            'text-sm font-medium',
                            hasGradient ? 'text-slate-600' : 'text-gray-600'
                          )}>
                            Carregando orçamentos...
                          </p>
                        </div>
                      </div>
                    ) : orcamentos.length === 0 ? (
                        <motion.div
                          initial={{ opacity: 0, scale: 0.95 }}
                          animate={{ opacity: 1, scale: 1 }}
                          className={cn(
                            'py-16 text-center rounded-2xl',
                            hasGradient
                              ? 'bg-white/60 backdrop-blur-xl border-2 border-white/40'
                              : 'bg-white border-2 border-gray-200'
                          )}
                        >
                          <div className={cn(
                            'inline-flex h-20 w-20 items-center justify-center rounded-2xl mb-6 border-2 shadow-lg',
                            hasGradient
                              ? isCustom && gradientColors
                                ? 'bg-white/80 border-white/50'
                                : isVibrant
                                ? 'bg-gradient-to-br from-indigo-100/60 via-purple-100/60 to-pink-100/60 border-white/40'
                                : 'bg-slate-100/60 border-white/40'
                              : 'bg-gray-100 border-gray-200/60'
                          )}
                          style={
                            hasGradient && isCustom && gradientColors
                              ? {
                                  backgroundColor: `${gradientColors.start}20`,
                                  borderColor: `${gradientColors.start}50`,
                                }
                              : undefined
                          }
                          >
                            <Wallet className={cn(
                              'w-10 h-10',
                              hasGradient 
                                ? isCustom && gradientColors
                                  ? 'text-slate-600'
                                  : 'text-slate-500'
                                : 'text-gray-500'
                            )} />
                          </div>
                          <h3 className={cn(
                            'text-lg font-bold mb-2',
                            hasGradient 
                              ? isCustom && gradientColors
                                ? 'text-slate-800'
                                : 'text-slate-700'
                              : 'text-gray-700'
                          )}>
                            Nenhum orçamento encontrado
                          </h3>
                          <p className={cn(
                            'text-sm',
                            hasGradient 
                              ? isCustom && gradientColors
                                ? 'text-slate-600'
                                : 'text-slate-500'
                              : 'text-gray-500'
                          )}>
                            Os orçamentos criados na Ficha Clínica Odontológica aparecerão aqui
                          </p>
                        </motion.div>
                    ) : (
                      <div className="grid grid-cols-1 lg:grid-cols-2 gap-5">
                          {orcamentos.map((orcamento, index) => {
                          const statusColors: Record<string, string> = {
                            rascunho: 'bg-gray-100 text-gray-700 border-gray-300',
                            aguardando_assinatura: 'bg-yellow-100 text-yellow-700 border-yellow-300',
                            finalizado: 'bg-slate-100 text-slate-700 border-slate-300',
                            aprovado: 'bg-blue-100 text-blue-700 border-blue-300',
                            recusado: 'bg-red-100 text-red-700 border-red-300',
                          };
                          
                          const statusLabels: Record<string, string> = {
                            rascunho: 'Rascunho',
                            aguardando_assinatura: 'Aguardando Assinatura',
                            finalizado: 'Finalizado',
                            aprovado: 'Aprovado',
                            recusado: 'Recusado',
                          };
                          
                          const isExpanded = expandedOrcamentos.has(orcamento.id);
                          const isSigned = !!orcamento.signedAt;
                          
                          return (
                            <motion.div
                              id={`orcamento-${orcamento.id}`}
                              key={orcamento.id}
                              initial={{ opacity: 0, y: 20, scale: 0.95 }}
                              animate={{ opacity: 1, y: 0, scale: 1 }}
                              transition={{ delay: index * 0.05, duration: 0.4, ease: [0.25, 0.46, 0.45, 0.94] }}
                              className={cn(
                                'group rounded-2xl overflow-hidden transition-all duration-300 cursor-pointer',
                                hasGradient
                                  ? 'bg-white/95 border-2 backdrop-blur-xl shadow-xl hover:shadow-2xl hover:scale-[1.02]'
                                  : 'bg-white border-2 border-gray-200 shadow-lg hover:shadow-xl hover:scale-[1.01]'
                              )}
                              style={
                                hasGradient
                                  ? isCustom && gradientColors
                                    ? {
                                        borderColor: `${gradientColors.start}40`,
                                      }
                                    : isVibrant
                                    ? {
                                        borderColor: 'rgba(139, 92, 246, 0.4)',
                                      }
                                    : {
                                        borderColor: 'rgba(59, 130, 246, 0.4)',
                                      }
                                  : undefined
                              }
                            >
                              {/* Header do card com gradiente impactante */}
                              <div
                                className={cn(
                                  'px-6 py-6 border-b relative overflow-hidden',
                                  hasGradient
                                    ? isCustom && gradientColors
                                      ? 'border-white/40'
                                      : isVibrant
                                      ? 'bg-gradient-to-br from-indigo-500/10 via-purple-500/10 to-pink-500/10 border-white/40'
                                      : 'bg-gradient-to-br from-blue-500/10 via-indigo-500/10 to-purple-500/10 border-white/40'
                                    : 'bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 border-gray-200'
                                )}
                                style={
                                  hasGradient && isCustom && gradientColors
                                    ? {
                                        background: `linear-gradient(135deg, ${gradientColors.start}15 0%, ${gradientColors.middle}15 50%, ${gradientColors.end}15 100%)`,
                                        borderColor: `${gradientColors.start}40`,
                                      }
                                    : undefined
                                }
                              >
                                {/* Decorative elements */}
                                <div 
                                  className={cn(
                                    'absolute top-0 right-0 w-40 h-40 rounded-full blur-3xl opacity-30 -mr-20 -mt-20 transition-opacity group-hover:opacity-40',
                                    hasGradient
                                      ? isCustom && gradientColors
                                        ? ''
                                        : isVibrant
                                        ? 'bg-gradient-to-br from-indigo-400 to-pink-400'
                                        : 'bg-gradient-to-br from-blue-400 to-indigo-400'
                                      : 'bg-gradient-to-br from-blue-400 to-indigo-400'
                                  )}
                                  style={
                                    hasGradient && isCustom && gradientColors
                                      ? {
                                          background: `radial-gradient(circle, ${gradientColors.start} 0%, transparent 70%)`,
                                        }
                                      : undefined
                                  }
                                />
                                <div 
                                  className={cn(
                                    'absolute bottom-0 left-0 w-24 h-24 rounded-full blur-2xl opacity-20 -ml-12 -mb-12',
                                    hasGradient
                                      ? isCustom && gradientColors
                                        ? ''
                                        : isVibrant
                                        ? 'bg-gradient-to-br from-purple-300 to-pink-300'
                                        : 'bg-gradient-to-br from-indigo-300 to-purple-300'
                                      : 'bg-gradient-to-br from-indigo-300 to-purple-300'
                                  )}
                                  style={
                                    hasGradient && isCustom && gradientColors
                                      ? {
                                          background: `radial-gradient(circle, ${gradientColors.middle} 0%, transparent 70%)`,
                                        }
                                      : undefined
                                  }
                                />
                                <div className="flex items-start justify-between gap-4 relative z-10">
                                  <div className="flex-1 min-w-0">
                                    <div className="flex items-center gap-2 mb-4 flex-wrap">
                                      <Badge className={cn(
                                        'text-xs font-bold px-3 py-1.5 shadow-lg border-2',
                                        statusColors[orcamento.status] || statusColors.rascunho
                                      )}>
                                        {statusLabels[orcamento.status] || 'Rascunho'}
                                      </Badge>
                                      {isSigned && (
                                        <Badge 
                                          className={cn(
                                            'text-white border-0 text-xs font-bold px-3 py-1.5 shadow-lg',
                                            hasGradient && isCustom && gradientColors
                                              ? ''
                                              : 'bg-gradient-to-r from-slate-500 to-blue-500'
                                          )}
                                          style={
                                            hasGradient && isCustom && gradientColors
                                              ? {
                                                  background: `linear-gradient(90deg, ${gradientColors.start} 0%, ${gradientColors.end} 100%)`,
                                                }
                                              : undefined
                                          }
                                        >
                                          <CheckCircle2 className="w-3.5 h-3.5 mr-1.5 inline" />
                                          Assinado
                                        </Badge>
                                      )}
                                    </div>
                                    <div className="mb-4">
                                      <p className={cn(
                                        'text-lg font-bold mb-1',
                                        hasGradient ? 'text-slate-900' : 'text-gray-900'
                                      )}>
                                        {orcamento.procedimentos.length} procedimento{orcamento.procedimentos.length !== 1 ? 's' : ''}
                                      </p>
                                      {orcamento.observacoes && (
                                        <p className={cn(
                                          'text-sm line-clamp-2',
                                          hasGradient ? 'text-slate-600' : 'text-gray-600'
                                        )}>
                                          {orcamento.observacoes}
                                        </p>
                                      )}
                                    </div>
                                    <div className={cn(
                                      'flex items-center gap-2 px-3 py-2 rounded-lg backdrop-blur-sm border shadow-sm',
                                      hasGradient
                                        ? isCustom && gradientColors
                                          ? 'bg-white/80 border-white/50'
                                          : 'bg-white/70 border-white/40'
                                        : 'bg-white/90 border-gray-200/60'
                                    )}>
                                      <Clock3 className={cn(
                                        'w-4 h-4',
                                        hasGradient 
                                          ? isCustom && gradientColors
                                            ? 'text-slate-600'
                                            : 'text-slate-500'
                                          : 'text-gray-600'
                                      )} />
                                      <span className={cn(
                                        'text-xs font-semibold',
                                        hasGradient 
                                          ? isCustom && gradientColors
                                            ? 'text-slate-700'
                                            : 'text-slate-600'
                                          : 'text-gray-700'
                                      )}>
                                        {format(orcamento.createdAt, "dd/MM/yyyy 'às' HH:mm", { locale: ptBR })}
                                      </span>
                                    </div>
                                  </div>
                                  <div className="flex flex-col items-end gap-2 relative z-10">
                                    <div className={cn(
                                      'text-right p-6 rounded-2xl shadow-2xl min-w-[150px]',
                                      hasGradient
                                        ? isCustom && gradientColors
                                          ? ''
                                          : isVibrant
                                          ? 'bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500'
                                          : 'bg-gradient-to-br from-blue-500 to-indigo-600'
                                        : 'bg-gradient-to-br from-blue-500 to-indigo-600'
                                    )}
                                    style={
                                      hasGradient && isCustom && gradientColors
                                        ? {
                                            background: `linear-gradient(135deg, ${gradientColors.start} 0%, ${gradientColors.middle} 50%, ${gradientColors.end} 100%)`,
                                          }
                                        : undefined
                                    }
                                    >
                                      <p className="text-xs font-bold text-white/90 mb-2 uppercase tracking-wider">
                                        Valor Total
                                      </p>
                                      <p className="text-3xl font-extrabold text-white mb-2">
                                        R$ {(orcamento.valorTotalCentavos / 100).toFixed(2).replace('.', ',')}
                                      </p>
                                      {orcamento.descontoCentavos > 0 && (
                                        <p className="text-xs text-white/90 font-semibold mt-2 pt-2 border-t border-white/30">
                                          Desconto: - R$ {(orcamento.descontoCentavos / 100).toFixed(2).replace('.', ',')}
                                        </p>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              </div>

                              {/* Conteúdo do card */}
                              <div className="p-6 space-y-4 bg-white/30">
                                {/* Botões de ação */}
                                <div className={cn(
                                  'flex items-center justify-end gap-2 pb-4 border-b',
                                  hasGradient 
                                    ? isCustom && gradientColors
                                      ? 'border-white/30'
                                      : 'border-white/25'
                                    : 'border-gray-200'
                                )}>
                                  {!isSigned && (
                                    <Button
                                      type="button"
                                      variant="ghost"
                                      size="sm"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        setSelectedOrcamentoId(orcamento.id);
                                      }}
                                      className={cn(
                                        'h-9 px-3 rounded-lg transition-all shadow-sm font-semibold text-xs',
                                        hasGradient
                                          ? 'text-slate-600 hover:text-slate-700 hover:bg-slate-50/90 border border-slate-200/60'
                                          : 'text-slate-600 hover:text-slate-700 hover:bg-slate-50 border border-slate-200'
                                      )}
                                      title="Editar orçamento"
                                    >
                                      <Edit className="w-3.5 h-3.5 mr-1" />
                                      Editar
                                    </Button>
                                  )}
                                  <Button
                                    type="button"
                                    variant="ghost"
                                    size="sm"
                                    onClick={async (e) => {
                                      e.stopPropagation();
                                      await handleSendOrcamento(orcamento);
                                    }}
                                    className={cn(
                                      'h-9 px-3 rounded-lg transition-all shadow-sm font-semibold text-xs',
                                      hasGradient
                                        ? 'text-blue-600 hover:text-blue-700 hover:bg-blue-50/90 border border-blue-200/60'
                                        : 'text-blue-600 hover:text-blue-700 hover:bg-blue-50 border border-blue-200'
                                    )}
                                    title="Enviar link de assinatura"
                                  >
                                    <Send className="w-3.5 h-3.5 mr-1" />
                                    Enviar
                                  </Button>
                                  <Button
                                    type="button"
                                    variant="ghost"
                                    size="sm"
                                    onClick={async (e) => {
                                      e.stopPropagation();
                                      await handlePrintOrcamento(orcamento);
                                    }}
                                    className={cn(
                                      'h-9 px-3 rounded-lg transition-all shadow-sm font-semibold text-xs',
                                      hasGradient
                                        ? 'text-slate-600 hover:text-slate-900 hover:bg-slate-50/90 border border-slate-200/60'
                                        : 'text-gray-600 hover:text-gray-900 hover:bg-gray-100 border border-gray-200'
                                    )}
                                    title="Imprimir/Download PDF"
                                  >
                                    <Printer className="w-3.5 h-3.5 mr-1" />
                                    PDF
                                  </Button>
                                  {!isSigned && (
                                    <Button
                                      type="button"
                                      variant="ghost"
                                      size="sm"
                                      onClick={async (e) => {
                                        e.stopPropagation();
                                        if (confirm('Tem certeza que deseja excluir este orçamento?')) {
                                          try {
                                            await deleteOrcamento(orcamento.id);
                                            showSuccess('Orçamento excluído com sucesso!');
                                          } catch (error) {
                                            showError('Erro ao excluir orçamento. Por favor, tente novamente.');
                                          }
                                        }
                                      }}
                                      className={cn(
                                        'h-9 px-3 rounded-lg transition-all shadow-sm font-semibold text-xs',
                                        hasGradient
                                          ? 'text-red-500 hover:text-red-600 hover:bg-red-50/90 border border-red-200/60'
                                          : 'text-red-500 hover:text-red-600 hover:bg-red-50 border border-red-200'
                                      )}
                                      title="Excluir orçamento"
                                    >
                                      <Trash2 className="w-3.5 h-3.5 mr-1" />
                                      Excluir
                                    </Button>
                                  )}
                                </div>
                                
                                {/* Botão para expandir/colapsar procedimentos */}
                                <button
                                  type="button"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setExpandedOrcamentos(prev => {
                                      const newSet = new Set(prev);
                                      if (newSet.has(orcamento.id)) {
                                        newSet.delete(orcamento.id);
                                      } else {
                                        newSet.add(orcamento.id);
                                      }
                                      return newSet;
                                    });
                                  }}
                                  className={cn(
                                    'w-full flex items-center justify-between text-sm font-bold transition-all rounded-lg px-4 py-2.5 shadow-sm',
                                    hasGradient
                                      ? isExpanded
                                        ? isCustom && gradientColors
                                          ? 'text-white border border-white/50'
                                          : 'text-indigo-700 bg-indigo-50/70 border border-indigo-200/60'
                                        : 'text-slate-700 hover:text-slate-900 hover:bg-white/70 border border-white/40'
                                      : isExpanded
                                        ? 'text-blue-700 bg-blue-50 border border-blue-200'
                                        : 'text-gray-700 hover:text-gray-900 hover:bg-gray-50 border border-gray-200'
                                  )}
                                  style={
                                    hasGradient && isExpanded && isCustom && gradientColors
                                      ? {
                                          background: `linear-gradient(135deg, ${gradientColors.start} 0%, ${gradientColors.middle} 50%, ${gradientColors.end} 100%)`,
                                        }
                                      : undefined
                                  }
                                >
                                  <div className="flex items-center gap-2.5">
                                    <div className={cn(
                                      'flex items-center justify-center w-8 h-8 rounded-lg shadow-sm border',
                                      hasGradient
                                        ? isExpanded
                                          ? isCustom && gradientColors
                                            ? 'bg-white/30 border-white/40'
                                            : 'bg-indigo-500/20 border-indigo-200/50'
                                          : 'bg-slate-100/50 border-white/30'
                                        : isExpanded
                                          ? 'bg-blue-100 border-blue-200/50'
                                          : 'bg-gray-100 border-gray-200/50'
                                    )}
                                    style={
                                      hasGradient && isExpanded && isCustom && gradientColors
                                        ? {
                                            backgroundColor: `${gradientColors.start}30`,
                                            borderColor: `${gradientColors.start}40`,
                                          }
                                        : undefined
                                    }
                                    >
                                      <FileText className={cn(
                                        'w-4 h-4',
                                        hasGradient
                                          ? isExpanded
                                            ? isCustom && gradientColors
                                              ? 'text-white'
                                              : 'text-indigo-600'
                                            : 'text-slate-500'
                                          : isExpanded
                                            ? 'text-blue-600'
                                            : 'text-gray-500'
                                      )} />
                                    </div>
                                    <span>
                                      Ver {orcamento.procedimentos.length} procedimento{orcamento.procedimentos.length !== 1 ? 's' : ''}
                                    </span>
                                  </div>
                                  <motion.div
                                    animate={{ rotate: isExpanded ? 180 : 0 }}
                                    transition={{ duration: 0.2 }}
                                  >
                                    <ChevronDown className={cn(
                                      'w-5 h-5 transition-transform',
                                      hasGradient
                                        ? isExpanded
                                          ? isCustom && gradientColors
                                            ? 'text-white'
                                            : 'text-indigo-600'
                                          : 'text-slate-500'
                                        : isExpanded
                                          ? 'text-blue-600'
                                          : 'text-gray-500'
                                    )} />
                                  </motion.div>
                                </button>
                                </div>
                                
                                {/* Lista de procedimentos (colapsável) */}
                                <AnimatePresence>
                                  {isExpanded && orcamento.procedimentos.length > 0 && (
                                    <motion.div
                                      initial={{ height: 0, opacity: 0 }}
                                      animate={{ height: 'auto', opacity: 1 }}
                                      exit={{ height: 0, opacity: 0 }}
                                      transition={{ duration: 0.3 }}
                                      className={cn(
                                        'overflow-hidden border-t pt-4',
                                        hasGradient ? 'border-white/20' : 'border-gray-100'
                                      )}
                                    >
                                      <div className={cn(
                                        'space-y-3 py-4',
                                        hasGradient
                                          ? isCustom && gradientColors
                                            ? ''
                                            : isVibrant
                                            ? 'bg-gradient-to-br from-indigo-50/30 via-purple-50/30 to-pink-50/30'
                                            : 'bg-gradient-to-br from-slate-50/50 to-gray-50/50'
                                          : 'bg-gray-50/50'
                                      )}
                                      style={
                                        hasGradient && isCustom && gradientColors
                                          ? {
                                              background: `linear-gradient(135deg, ${gradientColors.start}08 0%, ${gradientColors.middle}08 50%, ${gradientColors.end}08 100%)`,
                                            }
                                          : undefined
                                      }
                                      >
                                        <h4 className={cn(
                                          'text-sm font-bold mb-3 flex items-center gap-2 px-6',
                                          hasGradient ? 'text-slate-900' : 'text-gray-900'
                                        )}>
                                          <FileText className={cn(
                                            'w-4 h-4',
                                            hasGradient ? 'text-slate-600' : 'text-gray-600'
                                          )} />
                                          Procedimentos do Orçamento
                                        </h4>
                                        {orcamento.procedimentos.map((proc: any, idx: number) => (
                                          <motion.div
                                            key={idx}
                                            initial={{ opacity: 0, y: -5 }}
                                            animate={{ opacity: 1, y: 0, scale: 1 }}
                                            transition={{ delay: idx * 0.05 }}
                                            className={cn(
                                              'flex items-start justify-between p-5 mx-6 rounded-xl border-2 shadow-md hover:shadow-lg transition-all',
                                              hasGradient
                                                ? 'bg-white/90 border-white/60 hover:bg-white hover:border-white/80'
                                                : 'bg-white border-gray-200 hover:border-blue-300'
                                            )}
                                          >
                                            <div className="flex-1 min-w-0">
                                              <p className={cn(
                                                'font-bold text-base mb-2',
                                                hasGradient ? 'text-slate-900' : 'text-gray-900'
                                              )}>
                                                {proc.procedimento}
                                              </p>
                                              <div className="space-y-1.5">
                                                {proc.dentes && proc.dentes.length > 0 && (
                                                  <div className="flex items-center gap-2">
                                                    <Stethoscope className={cn(
                                                      'w-4 h-4 flex-shrink-0',
                                                      hasGradient ? 'text-slate-500' : 'text-gray-500'
                                                    )} />
                                                    <p className={cn(
                                                      'text-sm font-medium',
                                                      hasGradient ? 'text-slate-600' : 'text-gray-600'
                                                    )}>
                                                      Dentes: {proc.dentes.map((d: any) => d.numero).join(', ')}
                                                    </p>
                                                  </div>
                                                )}
                                                {proc.selectionTypes && proc.selectionTypes.length > 0 && (
                                                  <p className={cn(
                                                    'text-sm font-medium',
                                                    hasGradient ? 'text-slate-600' : 'text-gray-600'
                                                  )}>
                                                    {proc.selectionTypes.includes('ALL') ? 'Todos os dentes' : 
                                                     proc.selectionTypes.includes('UPPER') && proc.selectionTypes.includes('LOWER') ? 'Superiores + Inferiores' :
                                                     proc.selectionTypes.includes('UPPER') ? 'Superiores' :
                                                     proc.selectionTypes.includes('LOWER') ? 'Inferiores' : ''}
                                                  </p>
                                                )}
                                              </div>
                                            </div>
                                            <div className={cn(
                                              'ml-4 px-5 py-3 rounded-xl shadow-lg min-w-[120px] text-center',
                                              hasGradient
                                                ? isCustom && gradientColors
                                                  ? ''
                                                  : isVibrant
                                                  ? 'bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500'
                                                  : 'bg-gradient-to-br from-blue-500 to-indigo-600'
                                                : 'bg-gradient-to-br from-blue-500 to-indigo-600'
                                            )}
                                            style={
                                              hasGradient && isCustom && gradientColors
                                                ? {
                                                    background: `linear-gradient(135deg, ${gradientColors.start} 0%, ${gradientColors.middle} 50%, ${gradientColors.end} 100%)`,
                                                  }
                                                : undefined
                                            }
                                            >
                                              <p className="text-xl font-bold text-white">
                                                R$ {((proc.valorCentavosEditado !== undefined ? proc.valorCentavosEditado : proc.valorCentavos) / 100).toFixed(2).replace('.', ',')}
                                              </p>
                                            </div>
                                          </motion.div>
                                        ))}
                                      </div>
                                    </motion.div>
                                  )}
                                </AnimatePresence>
                                
                                {/* Informações de pagamento */}
                                {orcamento.formaPagamento && (
                                  <div className={cn(
                                    'border-t pt-4',
                                    hasGradient ? 'border-white/20' : 'border-gray-100'
                                  )}>
                                    <div className={cn(
                                      'flex items-center gap-3 p-4 rounded-xl border backdrop-blur-sm',
                                      hasGradient
                                        ? isCustom && gradientColors
                                          ? 'bg-white/70 border-white/40'
                                          : 'bg-white/60 border-white/40'
                                        : 'bg-white border-gray-200'
                                    )}>
                                      <div className={cn(
                                        'flex items-center justify-center w-10 h-10 rounded-xl shadow-md',
                                        hasGradient && isCustom && gradientColors
                                          ? ''
                                          : 'bg-gradient-to-br from-slate-500 to-blue-500'
                                      )}
                                      style={
                                        hasGradient && isCustom && gradientColors
                                          ? {
                                              background: `linear-gradient(135deg, ${gradientColors.start} 0%, ${gradientColors.end} 100%)`,
                                            }
                                          : undefined
                                      }
                                      >
                                        <Wallet className="w-5 h-5 text-white" />
                                      </div>
                                      <div className="flex-1">
                                        <p className={cn(
                                          'text-xs font-bold uppercase tracking-wide mb-1',
                                          hasGradient ? 'text-slate-600' : 'text-gray-600'
                                        )}>
                                          Forma de pagamento
                                        </p>
                                        <p className={cn(
                                          'text-sm font-semibold',
                                          hasGradient ? 'text-slate-900' : 'text-gray-900'
                                        )}>
                                          {orcamento.formaPagamento === 'avista' ? 'À vista' :
                                           orcamento.formaPagamento === 'parcelado' ? `Parcelado${orcamento.parcelado ? ` (${orcamento.parcelado.numeroParcelas}x)` : ''}` :
                                           orcamento.formaPagamento === 'multiplas' ? `Múltiplas formas${orcamento.pagamentos ? ` (${orcamento.pagamentos.length} parcela${orcamento.pagamentos.length !== 1 ? 's' : ''})` : ''}` : ''}
                                        </p>
                                      </div>
                                    </div>
                                  </div>
                                )}
                        
                             
                            </motion.div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                </div>
              ) : (
                <motion.div
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0, scale: 1 }}
                  transition={{ duration: 0.3 }}
                >
                  <Card className={cn(
                    'shadow-lg border-0 transition-all',
                    hasGradient
                      ? 'bg-white/80 border border-white/25 backdrop-blur-xl'
                      : 'bg-white'
                  )}>
                    <CardContent className="p-6 text-center">
                      <div className={cn(
                        'inline-flex h-16 w-16 items-center justify-center rounded-full mb-4 border shadow-sm',
                        hasGradient
                          ? isCustom && gradientColors
                            ? 'bg-white/70 border-white/40'
                            : isVibrant
                            ? 'bg-gradient-to-br from-indigo-100/50 via-purple-100/50 to-pink-100/50 border-white/30'
                            : 'bg-slate-100/50 border-white/30'
                          : 'bg-gray-100 border-gray-200/50'
                      )}
                      style={
                        hasGradient && isCustom && gradientColors
                          ? {
                              backgroundColor: `${gradientColors.start}15`,
                              borderColor: `${gradientColors.start}30`,
                            }
                          : undefined
                      }
                      >
                        <Wallet className={cn(
                          'w-8 h-8',
                          hasGradient 
                            ? isCustom && gradientColors
                              ? 'text-slate-500'
                              : 'text-slate-400'
                            : 'text-gray-400'
                        )} />
                      </div>
                      <p className={cn(
                        'text-sm font-medium',
                        hasGradient 
                          ? isCustom && gradientColors
                            ? 'text-slate-700'
                            : 'text-slate-600'
                          : 'text-gray-600'
                      )}>
                        Você não tem permissão para acessar a aba de Débitos.
                      </p>
                  </CardContent>
                </Card>
                </motion.div>
              )}
              
              {/* Modal de Orçamento */}
              {selectedOrcamentoId && (
                <OrcamentoModal
                  isOpen={!!selectedOrcamentoId}
                  onClose={() => setSelectedOrcamentoId(null)}
                  companyId={companyId || ''}
                  patientId={patientId}
                  procedimentos={dentalProcedures || []}
                  orcamento={selectedOrcamentoId === 'new' ? null : orcamentos.find(o => o.id === selectedOrcamentoId) || null}
                  onSave={() => {
                    setSelectedOrcamentoId(null);
                    // Os dados serão atualizados automaticamente pelo useOrcamentos
                  }}
                />
              )}

              {/* Modal de Envio de Link de Assinatura */}
              {sendOrcamentoModal && (
                <div className="fixed inset-0 z-[1003] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                  <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 space-y-4">
                    <div className="flex items-center justify-between">
                      <h2 className="text-xl font-bold text-gray-900">Enviar Link de Assinatura</h2>
                      <button
                        type="button"
                        onClick={() => setSendOrcamentoModal(null)}
                        className="p-2 rounded-lg hover:bg-gray-100 transition-colors"
                      >
                        <X className="w-5 h-5 text-gray-600" />
                      </button>
                    </div>
                    
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Link de Assinatura
                        </label>
                        <div className="flex gap-2">
                          <Input
                            type="text"
                            value={sendOrcamentoModal.link}
                            readOnly
                            className="flex-1 font-mono text-sm"
                          />
                          <Button
                            type="button"
                            onClick={handleCopyLink}
                            variant="outline"
                            className="flex-shrink-0"
                          >
                            {copiedLink ? (
                              <>
                                <Check className="w-4 h-4 mr-2" />
                                Copiado!
                              </>
                            ) : (
                              <>
                                <Copy className="w-4 h-4 mr-2" />
                                Copiar
                              </>
                            )}
                          </Button>
                        </div>
                      </div>

                      <div className="flex gap-3">
                        <Button
                          type="button"
                          onClick={handleSendViaSystem}
                          className={cn(
                            'flex-1 text-white',
                            hasGradient
                              ? isCustom && gradientColors
                                ? ''
                                : isVibrant
                                ? 'bg-gradient-to-r from-indigo-500 to-rose-500 hover:from-indigo-600 hover:to-rose-600'
                                : 'bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700'
                              : 'bg-gradient-to-r from-slate-600 to-blue-600 hover:from-slate-700 hover:to-blue-700'
                          )}
                          style={
                            hasGradient && isCustom && gradientColors
                              ? {
                                  background: `linear-gradient(90deg, ${gradientColors.start} 0%, ${gradientColors.middle} 50%, ${gradientColors.end} 100%)`,
                                }
                              : undefined
                          }
                          disabled={!patient?.telefoneE164}
                        >
                          <Send className="w-4 h-4 mr-2" />
                          Enviar pelo Sistema
                        </Button>
                        <Button
                          type="button"
                          onClick={() => setSendOrcamentoModal(null)}
                          variant="outline"
                          className="flex-1"
                        >
                          Fechar
                        </Button>
                      </div>

                      {!patient?.telefoneE164 && (
                        <p className="text-xs text-gray-500 text-center">
                          {singularTitle} sem telefone cadastrado. Use a opção de copiar o link.
                        </p>
                      )}
                    </div>
                  </div>
                </div>
              )}
            </>
          )}

          {activeTab === 'documentos' && (
            <DocumentosTab
              companyId={companyId || ''}
              patientId={patientId}
              company={company}
              patient={patient}
              professionals={professionals}
            />
          )}

          {activeTab === 'arquivos' && (
            <ArquivosTab
              companyId={companyId}
              patientId={patientId}
              patient={patient}
              hasGradient={hasGradient}
              isCustom={isCustom}
              gradientColors={gradientColors}
              isVibrant={isVibrant}
              gradientStyleHorizontal={gradientStyleHorizontal}
              singularLabel={singularLabel}
              singularTitle={singularTitle}
              pluralTitle={pluralTitle}
              patientFiles={patientFiles}
              filesLoading={filesLoading}
              uploadingFile={uploadingFile}
              uploadProgress={uploadProgress}
              onLoadFiles={loadPatientFiles}
              onFileUpload={handleFileUpload}
              onDeleteFile={handleDeleteFile}
            />
          )}

          {activeTab === 'interacoes' && (
            <InteracoesTab
              companyId={companyId}
              patientId={patientId}
              patient={patient}
              hasGradient={hasGradient}
              isCustom={isCustom}
              gradientColors={gradientColors}
              isVibrant={isVibrant}
              gradientStyleHorizontal={gradientStyleHorizontal}
              singularLabel={singularLabel}
              singularTitle={singularTitle}
              pluralTitle={pluralTitle}
              patientPhone={patientPhone}
              interactionMessages={interactionMessages}
              interactionLoading={interactionLoading}
              loadingMore={loadingMore}
              hasMore={hasMore}
              newInteractionMessage={newInteractionMessage}
              sendingInteraction={sendingInteraction}
              onMessageChange={setNewInteractionMessage}
              onSendMessage={handleSendInteractionMessage}
              onLoadMore={loadMore}
              formatMessageDate={formatMessageDate}
              getMessageText={getMessageText}
              getMediaInfo={getMediaInfo}
              renderMedia={renderMedia}
              interactionContainerRef={interactionContainerRef}
              messagesEndRef={messagesEndRef}
            />
          )}

          {activeTab === 'financeiro' && canAccessPatientDebits(userWithPermissions as any) && (
            <FinanceiroTab
              companyId={companyId}
              patientId={patientId}
              hasGradient={hasGradient}
              isCustom={isCustom}
              gradientColors={gradientColors}
              isVibrant={isVibrant}
              gradientStyleHorizontal={gradientStyleHorizontal}
            />
          )}

          {activeTab === 'consultas' && (
            <ConsultasTab
              companyId={companyId}
              patientId={patientId}
              patient={patient}
              hasGradient={hasGradient}
              isCustom={isCustom}
              gradientColors={gradientColors}
              isVibrant={isVibrant}
              gradientStyleHorizontal={gradientStyleHorizontal}
              singularLabel={singularLabel}
              singularTitle={singularTitle}
              pluralTitle={pluralTitle}
              upcomingAppointments={upcomingAppointments}
              pastAppointments={pastAppointments}
              appointmentsLoading={appointmentsLoading}
              professionalsLoading={professionalsLoading}
              servicesLoading={servicesLoading}
              services={services || []}
              getProfessionalLabel={getProfessionalLabel}
              getServiceLabel={getServiceLabel}
              formatDateTime={formatDateTime}
            />
          )}
        </div>
      </div>

    </AccessGuard>
                    <div
                      className={cn(
                        'flex h-10 w-10 items-center justify-center rounded-lg text-white shadow-md',
                        isVibrant
                          ? 'bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500'
                          : isCustom && gradientColors
                          ? ''
                          : 'bg-slate-600'
                      )}
                      style={
                        isCustom && gradientColors
                          ? {
                              background: `linear-gradient(135deg, ${gradientColors.start} 0%, ${gradientColors.middle} 50%, ${gradientColors.end} 100%)`,
                            }
                          : undefined
                      }
                    >
                      <CalendarClock className="w-5 h-5" />
                    </div>
                    <div>
                      <CardTitle className={cn(
                        'text-xl font-semibold',
                        hasGradient ? 'text-slate-900' : 'text-gray-900'
                      )}>
                        Próximos agendamentos
                      </CardTitle>
                      <p className={cn(
                        'text-xs mt-1',
                        hasGradient ? 'text-slate-600/80' : 'text-gray-500'
                      )}>
                        {upcomingAppointments.length} {upcomingAppointments.length === 1 ? 'agendamento' : 'agendamentos'}
                      </p>
                    </div>
                  </div>
                </CardHeader>
                <CardContent className="pt-6 space-y-4">
                  {(appointmentsLoading || professionalsLoading || servicesLoading) && (
                    <div className="flex items-center justify-center py-12">
                      <div className={cn(
                        'animate-spin rounded-full h-8 w-8 border-b-2',
                        hasGradient
                          ? isCustom && gradientColors
                            ? 'border-indigo-500'
                            : 'border-indigo-500'
                          : 'border-blue-500'
                      )} />
                    </div>
                  )}
                  {!appointmentsLoading && !professionalsLoading && !servicesLoading && upcomingAppointments.length === 0 && (
                    <motion.div
                      initial={{ opacity: 0, scale: 0.95 }}
                      animate={{ opacity: 1, scale: 1 }}
                      className="py-12 text-center"
                    >
                      <div className={cn(
                        'inline-flex h-16 w-16 items-center justify-center rounded-full mb-4',
                        hasGradient
                          ? 'bg-slate-100/50'
                          : 'bg-gray-100'
                      )}>
                        <CalendarClock className={cn(
                          'w-8 h-8',
                          hasGradient ? 'text-slate-400' : 'text-gray-400'
                        )} />
                      </div>
                      <p className={cn(
                        'text-sm font-medium',
                        hasGradient ? 'text-slate-600' : 'text-gray-600'
                      )}>
                        Nenhum agendamento futuro
                      </p>
                      <p className={cn(
                        'text-xs mt-1',
                        hasGradient ? 'text-slate-500/80' : 'text-gray-500'
                      )}>
                        Os próximos agendamentos aparecerão aqui
                      </p>
                    </motion.div>
                  )}
                  {upcomingAppointments.map((appointment, index) => (
                    <motion.div
                      key={appointment.id}
                      initial={{ opacity: 0, x: -10 }}
                      animate={{ opacity: 1, x: 0 }}
                      transition={{ delay: index * 0.08, duration: 0.4, ease: [0.25, 0.46, 0.45, 0.94] }}
                    >
                      <Card className={cn(
                        'border transition-all hover:shadow-md',
                        hasGradient
                          ? 'bg-white/60 border-white/40 hover:bg-white/80'
                          : 'bg-gradient-to-br from-slate-50 to-blue-50 border-slate-200 hover:border-slate-300'
                      )}>
                        <CardContent className="p-4 space-y-3">
                          <div className="flex items-start justify-between gap-3">
                            <div className="flex-1">
                              <p className={cn(
                                'text-sm font-bold mb-1',
                                hasGradient
                                  ? 'text-slate-900'
                                  : 'text-green-700'
                              )}>
                                {formatDateTime(appointment.inicio)}
                              </p>
                              <div className="space-y-1.5">
                                <div className="flex items-center gap-2">
                                  <Stethoscope className={cn(
                                    'w-3.5 h-3.5 flex-shrink-0',
                                    hasGradient ? 'text-slate-500' : 'text-gray-500'
                                  )} />
                                  <p className={cn(
                                    'text-sm',
                                    hasGradient ? 'text-slate-700' : 'text-gray-700'
                                  )}>
                          <span className="font-medium">{getProfessionalLabel(appointment.professionalId)}</span>
                        </p>
                                </div>
                                <div className="flex items-center gap-2">
                                  <FileText className={cn(
                                    'w-3.5 h-3.5 flex-shrink-0',
                                    hasGradient ? 'text-slate-500' : 'text-gray-500'
                                  )} />
                                  <p className={cn(
                                    'text-sm',
                                    hasGradient ? 'text-slate-700' : 'text-gray-700'
                                  )}>
                                    {(() => {
                                      // Função auxiliar para buscar nome do serviço diretamente
                                      const getServiceNameDirectly = (serviceId: string): string | null => {
                                        if (!serviceId || !services || !Array.isArray(services)) return null;
                                        const service = services.find(s => s && s.id === serviceId);
                                        return service?.nome || null;
                                      };

                                      // Priorizar serviceIds (array) se existir
                                      if (appointment.serviceIds && Array.isArray(appointment.serviceIds) && appointment.serviceIds.length > 0) {
                                        const labels = appointment.serviceIds
                                          .map(id => {
                                            // Tentar primeiro pela função getServiceLabel
                                            let label = getServiceLabel(id);
                                            // Se retornou o próprio ID, tentar buscar diretamente
                                            if (label === id) {
                                              const directName = getServiceNameDirectly(id);
                                              if (directName) {
                                                return directName;
                                              }
                                            }
                                            return label;
                                          })
                                          .filter(label => label && label !== 'Não informado' && label !== 'Carregando...');
                                        
                                        if (labels.length > 0) {
                                          return labels.join(', ');
                                        }
                                        // Se não encontrou nenhum, mostrar mensagem
                                        return 'Nenhum serviço informado';
                                      } 
                                      // Fallback para serviceId único
                                      else if (appointment.serviceId) {
                                        let label = getServiceLabel(appointment.serviceId);
                                        // Se retornou o próprio ID, tentar buscar diretamente
                                        if (label === appointment.serviceId) {
                                          const directName = getServiceNameDirectly(appointment.serviceId);
                                          if (directName) {
                                            return directName;
                                          }
                                        }
                                        return label !== 'Não informado' && label !== 'Carregando...' ? label : 'Nenhum serviço informado';
                                      }
                                      return 'Nenhum serviço informado';
                                    })()}
                                  </p>
                                </div>
                              </div>
                            </div>
                            <Badge className={cn(
                              'flex-shrink-0',
                              hasGradient
                                ? 'bg-indigo-100 text-indigo-700 border-indigo-300'
                                : 'bg-green-100 text-green-700 border-green-300'
                            )}>
                              Agendada
                            </Badge>
                          </div>
                          <Link 
                            href="/agenda" 
                            className={cn(
                              'inline-flex items-center gap-1.5 text-xs font-medium transition-colors',
                              hasGradient
                                ? 'text-indigo-600 hover:text-indigo-700'
                                : 'text-blue-600 hover:text-blue-700'
                            )}
                            prefetch={false}
                          >
                            <Eye className="w-3.5 h-3.5" />
                          Ver na agenda
                        </Link>
                      </CardContent>
                    </Card>
                    </motion.div>
                  ))}
                </CardContent>
              </Card>

              {/* Histórico de Agendamentos */}
              <Card className={cn(
                'shadow-lg border-0 transition-all',
                hasGradient
                  ? 'bg-white/80 border border-white/25 backdrop-blur-xl'
                  : 'bg-white'
              )}>
                <CardHeader className={cn(
                  'border-b',
                  hasGradient ? 'border-white/20' : 'border-slate-200'
                )}>
                  <div className="flex items-center gap-3">
                    <div
                      className={cn(
                        'flex h-10 w-10 items-center justify-center rounded-lg text-white shadow-md',
                        isVibrant
                          ? 'bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500'
                          : isCustom && gradientColors
                          ? ''
                          : 'bg-slate-600'
                      )}
                      style={
                        isCustom && gradientColors
                          ? {
                              background: `linear-gradient(135deg, ${gradientColors.start} 0%, ${gradientColors.middle} 50%, ${gradientColors.end} 100%)`,
                            }
                          : undefined
                      }
                    >
                      <History className="w-5 h-5" />
                    </div>
                    <div>
                      <CardTitle className={cn(
                        'text-xl font-semibold',
                        hasGradient ? 'text-slate-900' : 'text-gray-900'
                      )}>
                        Histórico de agendamentos
                      </CardTitle>
                      <p className={cn(
                        'text-xs mt-1',
                        hasGradient ? 'text-slate-600/80' : 'text-gray-500'
                      )}>
                        {pastAppointments.length} {pastAppointments.length === 1 ? 'agendamento realizado' : 'agendamentos realizados'}
                      </p>
                    </div>
                  </div>
                </CardHeader>
                <CardContent className="pt-6 space-y-4">
                  {(appointmentsLoading || professionalsLoading || servicesLoading) && (
                    <div className="flex items-center justify-center py-12">
                      <div className={cn(
                        'animate-spin rounded-full h-8 w-8 border-b-2',
                        hasGradient
                          ? isCustom && gradientColors
                            ? 'border-indigo-500'
                            : 'border-indigo-500'
                          : 'border-blue-500'
                      )} />
                    </div>
                  )}
                  {!appointmentsLoading && !professionalsLoading && !servicesLoading && pastAppointments.length === 0 && (
                    <motion.div
                      initial={{ opacity: 0, scale: 0.95 }}
                      animate={{ opacity: 1, scale: 1 }}
                      className="py-12 text-center"
                    >
                      <div className={cn(
                        'inline-flex h-16 w-16 items-center justify-center rounded-full mb-4',
                        hasGradient
                          ? 'bg-slate-100/50'
                          : 'bg-gray-100'
                      )}>
                        <History className={cn(
                          'w-8 h-8',
                          hasGradient ? 'text-slate-400' : 'text-gray-400'
                        )} />
                      </div>
                      <p className={cn(
                        'text-sm font-medium',
                        hasGradient ? 'text-slate-600' : 'text-gray-600'
                      )}>
                        Nenhum atendimento registrado
                      </p>
                      <p className={cn(
                        'text-xs mt-1',
                        hasGradient ? 'text-slate-500/80' : 'text-gray-500'
                      )}>
                        O histórico de agendamentos aparecerá aqui
                      </p>
                    </motion.div>
                  )}
                  {pastAppointments.map((appointment, index) => (
                    <motion.div
                      key={appointment.id}
                      initial={{ opacity: 0, x: -10 }}
                      animate={{ opacity: 1, x: 0 }}
                      transition={{ delay: index * 0.08, duration: 0.4, ease: [0.25, 0.46, 0.45, 0.94] }}
                    >
                      <Card className={cn(
                        'border transition-all hover:shadow-md',
                        hasGradient
                          ? 'bg-white/60 border-white/40 hover:bg-white/80'
                          : 'bg-slate-50 border-slate-200 hover:border-slate-300'
                      )}>
                        <CardContent className="p-4 space-y-3">
                          <div className="flex items-start justify-between gap-3">
                            <div className="flex-1">
                              <p className={cn(
                                'text-sm font-bold mb-1',
                                hasGradient ? 'text-slate-900' : 'text-gray-800'
                              )}>
                                {formatDateTime(appointment.inicio)}
                              </p>
                              <div className="space-y-1.5">
                                <div className="flex items-center gap-2">
                                  <Stethoscope className={cn(
                                    'w-3.5 h-3.5 flex-shrink-0',
                                    hasGradient ? 'text-slate-500' : 'text-gray-500'
                                  )} />
                                  <p className={cn(
                                    'text-sm',
                                    hasGradient ? 'text-slate-700' : 'text-gray-700'
                                  )}>
                          <span className="font-medium">{getProfessionalLabel(appointment.professionalId)}</span>
                        </p>
                                </div>
                                <div className="flex items-center gap-2">
                                  <FileText className={cn(
                                    'w-3.5 h-3.5 flex-shrink-0',
                                    hasGradient ? 'text-slate-500' : 'text-gray-500'
                                  )} />
                                  <p className={cn(
                                    'text-sm',
                                    hasGradient ? 'text-slate-700' : 'text-gray-700'
                                  )}>
                                    {(() => {
                                      // Função auxiliar para buscar nome do serviço diretamente
                                      const getServiceNameDirectly = (serviceId: string): string | null => {
                                        if (!serviceId || !services || !Array.isArray(services)) return null;
                                        const service = services.find(s => s && s.id === serviceId);
                                        return service?.nome || null;
                                      };

                                      // Priorizar serviceIds (array) se existir
                                      if (appointment.serviceIds && Array.isArray(appointment.serviceIds) && appointment.serviceIds.length > 0) {
                                        const labels = appointment.serviceIds
                                          .map(id => {
                                            // Tentar primeiro pela função getServiceLabel
                                            let label = getServiceLabel(id);
                                            // Se retornou o próprio ID, tentar buscar diretamente
                                            if (label === id) {
                                              const directName = getServiceNameDirectly(id);
                                              if (directName) {
                                                return directName;
                                              }
                                            }
                                            return label;
                                          })
                                          .filter(label => label && label !== 'Não informado' && label !== 'Carregando...');
                                        
                                        if (labels.length > 0) {
                                          return labels.join(', ');
                                        }
                                        // Se não encontrou nenhum, mostrar mensagem
                                        return 'Nenhum serviço informado';
                                      } 
                                      // Fallback para serviceId único
                                      else if (appointment.serviceId) {
                                        let label = getServiceLabel(appointment.serviceId);
                                        // Se retornou o próprio ID, tentar buscar diretamente
                                        if (label === appointment.serviceId) {
                                          const directName = getServiceNameDirectly(appointment.serviceId);
                                          if (directName) {
                                            return directName;
                                          }
                                        }
                                        return label !== 'Não informado' && label !== 'Carregando...' ? label : 'Nenhum serviço informado';
                                      }
                                      return 'Nenhum serviço informado';
                                    })()}
                                  </p>
                                </div>
                              </div>
                            </div>
                            <Badge className={cn(
                              'flex-shrink-0',
                              hasGradient
                                ? 'bg-slate-100 text-slate-700 border-slate-300'
                                : 'bg-gray-100 text-gray-700 border-gray-300'
                            )}>
                              Realizada
                            </Badge>
                          </div>
                      </CardContent>
                    </Card>
                    </motion.div>
                  ))}
                </CardContent>
        </div>
      </div>

    </AccessGuard>
  );
}

export default function PatientDetailPage() {
  return (
    <Suspense
      fallback={
        <div className="min-h-screen flex items-center justify-center">
          <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-primary" />
        </div>
      }
    >
      <PatientDetailContent />
    </Suspense>
  );
}
